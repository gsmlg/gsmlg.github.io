<!DOCTYPE html><html lang="en"><head><meta name="theme-color" content="#1976d2"/><meta charSet="utf-8"/><meta name="viewport" content="minimum-scale=1, initial-scale=1, width=device-width"/><meta name="theme-color" content="#1976d2"/><title>使用gin来创建简单的http服务器</title><link rel="icon" href="/favicon.ico"/><meta name="next-head-count" content="5"/><link rel="preload" href="/_next/static/css/b38854d43c26436a.css" as="style"/><link rel="stylesheet" href="/_next/static/css/b38854d43c26436a.css" data-n-g=""/><link rel="preload" href="/_next/static/css/c2a527101433f11d.css" as="style"/><link rel="stylesheet" href="/_next/static/css/c2a527101433f11d.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-1fec710eb11e1257.js" defer=""></script><script src="/_next/static/chunks/framework-91d7f78b5b4003c8.js" defer=""></script><script src="/_next/static/chunks/main-d98b4a7f39fdfc80.js" defer=""></script><script src="/_next/static/chunks/pages/_app-03d87d3a1a60dd5b.js" defer=""></script><script src="/_next/static/chunks/eb1842f2-a90cf2c0740b21ce.js" defer=""></script><script src="/_next/static/chunks/947-db85610286bf6269.js" defer=""></script><script src="/_next/static/chunks/323-385eb9a54df11fe7.js" defer=""></script><script src="/_next/static/chunks/pages/blogs/%5Bslug%5D-62a56e6ae9e142ea.js" defer=""></script><script src="/_next/static/BBDR7_tVPZfIMxaXYHYtU/_buildManifest.js" defer=""></script><script src="/_next/static/BBDR7_tVPZfIMxaXYHYtU/_ssgManifest.js" defer=""></script><script src="/_next/static/BBDR7_tVPZfIMxaXYHYtU/_middlewareManifest.js" defer=""></script><style data-emotion="css "></style></head><body><div id="__next" data-reactroot=""><style data-emotion="css-global o6gwfi">html{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;box-sizing:border-box;-webkit-text-size-adjust:100%;}*,*::before,*::after{box-sizing:inherit;}strong,b{font-weight:700;}body{margin:0;color:rgba(0, 0, 0, 0.87);font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:400;font-size:1rem;line-height:1.5;letter-spacing:0.00938em;background-color:#fff;}@media print{body{background-color:#fff;}}body::backdrop{background-color:#fff;}</style><section class="css-1vqbnt3"><header class="MuiPaper-root MuiPaper-elevation MuiPaper-elevation4 MuiAppBar-root MuiAppBar-colorPrimary MuiAppBar-positionStatic css-1x7skt0"><div class="MuiToolbar-root MuiToolbar-gutters MuiToolbar-regular css-191lty2"><div status="[object Object]" class="css-ad3hhb"></div><button class="MuiButtonBase-root MuiIconButton-root MuiIconButton-colorInherit MuiIconButton-sizeLarge css-1l1167e" tabindex="0" type="button" aria-label="Menu"><svg class="MuiSvgIcon-root MuiSvgIcon-fontSizeMedium css-vubbuv" focusable="false" viewBox="0 0 24 24" aria-hidden="true" data-testid="MenuIcon"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"></path></svg></button><p class="MuiTypography-root MuiTypography-body1 css-1ikde92" type="title"><button class="MuiButton-root MuiButton-text MuiButton-textInherit MuiButton-sizeMedium MuiButton-textSizeMedium MuiButton-colorInherit MuiButtonBase-root  css-b7766g" tabindex="0" type="button"><a href="/">Home</a></button><button class="MuiButton-root MuiButton-text MuiButton-textInherit MuiButton-sizeMedium MuiButton-textSizeMedium MuiButton-colorInherit MuiButtonBase-root  css-b7766g" tabindex="0" type="button"><a href="/blogs">Blog</a></button><button class="MuiButton-root MuiButton-text MuiButton-textInherit MuiButton-sizeMedium MuiButton-textSizeMedium MuiButton-colorInherit MuiButtonBase-root  css-b7766g" tabindex="0" type="button"><a href="/presentations">Presentation</a></button><button class="MuiButton-root MuiButton-text MuiButton-textInherit MuiButton-sizeMedium MuiButton-textSizeMedium MuiButton-colorInherit MuiButtonBase-root  css-b7766g" tabindex="0" type="button"><a href="/tools">Tool</a></button><button class="MuiButton-root MuiButton-text MuiButton-textInherit MuiButton-sizeMedium MuiButton-textSizeMedium MuiButton-colorInherit MuiButtonBase-root  css-b7766g" tabindex="0" type="button"><a href="/games">Game</a></button></p></div></header><section class="css-xxwux"><div class="MuiPaper-root MuiPaper-elevation MuiPaper-rounded MuiPaper-elevation4 css-gnirli"><header><h1 class="MuiTypography-root MuiTypography-body1 css-9l3uo3">使用gin来创建简单的http服务器</h1><div class="MuiTypography-root MuiTypography-body1 css-9l3uo3">Author:<!-- -->Gao</div><div class="MuiTypography-root MuiTypography-body1 css-9l3uo3">Created At:<!-- -->2021-12-09</div></header><hr class="MuiDivider-root MuiDivider-fullWidth css-39bbo6"/><section class="MuiTypography-root MuiTypography-body1 blog-content css-9l3uo3"><style data-emotion="css 1xqzmcn">.css-1xqzmcn pre code.hljs{display:block;overflow-x:auto;padding:1em;}.css-1xqzmcn code.hljs{padding:3px 5px;}.css-1xqzmcn .hljs{color:#383a42;background:#fafafa;}.css-1xqzmcn .hljs-comment,.css-1xqzmcn .hljs-quote{color:#a0a1a7;font-style:italic;}.css-1xqzmcn .hljs-doctag,.css-1xqzmcn .hljs-formula,.css-1xqzmcn .hljs-keyword{color:#a626a4;}.css-1xqzmcn .hljs-deletion,.css-1xqzmcn .hljs-name,.css-1xqzmcn .hljs-section,.css-1xqzmcn .hljs-selector-tag,.css-1xqzmcn .hljs-subst{color:#e45649;}.css-1xqzmcn .hljs-literal{color:#0184bb;}.css-1xqzmcn .hljs-addition,.css-1xqzmcn .hljs-attribute,.css-1xqzmcn .hljs-meta .hljs-string,.css-1xqzmcn .hljs-regexp,.css-1xqzmcn .hljs-string{color:#50a14f;}.css-1xqzmcn .hljs-attr,.css-1xqzmcn .hljs-number,.css-1xqzmcn .hljs-selector-attr,.css-1xqzmcn .hljs-selector-class,.css-1xqzmcn .hljs-selector-pseudo,.css-1xqzmcn .hljs-template-variable,.css-1xqzmcn .hljs-type,.css-1xqzmcn .hljs-variable{color:#986801;}.css-1xqzmcn .hljs-bullet,.css-1xqzmcn .hljs-link,.css-1xqzmcn .hljs-meta,.css-1xqzmcn .hljs-selector-id,.css-1xqzmcn .hljs-symbol,.css-1xqzmcn .hljs-title{color:#4078f2;}.css-1xqzmcn .hljs-built_in,.css-1xqzmcn .hljs-class .hljs-title,.css-1xqzmcn .hljs-title.class_{color:#c18401;}.css-1xqzmcn .hljs-emphasis{font-style:italic;}.css-1xqzmcn .hljs-strong{font-weight:700;}.css-1xqzmcn .hljs-link{-webkit-text-decoration:underline;text-decoration:underline;}</style><div class="css-1xqzmcn"><p>最近需要对Web服务进行重构，由于原先的martini已经不再维护了，所以更换为gin。</p>
<p>gin相对于原先的服务，使用起来相对更简单一些</p>
<p>服务启动：</p>
<pre><code class="hljs language-go">
<span class="hljs-keyword">import</span> (
	<span class="hljs-string">&quot;fmt&quot;</span>
	<span class="hljs-string">&quot;time&quot;</span>
	<span class="hljs-string">&quot;net/http&quot;</span>
	<span class="hljs-string">&quot;db&quot;</span>

	<span class="hljs-string">&quot;github.com/gin-gonic/gin&quot;</span>
)

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">main</span><span class="hljs-params">()</span></span> {
	r := gin.New()

	gin.SetMode(gin.ReleaseMode)
	
	db.SetupDB()

	r.Use(gin.LoggerWithFormatter(<span class="hljs-function"><span class="hljs-keyword">func</span><span class="hljs-params">(param gin.LogFormatterParams)</span></span> <span class="hljs-type">string</span> {
		<span class="hljs-keyword">return</span> fmt.Sprintf(<span class="hljs-string">&quot;%s - [%s] \&quot;%s %s %s %d %s \&quot;%s\&quot; %s\&quot;\n&quot;</span>,
			param.ClientIP,
			param.TimeStamp.Format(time.RFC1123),
			param.Method,
			param.Path,
			param.Request.Proto,
			param.StatusCode,
			param.Latency,
			param.Request.UserAgent(),
			param.ErrorMessage,
		)
	}))
	
	<span class="hljs-comment">// Add this to disable logging</span>
	<span class="hljs-comment">// gin.DefaultWriter = ioutil.Discard</span>
	
	r.GET(<span class="hljs-string">&quot;/address&quot;</span>, HandleAddress)
	r.GET(<span class="hljs-string">&quot;/healthz&quot;</span>, HandleHealthz)

	addr := fmt.Sprintf(<span class="hljs-string">&quot;%s:%d&quot;</span>, <span class="hljs-string">&quot;0.0.0.0&quot;</span>, <span class="hljs-string">&quot;80&quot;</span>)
	s := &amp;http.Server{
		Addr:           addr,
		Handler:        r,
		ReadTimeout:    <span class="hljs-number">10</span> * time.Second,
		WriteTimeout:   <span class="hljs-number">10</span> * time.Second,
		MaxHeaderBytes: <span class="hljs-number">1</span> &lt;&lt; <span class="hljs-number">20</span>,
	}
	
	s.ListenAndServe()
	
}

</code></pre>
<p>配置handler</p>
<pre><code class="hljs language-go">
<span class="hljs-keyword">import</span> (
	<span class="hljs-string">&quot;fmt&quot;</span>
	<span class="hljs-string">&quot;os&quot;</span>

	<span class="hljs-string">&quot;github.com/gin-gonic/gin&quot;</span>
)

<span class="hljs-keyword">type</span> Query <span class="hljs-keyword">struct</span> {
	IP   <span class="hljs-type">string</span> <span class="hljs-string">`form:&quot;ip&quot;`</span>
	Type <span class="hljs-type">string</span> <span class="hljs-string">`form:&quot;type&quot;`</span>
}

<span class="hljs-function"><span class="hljs-keyword">func</span> <span class="hljs-title">HandleAddress</span><span class="hljs-params">(c *gin.Context)</span></span> {
	<span class="hljs-keyword">var</span> query Query

	<span class="hljs-keyword">if</span> c.ShouldBind(&amp;query) == <span class="hljs-literal">nil</span> {
		ip := query.IP
		typ := query.Type

		<span class="hljs-keyword">switch</span> typ {
		<span class="hljs-keyword">case</span> <span class="hljs-string">&quot;v6&quot;</span>:
			out, err := db.FindV6Addr(ip)
			<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
				c.String(<span class="hljs-number">500</span>, err.Error())
			} <span class="hljs-keyword">else</span> {
				c.JSON(<span class="hljs-number">200</span>, out)
			}
		<span class="hljs-keyword">default</span>:
			out, err := db.FindV4Addr(ip)
			<span class="hljs-keyword">if</span> err != <span class="hljs-literal">nil</span> {
				c.String(<span class="hljs-number">500</span>, err.Error())
			} <span class="hljs-keyword">else</span> {
				c.JSON(<span class="hljs-number">200</span>, out)
			}
		}
	} <span class="hljs-keyword">else</span> {

		c.String(<span class="hljs-number">500</span>, <span class="hljs-string">&quot;not support.&quot;</span>)
	}

}
</code></pre>
<p>配置好后测试了性能：</p>
<p>开日志性能 <code>90_000 RPS</code></p>
<p>关日志性能 <code>180_000 RPS</code></p>
<p>大约比原先martini提高了一倍性能</p></div></section></div></section><footer style="margin-top:0" class="css-6haedj"><div class="container"><span id="icp-info" class="css-z2a085">京ICP备20014476号-2</span><span>Copyright © 2017-2021 GSMLG - Powered by GSMLG Web.</span></div></footer></section></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"slug":"using-gin-web-server","blog":{"author":"Gao","content":"\n最近需要对Web服务进行重构，由于原先的martini已经不再维护了，所以更换为gin。\n\ngin相对于原先的服务，使用起来相对更简单一些\n\n服务启动：\n\n```go\n\nimport (\n\t\"fmt\"\n\t\"time\"\n\t\"net/http\"\n\t\"db\"\n\n\t\"github.com/gin-gonic/gin\"\n)\n\nfunc main() {\n\tr := gin.New()\n\n\tgin.SetMode(gin.ReleaseMode)\n\t\n\tdb.SetupDB()\n\n\tr.Use(gin.LoggerWithFormatter(func(param gin.LogFormatterParams) string {\n\t\treturn fmt.Sprintf(\"%s - [%s] \\\"%s %s %s %d %s \\\"%s\\\" %s\\\"\\n\",\n\t\t\tparam.ClientIP,\n\t\t\tparam.TimeStamp.Format(time.RFC1123),\n\t\t\tparam.Method,\n\t\t\tparam.Path,\n\t\t\tparam.Request.Proto,\n\t\t\tparam.StatusCode,\n\t\t\tparam.Latency,\n\t\t\tparam.Request.UserAgent(),\n\t\t\tparam.ErrorMessage,\n\t\t)\n\t}))\n\t\n\t// Add this to disable logging\n\t// gin.DefaultWriter = ioutil.Discard\n\t\n\tr.GET(\"/address\", HandleAddress)\n\tr.GET(\"/healthz\", HandleHealthz)\n\n\taddr := fmt.Sprintf(\"%s:%d\", \"0.0.0.0\", \"80\")\n\ts := \u0026http.Server{\n\t\tAddr:           addr,\n\t\tHandler:        r,\n\t\tReadTimeout:    10 * time.Second,\n\t\tWriteTimeout:   10 * time.Second,\n\t\tMaxHeaderBytes: 1 \u003c\u003c 20,\n\t}\n\t\n\ts.ListenAndServe()\n\t\n}\n\n```\n\n配置handler\n```go\n\nimport (\n\t\"fmt\"\n\t\"os\"\n\n\t\"github.com/gin-gonic/gin\"\n)\n\ntype Query struct {\n\tIP   string `form:\"ip\"`\n\tType string `form:\"type\"`\n}\n\nfunc HandleAddress(c *gin.Context) {\n\tvar query Query\n\n\tif c.ShouldBind(\u0026query) == nil {\n\t\tip := query.IP\n\t\ttyp := query.Type\n\n\t\tswitch typ {\n\t\tcase \"v6\":\n\t\t\tout, err := db.FindV6Addr(ip)\n\t\t\tif err != nil {\n\t\t\t\tc.String(500, err.Error())\n\t\t\t} else {\n\t\t\t\tc.JSON(200, out)\n\t\t\t}\n\t\tdefault:\n\t\t\tout, err := db.FindV4Addr(ip)\n\t\t\tif err != nil {\n\t\t\t\tc.String(500, err.Error())\n\t\t\t} else {\n\t\t\t\tc.JSON(200, out)\n\t\t\t}\n\t\t}\n\t} else {\n\n\t\tc.String(500, \"not support.\")\n\t}\n\n}\n```\n\n配置好后测试了性能：\n\n开日志性能 `90_000 RPS`\n\n关日志性能 `180_000 RPS`\n\n大约比原先martini提高了一倍性能\n\n","date":"2021-12-09","id":62,"slug":"using-gin-web-server","title":"使用gin来创建简单的http服务器"},"lightCss":"pre code.hljs{display:block;overflow-x:auto;padding:1em}code.hljs{padding:3px 5px}.hljs{color:#383a42;background:#fafafa}.hljs-comment,.hljs-quote{color:#a0a1a7;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#a626a4}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e45649}.hljs-literal{color:#0184bb}.hljs-addition,.hljs-attribute,.hljs-meta .hljs-string,.hljs-regexp,.hljs-string{color:#50a14f}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#986801}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#4078f2}.hljs-built_in,.hljs-class .hljs-title,.hljs-title.class_{color:#c18401}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}","darkCss":"pre code.hljs{display:block;overflow-x:auto;padding:1em}code.hljs{padding:3px 5px}.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta .hljs-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-built_in,.hljs-class .hljs-title,.hljs-title.class_{color:#e6c07b}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}"},"__N_SSG":true},"page":"/blogs/[slug]","query":{"slug":"using-gin-web-server"},"buildId":"BBDR7_tVPZfIMxaXYHYtU","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>