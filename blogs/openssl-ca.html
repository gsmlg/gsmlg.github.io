<!DOCTYPE html><html lang="en"><head><meta name="theme-color" content="#1976d2"/><meta charSet="utf-8"/><meta name="viewport" content="minimum-scale=1, initial-scale=1, width=device-width"/><meta name="theme-color" content="#1976d2"/><title>OpenSSL Certificate Authority</title><link rel="icon" href="/favicon.ico"/><meta name="next-head-count" content="5"/><link rel="preload" href="/_next/static/css/e48649c78aa55d60.css" as="style"/><link rel="stylesheet" href="/_next/static/css/e48649c78aa55d60.css" data-n-g=""/><link rel="preload" href="/_next/static/css/c2a527101433f11d.css" as="style"/><link rel="stylesheet" href="/_next/static/css/c2a527101433f11d.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-5cd94c89d3acac5f.js"></script><script src="/_next/static/chunks/webpack-1fec710eb11e1257.js" defer=""></script><script src="/_next/static/chunks/framework-91d7f78b5b4003c8.js" defer=""></script><script src="/_next/static/chunks/main-b2070e873ca4314c.js" defer=""></script><script src="/_next/static/chunks/pages/_app-5c92ba9c94c6518f.js" defer=""></script><script src="/_next/static/chunks/eb1842f2-db13b08fd88037dd.js" defer=""></script><script src="/_next/static/chunks/947-80ad608d6161013a.js" defer=""></script><script src="/_next/static/chunks/323-045631e3e236dbf8.js" defer=""></script><script src="/_next/static/chunks/pages/blogs/%5Bslug%5D-62a56e6ae9e142ea.js" defer=""></script><script src="/_next/static/QNybktfW459stvqkf64RS/_buildManifest.js" defer=""></script><script src="/_next/static/QNybktfW459stvqkf64RS/_ssgManifest.js" defer=""></script><script src="/_next/static/QNybktfW459stvqkf64RS/_middlewareManifest.js" defer=""></script><style data-emotion="css "></style></head><body><div id="__next" data-reactroot=""><style data-emotion="css-global o6gwfi">html{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;box-sizing:border-box;-webkit-text-size-adjust:100%;}*,*::before,*::after{box-sizing:inherit;}strong,b{font-weight:700;}body{margin:0;color:rgba(0, 0, 0, 0.87);font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:400;font-size:1rem;line-height:1.5;letter-spacing:0.00938em;background-color:#fff;}@media print{body{background-color:#fff;}}body::backdrop{background-color:#fff;}</style><section class="css-1vqbnt3"><header class="MuiPaper-root MuiPaper-elevation MuiPaper-elevation4 MuiAppBar-root MuiAppBar-colorPrimary MuiAppBar-positionStatic css-1x7skt0"><div class="MuiToolbar-root MuiToolbar-gutters MuiToolbar-regular css-191lty2"><div status="[object Object]" class="css-ad3hhb"></div><button class="MuiButtonBase-root MuiIconButton-root MuiIconButton-colorInherit MuiIconButton-sizeLarge css-1l1167e" tabindex="0" type="button" aria-label="Menu"><svg class="MuiSvgIcon-root MuiSvgIcon-fontSizeMedium css-vubbuv" focusable="false" viewBox="0 0 24 24" aria-hidden="true" data-testid="MenuIcon"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"></path></svg></button><p class="MuiTypography-root MuiTypography-body1 css-1ikde92" type="title"><button class="MuiButton-root MuiButton-text MuiButton-textInherit MuiButton-sizeMedium MuiButton-textSizeMedium MuiButton-colorInherit MuiButtonBase-root  css-b7766g" tabindex="0" type="button"><a href="/">Home</a></button><button class="MuiButton-root MuiButton-text MuiButton-textInherit MuiButton-sizeMedium MuiButton-textSizeMedium MuiButton-colorInherit MuiButtonBase-root  css-b7766g" tabindex="0" type="button"><a href="/blogs">Blog</a></button><button class="MuiButton-root MuiButton-text MuiButton-textInherit MuiButton-sizeMedium MuiButton-textSizeMedium MuiButton-colorInherit MuiButtonBase-root  css-b7766g" tabindex="0" type="button"><a href="/presentations">Presentation</a></button><button class="MuiButton-root MuiButton-text MuiButton-textInherit MuiButton-sizeMedium MuiButton-textSizeMedium MuiButton-colorInherit MuiButtonBase-root  css-b7766g" tabindex="0" type="button"><a href="/tools">Tool</a></button><button class="MuiButton-root MuiButton-text MuiButton-textInherit MuiButton-sizeMedium MuiButton-textSizeMedium MuiButton-colorInherit MuiButtonBase-root  css-b7766g" tabindex="0" type="button"><a href="/games">Game</a></button></p></div></header><section class="css-xxwux"><div class="MuiPaper-root MuiPaper-elevation MuiPaper-rounded MuiPaper-elevation4 css-gnirli"><header><h1 class="MuiTypography-root MuiTypography-body1 css-9l3uo3">OpenSSL Certificate Authority</h1><div class="MuiTypography-root MuiTypography-body1 css-9l3uo3">Author:<!-- -->Gao</div><div class="MuiTypography-root MuiTypography-body1 css-9l3uo3">Created At:<!-- -->2021-08-17</div></header><hr class="MuiDivider-root MuiDivider-fullWidth css-39bbo6"/><section class="MuiTypography-root MuiTypography-body1 blog-content css-9l3uo3"><div class="css-1xqzmcn"><h3>简介</h3>
<p>OpenSSL 是一款自由开源的加密库, 提供了一些命令行工具来处理数字证书. 其中的一些工
具可以作为证书权威机构来使用.</p>
<p>证书权威(CA)是一个认证证书实体的证书机构. 许多 Web 站点需要让他们的客户清楚他们
的连接是安全的, 他们通过向一些国际性的可信 CA(eg. VeriSign, DigiCert)为他们的站
点去购买一个证书.</p>
<p>在一些时候, 相比于去购买一个证书,更需要去实现一自己的 CA. 通常是需要内部网络使用
的安全连接, 或者是需要向客户发布一个证书来让他们通过服务器的认证(eg, Apache,
OpenVPN)</p>
<h3>创建 root pair</h3>
<p>成为一个 CA 意味着需要处理加密密钥对, 私钥和证书. 首先需要第一步创建的是 root
pair. 它包含 root key(ca.key.pem)和 root certificate(ca.cert.pem). 这对迷药就是
CA 的身份认证.</p>
<p>通常, root CA 不会给任何服务器或客户端签名. root CA 只被用来创建更多的二级 CA,
二级 CA 被 root CA 签名, 作为 root CA 的代表. 这是最佳实践, 可以让 root key 保持
离线和尽量少的被使用, 以保证 root key 有最小的泄漏风险.</p>
<pre><code class="hljs language-properties"><span class="hljs-attr">⚠️注意</span>
<span class="hljs-attr">最佳实践是在一个安全的环境里创建root</span> <span class="hljs-string">pair. 理想情况下, 在一个完全保密的环境, 并且和互联网完全隔离, 并拔除无线和有线网卡.</span>
</code></pre>
<h4>准备目录</h4>
<p>选择目录来保存所有的 keys 和 certificates</p>
<pre><code class="hljs language-shell"><span class="hljs-meta"># </span><span class="bash"><span class="hljs-built_in">mkdir</span> /root/ca</span>
</code></pre>
<p>创建目录结构. 其中 <code>index.txt</code> 和 <code>serial</code> 文件是用来保存已经签名证书的记录的文
件数据库.</p>
<pre><code class="hljs language-shell"><span class="hljs-meta"># </span><span class="bash"><span class="hljs-built_in">cd</span> /root/ca</span>
<span class="hljs-meta"># </span><span class="bash"><span class="hljs-built_in">mkdir</span> certs crl newcerts private</span>
<span class="hljs-meta"># </span><span class="bash"><span class="hljs-built_in">chmod</span> 700 private</span>
<span class="hljs-meta"># </span><span class="bash"><span class="hljs-built_in">touch</span> index.txt</span>
<span class="hljs-meta"># </span><span class="bash"><span class="hljs-built_in">echo</span> 1000 &gt; serial</span>
</code></pre>
<h4>准备配置文件</h4>
<p>我们需要创建一个 OpenSSL 配置文件来使用. 复制 root CA 的配置文件到
<code>/root/ca/openssl.cnf</code>.</p>
<p>root CA 配置文件</p>
<pre><code class="hljs language-ini"><span class="hljs-comment"># OpenSSL root CA configuration file.</span>
<span class="hljs-comment"># Copy to `/root/ca/openssl.cnf`.</span>

<span class="hljs-section">[ ca ]</span>
<span class="hljs-comment"># `man ca`</span>
<span class="hljs-attr">default_ca</span> = CA_default

<span class="hljs-section">[ CA_default ]</span>
<span class="hljs-comment"># Directory and file locations.</span>
<span class="hljs-attr">dir</span>               = /root/ca
<span class="hljs-attr">certs</span>             = <span class="hljs-variable">$dir</span>/certs
<span class="hljs-attr">crl_dir</span>           = <span class="hljs-variable">$dir</span>/crl
<span class="hljs-attr">new_certs_dir</span>     = <span class="hljs-variable">$dir</span>/newcerts
<span class="hljs-attr">database</span>          = <span class="hljs-variable">$dir</span>/index.txt
<span class="hljs-attr">serial</span>            = <span class="hljs-variable">$dir</span>/serial
<span class="hljs-attr">RANDFILE</span>          = <span class="hljs-variable">$dir</span>/private/.rand

<span class="hljs-comment"># The root key and root certificate.</span>
<span class="hljs-attr">private_key</span>       = <span class="hljs-variable">$dir</span>/private/ca.key.pem
<span class="hljs-attr">certificate</span>       = <span class="hljs-variable">$dir</span>/certs/ca.cert.pem

<span class="hljs-comment"># For certificate revocation lists.</span>
<span class="hljs-attr">crlnumber</span>         = <span class="hljs-variable">$dir</span>/crlnumber
<span class="hljs-attr">crl</span>               = <span class="hljs-variable">$dir</span>/crl/ca.crl.pem
<span class="hljs-attr">crl_extensions</span>    = crl_ext
<span class="hljs-attr">default_crl_days</span>  = <span class="hljs-number">30</span>

<span class="hljs-comment"># SHA-1 is deprecated, so use SHA-2 instead.</span>
<span class="hljs-attr">default_md</span>        = sha256

<span class="hljs-attr">name_opt</span>          = ca_default
<span class="hljs-attr">cert_opt</span>          = ca_default
<span class="hljs-attr">default_days</span>      = <span class="hljs-number">375</span>
<span class="hljs-attr">preserve</span>          = <span class="hljs-literal">no</span>
<span class="hljs-attr">policy</span>            = policy_strict

<span class="hljs-section">[ policy_strict ]</span>
<span class="hljs-comment"># The root CA should only sign intermediate certificates that match.</span>
<span class="hljs-comment"># See the POLICY FORMAT section of `man ca`.</span>
<span class="hljs-attr">countryName</span>             = match
<span class="hljs-attr">stateOrProvinceName</span>     = match
<span class="hljs-attr">organizationName</span>        = match
<span class="hljs-attr">organizationalUnitName</span>  = optional
<span class="hljs-attr">commonName</span>              = supplied
<span class="hljs-attr">emailAddress</span>            = optional

<span class="hljs-section">[ policy_loose ]</span>
<span class="hljs-comment"># Allow the intermediate CA to sign a more diverse range of certificates.</span>
<span class="hljs-comment"># See the POLICY FORMAT section of the `ca` man page.</span>
<span class="hljs-attr">countryName</span>             = optional
<span class="hljs-attr">stateOrProvinceName</span>     = optional
<span class="hljs-attr">localityName</span>            = optional
<span class="hljs-attr">organizationName</span>        = optional
<span class="hljs-attr">organizationalUnitName</span>  = optional
<span class="hljs-attr">commonName</span>              = supplied
<span class="hljs-attr">emailAddress</span>            = optional

<span class="hljs-section">[ req ]</span>
<span class="hljs-comment"># Options for the `req` tool (`man req`).</span>
<span class="hljs-attr">default_bits</span>        = <span class="hljs-number">2048</span>
<span class="hljs-attr">distinguished_name</span>  = req_distinguished_name
<span class="hljs-attr">string_mask</span>         = utf8only

<span class="hljs-comment"># SHA-1 is deprecated, so use SHA-2 instead.</span>
<span class="hljs-attr">default_md</span>          = sha256

<span class="hljs-comment"># Extension to add when the -x509 option is used.</span>
<span class="hljs-attr">x509_extensions</span>     = v3_ca

<span class="hljs-section">[ req_distinguished_name ]</span>
<span class="hljs-comment"># See &lt;https://en.wikipedia.org/wiki/Certificate_signing_request&gt;.</span>
<span class="hljs-attr">countryName</span>                     = Country Name (<span class="hljs-number">2</span> letter code)
<span class="hljs-attr">stateOrProvinceName</span>             = State or Province Name
<span class="hljs-attr">localityName</span>                    = Locality Name
<span class="hljs-attr">0.organizationName</span>              = Organization Name
<span class="hljs-attr">organizationalUnitName</span>          = Organizational Unit Name
<span class="hljs-attr">commonName</span>                      = Common Name
<span class="hljs-attr">emailAddress</span>                    = Email Address

<span class="hljs-comment"># Optionally, specify some defaults.</span>
<span class="hljs-attr">countryName_default</span>             = GB
<span class="hljs-attr">stateOrProvinceName_default</span>     = England
<span class="hljs-attr">localityName_default</span>            =
<span class="hljs-attr">0.organizationName_default</span>      = Alice Ltd
<span class="hljs-attr">organizationalUnitName_default</span>  =
<span class="hljs-attr">emailAddress_default</span>            =

<span class="hljs-section">[ v3_ca ]</span>
<span class="hljs-comment"># Extensions for a typical CA (`man x509v3_config`).</span>
<span class="hljs-attr">subjectKeyIdentifier</span> = hash
<span class="hljs-attr">authorityKeyIdentifier</span> = keyid:always,issuer
<span class="hljs-attr">basicConstraints</span> = critical, CA:<span class="hljs-literal">true</span>
<span class="hljs-attr">keyUsage</span> = critical, digitalSignature, cRLSign, keyCertSign

<span class="hljs-section">[ v3_intermediate_ca ]</span>
<span class="hljs-comment"># Extensions for a typical intermediate CA (`man x509v3_config`).</span>
<span class="hljs-attr">subjectKeyIdentifier</span> = hash
<span class="hljs-attr">authorityKeyIdentifier</span> = keyid:always,issuer
<span class="hljs-attr">basicConstraints</span> = critical, CA:<span class="hljs-literal">true</span>, pathlen:<span class="hljs-number">0</span>
<span class="hljs-attr">keyUsage</span> = critical, digitalSignature, cRLSign, keyCertSign

<span class="hljs-section">[ usr_cert ]</span>
<span class="hljs-comment"># Extensions for client certificates (`man x509v3_config`).</span>
<span class="hljs-attr">basicConstraints</span> = CA:<span class="hljs-literal">FALSE</span>
<span class="hljs-attr">nsCertType</span> = client, email
<span class="hljs-attr">nsComment</span> = <span class="hljs-string">&quot;OpenSSL Generated Client Certificate&quot;</span>
<span class="hljs-attr">subjectKeyIdentifier</span> = hash
<span class="hljs-attr">authorityKeyIdentifier</span> = keyid,issuer
<span class="hljs-attr">keyUsage</span> = critical, nonRepudiation, digitalSignature, keyEncipherment
<span class="hljs-attr">extendedKeyUsage</span> = clientAuth, emailProtection

<span class="hljs-section">[ server_cert ]</span>
<span class="hljs-comment"># Extensions for server certificates (`man x509v3_config`).</span>
<span class="hljs-attr">basicConstraints</span> = CA:<span class="hljs-literal">FALSE</span>
<span class="hljs-attr">nsCertType</span> = server
<span class="hljs-attr">nsComment</span> = <span class="hljs-string">&quot;OpenSSL Generated Server Certificate&quot;</span>
<span class="hljs-attr">subjectKeyIdentifier</span> = hash
<span class="hljs-attr">authorityKeyIdentifier</span> = keyid,issuer:always
<span class="hljs-attr">keyUsage</span> = critical, digitalSignature, keyEncipherment
<span class="hljs-attr">extendedKeyUsage</span> = serverAuth

<span class="hljs-section">[ crl_ext ]</span>
<span class="hljs-comment"># Extension for CRLs (`man x509v3_config`).</span>
<span class="hljs-attr">authorityKeyIdentifier</span>=keyid:always

<span class="hljs-section">[ ocsp ]</span>
<span class="hljs-comment"># Extension for OCSP signing certificates (`man ocsp`).</span>
<span class="hljs-attr">basicConstraints</span> = CA:<span class="hljs-literal">FALSE</span>
<span class="hljs-attr">subjectKeyIdentifier</span> = hash
<span class="hljs-attr">authorityKeyIdentifier</span> = keyid,issuer
<span class="hljs-attr">keyUsage</span> = critical, digitalSignature
<span class="hljs-attr">extendedKeyUsage</span> = critical, OCSPSigning
</code></pre>
<p>其中 <code>[ca]</code> 部分是必须的. 这里我们告诉 OpenSSL 使用选项 <code>[CA_default]</code> 部分</p>
<pre><code class="hljs language-properties"><span class="hljs-attr">[</span> <span class="hljs-string">ca ]</span>
<span class="hljs-comment"># `man ca`</span>
<span class="hljs-attr">default_ca</span> = <span class="hljs-string">CA_default</span>
</code></pre>
<p>而 <code>[CA_default]</code> 部分包含一类设置配置. 确保之前配置的目录 <code>/root/ca</code> 有效</p>
<pre><code class="hljs language-ini"><span class="hljs-section">[ CA_default ]</span>
<span class="hljs-comment"># Directory and file locations.</span>
<span class="hljs-attr">dir</span>               = /root/ca
<span class="hljs-attr">certs</span>             = <span class="hljs-variable">$dir</span>/certs
<span class="hljs-attr">crl_dir</span>           = <span class="hljs-variable">$dir</span>/crl
<span class="hljs-attr">new_certs_dir</span>     = <span class="hljs-variable">$dir</span>/newcerts
<span class="hljs-attr">database</span>          = <span class="hljs-variable">$dir</span>/index.txt
<span class="hljs-attr">serial</span>            = <span class="hljs-variable">$dir</span>/serial
<span class="hljs-attr">RANDFILE</span>          = <span class="hljs-variable">$dir</span>/private/.rand

<span class="hljs-comment"># The root key and root certificate.</span>
<span class="hljs-attr">private_key</span>       = <span class="hljs-variable">$dir</span>/private/ca.key.pem
<span class="hljs-attr">certificate</span>       = <span class="hljs-variable">$dir</span>/certs/ca.cert.pem

<span class="hljs-comment"># For certificate revocation lists.</span>
<span class="hljs-attr">crlnumber</span>         = <span class="hljs-variable">$dir</span>/crlnumber
<span class="hljs-attr">crl</span>               = <span class="hljs-variable">$dir</span>/crl/ca.crl.pem
<span class="hljs-attr">crl_extensions</span>    = crl_ext
<span class="hljs-attr">default_crl_days</span>  = <span class="hljs-number">30</span>

<span class="hljs-comment"># SHA-1 is deprecated, so use SHA-2 instead.</span>
<span class="hljs-attr">default_md</span>        = sha256

<span class="hljs-attr">name_opt</span>          = ca_default
<span class="hljs-attr">cert_opt</span>          = ca_default
<span class="hljs-attr">default_days</span>      = <span class="hljs-number">375</span>
<span class="hljs-attr">preserve</span>          = <span class="hljs-literal">no</span>
<span class="hljs-attr">policy</span>            = policy_strict
</code></pre>
<p>我们应用 <code>policy_strict</code> 到所有的 root CA 签名, 使 root CA 仅被用来创建二级 CA.</p>
<pre><code class="hljs language-properties"><span class="hljs-attr">[</span> <span class="hljs-string">policy_strict ]</span>
<span class="hljs-comment"># The root CA should only sign intermediate certificates that match.</span>
<span class="hljs-comment"># See the POLICY FORMAT section of `man ca`.</span>
<span class="hljs-attr">countryName</span>             = <span class="hljs-string">match</span>
<span class="hljs-attr">stateOrProvinceName</span>     = <span class="hljs-string">match</span>
<span class="hljs-attr">organizationName</span>        = <span class="hljs-string">match</span>
<span class="hljs-attr">organizationalUnitName</span>  = <span class="hljs-string">optional</span>
<span class="hljs-attr">commonName</span>              = <span class="hljs-string">supplied</span>
<span class="hljs-attr">emailAddress</span>            = <span class="hljs-string">optional</span>
</code></pre>
<p>我们应用 <code>policy_loose</code> 到所有二级 CA 签名, 二级 CA 会给所有的 Server 和 Client
签名, 它们会有很多的种类变化.</p>
<pre><code class="hljs language-properties"><span class="hljs-attr">[</span> <span class="hljs-string">policy_loose ]</span>
<span class="hljs-comment"># Allow the intermediate CA to sign a more diverse range of certificates.</span>
<span class="hljs-comment"># See the POLICY FORMAT section of the `ca` man page.</span>
<span class="hljs-attr">countryName</span>             = <span class="hljs-string">optional</span>
<span class="hljs-attr">stateOrProvinceName</span>     = <span class="hljs-string">optional</span>
<span class="hljs-attr">localityName</span>            = <span class="hljs-string">optional</span>
<span class="hljs-attr">organizationName</span>        = <span class="hljs-string">optional</span>
<span class="hljs-attr">organizationalUnitName</span>  = <span class="hljs-string">optional</span>
<span class="hljs-attr">commonName</span>              = <span class="hljs-string">supplied</span>
<span class="hljs-attr">emailAddress</span>            = <span class="hljs-string">optional</span>
</code></pre>
<p><code>[req]</code> 部分会被使用到所有的证书请求和证书创建</p>
<pre><code class="hljs language-properties"><span class="hljs-attr">[</span> <span class="hljs-string">req ]</span>
<span class="hljs-comment"># Options for the `req` tool (`man req`).</span>
<span class="hljs-attr">default_bits</span>        = <span class="hljs-string">2048</span>
<span class="hljs-attr">distinguished_name</span>  = <span class="hljs-string">req_distinguished_name</span>
<span class="hljs-attr">string_mask</span>         = <span class="hljs-string">utf8only</span>
<span class="hljs-comment">
# SHA-1 is deprecated, so use SHA-2 instead.</span>
<span class="hljs-attr">default_md</span>          = <span class="hljs-string">sha256</span>
<span class="hljs-comment">
# Extension to add when the -x509 option is used.</span>
<span class="hljs-attr">x509_extensions</span>     = <span class="hljs-string">v3_ca</span>
</code></pre>
<p><code>[req_distinguished_name]</code> 部分包含了一般证书请求签名信息. 可以手动添加一些默认
值来配置.</p>
<pre><code class="hljs language-properties"><span class="hljs-attr">[</span> <span class="hljs-string">req_distinguished_name ]</span>
<span class="hljs-comment"># See &lt;https://en.wikipedia.org/wiki/Certificate_signing_request&gt;.</span>
<span class="hljs-attr">countryName</span>                     = <span class="hljs-string">Country Name (2 letter code)</span>
<span class="hljs-attr">stateOrProvinceName</span>             = <span class="hljs-string">State or Province Name</span>
<span class="hljs-attr">localityName</span>                    = <span class="hljs-string">Locality Name</span>
<span class="hljs-attr">0.organizationName</span>              = <span class="hljs-string">Organization Name</span>
<span class="hljs-attr">organizationalUnitName</span>          = <span class="hljs-string">Organizational Unit Name</span>
<span class="hljs-attr">commonName</span>                      = <span class="hljs-string">Common Name</span>
<span class="hljs-attr">emailAddress</span>                    = <span class="hljs-string">Email Address</span>
<span class="hljs-comment">
# Optionally, specify some defaults.</span>
<span class="hljs-attr">countryName_default</span>             = <span class="hljs-string">GB</span>
<span class="hljs-attr">stateOrProvinceName_default</span>     = <span class="hljs-string">England</span>
<span class="hljs-attr">localityName_default</span>            =<span class="hljs-string"></span>
<span class="hljs-attr">0.organizationName_default</span>      = <span class="hljs-string">Alice Ltd</span>
<span class="hljs-comment">#organizationalUnitName_default =</span>
<span class="hljs-comment">#emailAddress_default           =</span>
</code></pre>
<p>之后的几个部分是一些扩展, 这些扩展可以在证书签名的时候使用. 例如: 使用
<code>-extensions v3_ca</code> 命令行参数会应用在 <code>[v3_ca]</code> 下的选项.</p>
<p>在创建根证书的时候, 我们使用 <code>v3_ca</code></p>
<pre><code class="hljs language-ini"><span class="hljs-section">[ v3_ca ]</span>
<span class="hljs-comment"># Extensions for a typical CA (`man x509v3_config`).</span>
<span class="hljs-attr">subjectKeyIdentifier</span> = hash
<span class="hljs-attr">authorityKeyIdentifier</span> = keyid:always,issuer
<span class="hljs-attr">basicConstraints</span> = critical, CA:<span class="hljs-literal">true</span>
<span class="hljs-attr">keyUsage</span> = critical, digitalSignature, cRLSign, keyCertSign
</code></pre>
<p>在创建二级 CA 时, 使用 <code>v3_intermediate_ca</code>, 其中额外增加了 <code>pathlen:0</code> 来确保二
级 CA 下可以再创建 CA</p>
<pre><code class="hljs language-ini"><span class="hljs-section">[ v3_intermediate_ca ]</span>
<span class="hljs-comment"># Extensions for a typical intermediate CA (`man x509v3_config`).</span>
<span class="hljs-attr">subjectKeyIdentifier</span> = hash
<span class="hljs-attr">authorityKeyIdentifier</span> = keyid:always,issuer
<span class="hljs-attr">basicConstraints</span> = critical, CA:<span class="hljs-literal">true</span>, pathlen:<span class="hljs-number">0</span>
<span class="hljs-attr">keyUsage</span> = critical, digitalSignature, cRLSign, keyCertSign
</code></pre>
<p>在签发客户端证书时, 我们使用 <code>usr_cert</code>, 这些被使用做远程用户认证.</p>
<pre><code class="hljs language-ini"><span class="hljs-section">[ usr_cert ]</span>
<span class="hljs-comment"># Extensions for client certificates (`man x509v3_config`).</span>
<span class="hljs-attr">basicConstraints</span> = CA:<span class="hljs-literal">FALSE</span>
<span class="hljs-attr">nsCertType</span> = client, email
<span class="hljs-attr">nsComment</span> = <span class="hljs-string">&quot;OpenSSL Generated Client Certificate&quot;</span>
<span class="hljs-attr">subjectKeyIdentifier</span> = hash
<span class="hljs-attr">authorityKeyIdentifier</span> = keyid,issuer
<span class="hljs-attr">keyUsage</span> = critical, nonRepudiation, digitalSignature, keyEncipherment
<span class="hljs-attr">extendedKeyUsage</span> = clientAuth, emailProtection
</code></pre>
<p>在创建服务器证书时, 使用 <code>server_cert</code> 选项, 这些被用于 Web 服务器.</p>
<pre><code class="hljs language-ini"><span class="hljs-section">[ server_cert ]</span>
<span class="hljs-comment"># Extensions for server certificates (`man x509v3_config`).</span>
<span class="hljs-attr">basicConstraints</span> = CA:<span class="hljs-literal">FALSE</span>
<span class="hljs-attr">nsCertType</span> = server
<span class="hljs-attr">nsComment</span> = <span class="hljs-string">&quot;OpenSSL Generated Server Certificate&quot;</span>
<span class="hljs-attr">subjectKeyIdentifier</span> = hash
<span class="hljs-attr">authorityKeyIdentifier</span> = keyid,issuer:always
<span class="hljs-attr">keyUsage</span> = critical, digitalSignature, keyEncipherment
<span class="hljs-attr">extendedKeyUsage</span> = serverAuth
</code></pre>
<p>在创建证书废除列表时, <code>crl_ext</code> 选项会被自动应用</p>
<pre><code class="hljs language-properties"><span class="hljs-attr">[</span> <span class="hljs-string">crl_ext ]</span>
<span class="hljs-comment"># Extension for CRLs (`man x509v3_config`).</span>
<span class="hljs-attr">authorityKeyIdentifier</span>=<span class="hljs-string">keyid:always</span>
</code></pre>
<p>在签名在线证书状态协议(Online Certificate Status Protocol (OCSP))证书时, 使用选
项 <code>ocsp</code></p>
<pre><code class="hljs language-ini"><span class="hljs-section">[ ocsp ]</span>
<span class="hljs-comment"># Extension for OCSP signing certificates (`man ocsp`).</span>
<span class="hljs-attr">basicConstraints</span> = CA:<span class="hljs-literal">FALSE</span>
<span class="hljs-attr">subjectKeyIdentifier</span> = hash
<span class="hljs-attr">authorityKeyIdentifier</span> = keyid,issuer
<span class="hljs-attr">keyUsage</span> = critical, digitalSignature
<span class="hljs-attr">extendedKeyUsage</span> = critical, OCSPSigning
</code></pre>
<h4>创建 root key</h4>
<p>创建 root key( <code>ca.key.pem</code> )并保证它的绝对安全. 任何拥有 root key 的人都可以创
建受信任的证书. 使用 AES 256-bit 来加密 root key, 并创建一个健壮的密码.</p>
<pre><code class="hljs language-properties"><span class="hljs-attr">⚠️注意</span>
<span class="hljs-attr">使用4096位创建所有的根CA和二级CA的keys.</span>
<span class="hljs-attr">你仍然可以使用更短的长度来创建服务器和客户端证书.</span>
</code></pre>
<pre><code class="hljs language-shell"><span class="hljs-meta"># </span><span class="bash"><span class="hljs-built_in">cd</span> /root/ca</span>
<span class="hljs-meta"># </span><span class="bash">openssl genrsa -aes256 -out private/ca.key.pem 4096</span>

Enter pass phrase for ca.key.pem: secretpassword
Verifying - Enter pass phrase for ca.key.pem: secretpassword
<span class="hljs-meta">
# </span><span class="bash"><span class="hljs-built_in">chmod</span> 400 private/ca.key.pem</span>
</code></pre>
<h4>创建根证书(Root certificate)</h4>
<p>使用 root key(ca.key.pem)来创建根证书(ca.cert.pem). 给根证书设置一个比较长的有效
期, 比如 20 年. 一旦根证书失效, 所有被根证书签名的证书都会失效.</p>
<pre><code class="hljs language-autohotkey">⚠️警告
当使用`req`工具时, 必须使用`-config`选项来指定一个配置文件, 否则OpenSSL会默认使用`/etc/pki/tls/openssl.cnf`
</code></pre>
<pre><code class="hljs language-properties"><span class="hljs-comment"># cd /root/ca</span>
<span class="hljs-comment"># openssl req -config openssl.cnf \</span>
      <span class="hljs-attr">-key</span> <span class="hljs-string">private/ca.key.pem \
      -new -x509 -days 7300 -sha256 -extensions v3_ca \
      -out certs/ca.cert.pem</span>

<span class="hljs-attr">Enter</span> <span class="hljs-string">pass phrase for ca.key.pem: secretpassword</span>
<span class="hljs-attr">You</span> <span class="hljs-string">are about to be asked to enter information that will be incorporated</span>
<span class="hljs-attr">into</span> <span class="hljs-string">your certificate request.</span>
<span class="hljs-attr">-----</span>
<span class="hljs-attr">Country</span> <span class="hljs-string">Name (2 letter code) [XX]:GB</span>
<span class="hljs-attr">State</span> <span class="hljs-string">or Province Name []:England</span>
<span class="hljs-attr">Locality</span> <span class="hljs-string">Name []:</span>
<span class="hljs-attr">Organization</span> <span class="hljs-string">Name []:Alice Ltd</span>
<span class="hljs-attr">Organizational</span> <span class="hljs-string">Unit Name []:Alice Ltd Certificate Authority</span>
<span class="hljs-attr">Common</span> <span class="hljs-string">Name []:Alice Ltd Root CA</span>
<span class="hljs-attr">Email</span> <span class="hljs-string">Address []:</span>
<span class="hljs-comment">
# chmod 444 certs/ca.cert.pem</span>
</code></pre>
<h4>验证根证书</h4>
<pre><code class="hljs language-shell"><span class="hljs-meta"># </span><span class="bash">openssl x509 -noout -text -<span class="hljs-keyword">in</span> certs/ca.cert.pem</span>
</code></pre>
<p>输出会显示</p>
<ul>
<li><code>Signature Algorithm</code> 签名算法</li>
<li><code>Validity</code> 证书的有效期</li>
<li><code>Public-Key</code> 公钥长度</li>
<li><code>Issuer</code>, 签发证书的实体</li>
<li><code>Subject</code>, 指向证书自己</li>
</ul>
<p>当 <code>Issuer</code> 和 <code>Subject</code> 相同时, 说明证书是自签名的. 明确所有根证书都是自签名的.</p>
<pre><code class="hljs language-properties"><span class="hljs-attr">Signature</span> <span class="hljs-string">Algorithm: sha256WithRSAEncryption</span>
    <span class="hljs-attr">Issuer</span>: <span class="hljs-string">C=GB, ST=England,</span>
            <span class="hljs-attr">O</span>=<span class="hljs-string">Alice Ltd, OU=Alice Ltd Certificate Authority,</span>
            <span class="hljs-attr">CN</span>=<span class="hljs-string">Alice Ltd Root CA</span>
    <span class="hljs-attr">Validity</span>
        <span class="hljs-attr">Not</span> <span class="hljs-string">Before: Apr 11 12:22:58 2015 GMT</span>
        <span class="hljs-attr">Not</span> <span class="hljs-string">After : Apr  6 12:22:58 2035 GMT</span>
    <span class="hljs-attr">Subject</span>: <span class="hljs-string">C=GB, ST=England,</span>
             <span class="hljs-attr">O</span>=<span class="hljs-string">Alice Ltd, OU=Alice Ltd Certificate Authority,</span>
             <span class="hljs-attr">CN</span>=<span class="hljs-string">Alice Ltd Root CA</span>
    <span class="hljs-attr">Subject</span> <span class="hljs-string">Public Key Info:</span>
        <span class="hljs-attr">Public</span> <span class="hljs-string">Key Algorithm: rsaEncryption</span>
            <span class="hljs-attr">Public-Key</span>: <span class="hljs-string">(4096 bit)</span>
</code></pre>
<p>输出还会显示 <em>X509v3 extensions</em>. 我们创建证书时应用的选项 <code>v3_ca</code>, 所以
<code>[v3_ca]</code> 下的配置项会被反映出来.</p>
<pre><code class="hljs language-apache"><span class="hljs-attribute">X509v3</span> extensions:
    <span class="hljs-attribute">X509v3</span> Subject Key Identifier:
        <span class="hljs-attribute">38</span>:<span class="hljs-number">58</span>:<span class="hljs-number">29</span>:<span class="hljs-number">2</span>F:<span class="hljs-number">6</span>B:<span class="hljs-number">57</span>:<span class="hljs-number">79</span>:<span class="hljs-number">4</span>F:<span class="hljs-number">39</span>:FD:<span class="hljs-number">32</span>:<span class="hljs-number">35</span>:<span class="hljs-number">60</span>:<span class="hljs-number">74</span>:<span class="hljs-number">92</span>:<span class="hljs-number">60</span>:<span class="hljs-number">6</span>E:E8:<span class="hljs-number">2</span>A:<span class="hljs-number">31</span>
    <span class="hljs-attribute">X509v3</span> Authority Key Identifier:
        <span class="hljs-attribute">keyid</span>:<span class="hljs-number">38</span>:<span class="hljs-number">58</span>:<span class="hljs-number">29</span>:<span class="hljs-number">2</span>F:<span class="hljs-number">6</span>B:<span class="hljs-number">57</span>:<span class="hljs-number">79</span>:<span class="hljs-number">4</span>F:<span class="hljs-number">39</span>:FD:<span class="hljs-number">32</span>:<span class="hljs-number">35</span>:<span class="hljs-number">60</span>:<span class="hljs-number">74</span>:<span class="hljs-number">92</span>:<span class="hljs-number">60</span>:<span class="hljs-number">6</span>E:E8:<span class="hljs-number">2</span>A:<span class="hljs-number">31</span>

    <span class="hljs-attribute">X509v3</span> Basic Constraints: critical
        <span class="hljs-attribute">CA</span>:TRUE
    <span class="hljs-attribute">X509v3</span> Key Usage: critical
        <span class="hljs-attribute">Digital</span> Signature, Certificate Sign, CRL Sign
</code></pre>
<h3>创建二级 CA, intermediate pair</h3>
<p>二级 CA 作为 Root CA 代表的实体. Root CA 签署中间证书, 来达成一个信任链.</p>
<p>使用二级 CA 的主要目的是为了安全. 这样 root key 可以被保存在一个离线环境, 并尽可
能少的被使用. 如果二级 CA 的 key 泄漏, root CA 可以废弃二级 CA 证书并创建一个新
的二级密钥对.</p>
<h4>准备目录</h4>
<p>Root CA 文件保存在目录 <code>/root/ca</code> 下. 选择一个不同的目录(
<code>/root/ca/intermediate</code> )来保存二级 CA 文件</p>
<pre><code class="hljs language-shell"><span class="hljs-meta"># </span><span class="bash"><span class="hljs-built_in">mkdir</span> /root/ca/intermediate</span>
</code></pre>
<p>创建和 root CA 相同的目录结构来保存文件. 增加了一个新的目录 <code>csr</code> 来保存证书签名
请求</p>
<pre><code class="hljs language-shell"><span class="hljs-meta"># </span><span class="bash"><span class="hljs-built_in">cd</span> /root/ca/intermediate</span>
<span class="hljs-meta"># </span><span class="bash"><span class="hljs-built_in">mkdir</span> certs crl csr newcerts private</span>
<span class="hljs-meta"># </span><span class="bash"><span class="hljs-built_in">chmod</span> 700 private</span>
<span class="hljs-meta"># </span><span class="bash"><span class="hljs-built_in">touch</span> index.txt</span>
<span class="hljs-meta"># </span><span class="bash"><span class="hljs-built_in">echo</span> 1000 &gt; serial</span>
</code></pre>
<p>添加一个 <code>crlnumber</code> 文件到二级 CA 目录树. 使用 <code>crlnumber</code> 来对证书废除列表
(certificate revocation lists)进行追踪.</p>
<pre><code class="hljs language-gradle"># echo <span class="hljs-number">1000</span> &gt; <span class="hljs-regexp">/root/</span>ca<span class="hljs-regexp">/intermediate/</span>crlnumber
</code></pre>
<p>复制二级 CA 配置文件到 <code>/root/ca/intermediate/openssl.cnf</code> 文件.</p>
<p>二级 CA 配置文件内容:</p>
<pre><code class="hljs language-ini"><span class="hljs-comment"># OpenSSL intermediate CA configuration file.</span>
<span class="hljs-comment"># Copy to `/root/ca/intermediate/openssl.cnf`.</span>

<span class="hljs-section">[ ca ]</span>
<span class="hljs-comment"># `man ca`</span>
<span class="hljs-attr">default_ca</span> = CA_default

<span class="hljs-section">[ CA_default ]</span>
<span class="hljs-comment"># Directory and file locations.</span>
<span class="hljs-attr">dir</span>               = /root/ca/intermediate
<span class="hljs-attr">certs</span>             = <span class="hljs-variable">$dir</span>/certs
<span class="hljs-attr">crl_dir</span>           = <span class="hljs-variable">$dir</span>/crl
<span class="hljs-attr">new_certs_dir</span>     = <span class="hljs-variable">$dir</span>/newcerts
<span class="hljs-attr">database</span>          = <span class="hljs-variable">$dir</span>/index.txt
<span class="hljs-attr">serial</span>            = <span class="hljs-variable">$dir</span>/serial
<span class="hljs-attr">RANDFILE</span>          = <span class="hljs-variable">$dir</span>/private/.rand

<span class="hljs-comment"># The root key and root certificate.</span>
<span class="hljs-attr">private_key</span>       = <span class="hljs-variable">$dir</span>/private/intermediate.key.pem
<span class="hljs-attr">certificate</span>       = <span class="hljs-variable">$dir</span>/certs/intermediate.cert.pem

<span class="hljs-comment"># For certificate revocation lists.</span>
<span class="hljs-attr">crlnumber</span>         = <span class="hljs-variable">$dir</span>/crlnumber
<span class="hljs-attr">crl</span>               = <span class="hljs-variable">$dir</span>/crl/intermediate.crl.pem
<span class="hljs-attr">crl_extensions</span>    = crl_ext
<span class="hljs-attr">default_crl_days</span>  = <span class="hljs-number">30</span>

<span class="hljs-comment"># SHA-1 is deprecated, so use SHA-2 instead.</span>
<span class="hljs-attr">default_md</span>        = sha256

<span class="hljs-attr">name_opt</span>          = ca_default
<span class="hljs-attr">cert_opt</span>          = ca_default
<span class="hljs-attr">default_days</span>      = <span class="hljs-number">375</span>
<span class="hljs-attr">preserve</span>          = <span class="hljs-literal">no</span>
<span class="hljs-attr">policy</span>            = policy_loose

<span class="hljs-section">[ policy_strict ]</span>
<span class="hljs-comment"># The root CA should only sign intermediate certificates that match.</span>
<span class="hljs-comment"># See the POLICY FORMAT section of `man ca`.</span>
<span class="hljs-attr">countryName</span>             = match
<span class="hljs-attr">stateOrProvinceName</span>     = match
<span class="hljs-attr">organizationName</span>        = match
<span class="hljs-attr">organizationalUnitName</span>  = optional
<span class="hljs-attr">commonName</span>              = supplied
<span class="hljs-attr">emailAddress</span>            = optional

<span class="hljs-section">[ policy_loose ]</span>
<span class="hljs-comment"># Allow the intermediate CA to sign a more diverse range of certificates.</span>
<span class="hljs-comment"># See the POLICY FORMAT section of the `ca` man page.</span>
<span class="hljs-attr">countryName</span>             = optional
<span class="hljs-attr">stateOrProvinceName</span>     = optional
<span class="hljs-attr">localityName</span>            = optional
<span class="hljs-attr">organizationName</span>        = optional
<span class="hljs-attr">organizationalUnitName</span>  = optional
<span class="hljs-attr">commonName</span>              = supplied
<span class="hljs-attr">emailAddress</span>            = optional

<span class="hljs-section">[ req ]</span>
<span class="hljs-comment"># Options for the `req` tool (`man req`).</span>
<span class="hljs-attr">default_bits</span>        = <span class="hljs-number">2048</span>
<span class="hljs-attr">distinguished_name</span>  = req_distinguished_name
<span class="hljs-attr">string_mask</span>         = utf8only

<span class="hljs-comment"># SHA-1 is deprecated, so use SHA-2 instead.</span>
<span class="hljs-attr">default_md</span>          = sha256

<span class="hljs-comment"># Extension to add when the -x509 option is used.</span>
<span class="hljs-attr">x509_extensions</span>     = v3_ca

<span class="hljs-section">[ req_distinguished_name ]</span>
<span class="hljs-comment"># See &lt;https://en.wikipedia.org/wiki/Certificate_signing_request&gt;.</span>
<span class="hljs-attr">countryName</span>                     = Country Name (<span class="hljs-number">2</span> letter code)
<span class="hljs-attr">stateOrProvinceName</span>             = State or Province Name
<span class="hljs-attr">localityName</span>                    = Locality Name
<span class="hljs-attr">0.organizationName</span>              = Organization Name
<span class="hljs-attr">organizationalUnitName</span>          = Organizational Unit Name
<span class="hljs-attr">commonName</span>                      = Common Name
<span class="hljs-attr">emailAddress</span>                    = Email Address

<span class="hljs-comment"># Optionally, specify some defaults.</span>
<span class="hljs-attr">countryName_default</span>             = GB
<span class="hljs-attr">stateOrProvinceName_default</span>     = England
<span class="hljs-attr">localityName_default</span>            =
<span class="hljs-attr">0.organizationName_default</span>      = Alice Ltd
<span class="hljs-attr">organizationalUnitName_default</span>  =
<span class="hljs-attr">emailAddress_default</span>            =

<span class="hljs-section">[ v3_ca ]</span>
<span class="hljs-comment"># Extensions for a typical CA (`man x509v3_config`).</span>
<span class="hljs-attr">subjectKeyIdentifier</span> = hash
<span class="hljs-attr">authorityKeyIdentifier</span> = keyid:always,issuer
<span class="hljs-attr">basicConstraints</span> = critical, CA:<span class="hljs-literal">true</span>
<span class="hljs-attr">keyUsage</span> = critical, digitalSignature, cRLSign, keyCertSign

<span class="hljs-section">[ v3_intermediate_ca ]</span>
<span class="hljs-comment"># Extensions for a typical intermediate CA (`man x509v3_config`).</span>
<span class="hljs-attr">subjectKeyIdentifier</span> = hash
<span class="hljs-attr">authorityKeyIdentifier</span> = keyid:always,issuer
<span class="hljs-attr">basicConstraints</span> = critical, CA:<span class="hljs-literal">true</span>, pathlen:<span class="hljs-number">0</span>
<span class="hljs-attr">keyUsage</span> = critical, digitalSignature, cRLSign, keyCertSign

<span class="hljs-section">[ usr_cert ]</span>
<span class="hljs-comment"># Extensions for client certificates (`man x509v3_config`).</span>
<span class="hljs-attr">basicConstraints</span> = CA:<span class="hljs-literal">FALSE</span>
<span class="hljs-attr">nsCertType</span> = client, email
<span class="hljs-attr">nsComment</span> = <span class="hljs-string">&quot;OpenSSL Generated Client Certificate&quot;</span>
<span class="hljs-attr">subjectKeyIdentifier</span> = hash
<span class="hljs-attr">authorityKeyIdentifier</span> = keyid,issuer
<span class="hljs-attr">keyUsage</span> = critical, nonRepudiation, digitalSignature, keyEncipherment
<span class="hljs-attr">extendedKeyUsage</span> = clientAuth, emailProtection

<span class="hljs-section">[ server_cert ]</span>
<span class="hljs-comment"># Extensions for server certificates (`man x509v3_config`).</span>
<span class="hljs-attr">basicConstraints</span> = CA:<span class="hljs-literal">FALSE</span>
<span class="hljs-attr">nsCertType</span> = server
<span class="hljs-attr">nsComment</span> = <span class="hljs-string">&quot;OpenSSL Generated Server Certificate&quot;</span>
<span class="hljs-attr">subjectKeyIdentifier</span> = hash
<span class="hljs-attr">authorityKeyIdentifier</span> = keyid,issuer:always
<span class="hljs-attr">keyUsage</span> = critical, digitalSignature, keyEncipherment
<span class="hljs-attr">extendedKeyUsage</span> = serverAuth

<span class="hljs-section">[ crl_ext ]</span>
<span class="hljs-comment"># Extension for CRLs (`man x509v3_config`).</span>
<span class="hljs-attr">authorityKeyIdentifier</span>=keyid:always

<span class="hljs-section">[ ocsp ]</span>
<span class="hljs-comment"># Extension for OCSP signing certificates (`man ocsp`).</span>
<span class="hljs-attr">basicConstraints</span> = CA:<span class="hljs-literal">FALSE</span>
<span class="hljs-attr">subjectKeyIdentifier</span> = hash
<span class="hljs-attr">authorityKeyIdentifier</span> = keyid,issuer
<span class="hljs-attr">keyUsage</span> = critical, digitalSignature
<span class="hljs-attr">extendedKeyUsage</span> = critical, OCSPSigning
</code></pre>
<p>相对于 root CA, 有 5 个选项发生了变化</p>
<pre><code class="hljs language-ini"><span class="hljs-section">[ CA_default ]</span>
<span class="hljs-attr">dir</span>             = /root/ca/intermediate
<span class="hljs-attr">private_key</span>     = <span class="hljs-variable">$dir</span>/private/intermediate.key.pem
<span class="hljs-attr">certificate</span>     = <span class="hljs-variable">$dir</span>/certs/intermediate.cert.pem
<span class="hljs-attr">crl</span>             = <span class="hljs-variable">$dir</span>/crl/intermediate.crl.pem
<span class="hljs-attr">policy</span>          = policy_loose
</code></pre>
<h4>创建二级 CA 的 Key</h4>
<p>创建二级 CA 的 key( <code>intermediate.key.pem</code> ) 使用 AES 256-bit 来加密并设置强密码
.</p>
<pre><code class="hljs language-angelscript"># cd /root/ca
# openssl genrsa -aes256 \
      -<span class="hljs-keyword">out</span> <span class="hljs-built_in">int</span>ermediate/<span class="hljs-keyword">private</span>/<span class="hljs-built_in">int</span>ermediate.key.pem <span class="hljs-number">4096</span>

Enter pass phrase <span class="hljs-keyword">for</span> <span class="hljs-built_in">int</span>ermediate.key.pem: secretpassword
Verifying - Enter pass phrase <span class="hljs-keyword">for</span> <span class="hljs-built_in">int</span>ermediate.key.pem: secretpassword

# chmod <span class="hljs-number">400</span> <span class="hljs-built_in">int</span>ermediate/<span class="hljs-keyword">private</span>/<span class="hljs-built_in">int</span>ermediate.key.pem
</code></pre>
<h3>创建二级 CA 证书</h3>
<p>使用二级 CA 的 key 来创建证书签名请求(CSR). 详细信息和 CA 大致相同. 尽管如此,
Common Name 选项必须不同.</p>
<pre><code class="hljs language-autohotkey">⚠️警告
确保你指定的配置文件是`intermediate/openssl.cnf`
</code></pre>
<pre><code class="hljs language-properties"><span class="hljs-comment"># cd /root/ca</span>
<span class="hljs-comment"># openssl req -config intermediate/openssl.cnf -new -sha256 \</span>
      <span class="hljs-attr">-key</span> <span class="hljs-string">intermediate/private/intermediate.key.pem \
      -out intermediate/csr/intermediate.csr.pem</span>

<span class="hljs-attr">Enter</span> <span class="hljs-string">pass phrase for intermediate.key.pem: secretpassword</span>
<span class="hljs-attr">You</span> <span class="hljs-string">are about to be asked to enter information that will be incorporated</span>
<span class="hljs-attr">into</span> <span class="hljs-string">your certificate request.</span>
<span class="hljs-attr">-----</span>
<span class="hljs-attr">Country</span> <span class="hljs-string">Name (2 letter code) [XX]:GB</span>
<span class="hljs-attr">State</span> <span class="hljs-string">or Province Name []:England</span>
<span class="hljs-attr">Locality</span> <span class="hljs-string">Name []:</span>
<span class="hljs-attr">Organization</span> <span class="hljs-string">Name []:Alice Ltd</span>
<span class="hljs-attr">Organizational</span> <span class="hljs-string">Unit Name []:Alice Ltd Certificate Authority</span>
<span class="hljs-attr">Common</span> <span class="hljs-string">Name []:Alice Ltd Intermediate CA</span>
<span class="hljs-attr">Email</span> <span class="hljs-string">Address []:</span>
</code></pre>
<p>创建二级 CA 证书, 使用 root CA 签名 CSR 并使用选项 <code>v3_intermediate_ca</code>. 二级证
书需要设置一个比 root CA 证书更短的有效期. 10 年是一个比较好的选项.</p>
<pre><code class="hljs language-properties"><span class="hljs-attr">⚠️警告</span>
<span class="hljs-attr">这次,</span> <span class="hljs-string">指定root CA配置文件`/root/ca/openssl.cnf`</span>
</code></pre>
<pre><code class="hljs language-properties"><span class="hljs-comment"># cd /root/ca</span>
<span class="hljs-comment"># openssl ca -config openssl.cnf -extensions v3_intermediate_ca \</span>
      <span class="hljs-attr">-days</span> <span class="hljs-string">3650 -notext -md sha256 \
      -in intermediate/csr/intermediate.csr.pem \
      -out intermediate/certs/intermediate.cert.pem</span>

<span class="hljs-attr">Enter</span> <span class="hljs-string">pass phrase for ca.key.pem: secretpassword</span>
<span class="hljs-attr">Sign</span> <span class="hljs-string">the certificate? [y/n]: y</span>
<span class="hljs-comment">
# chmod 444 intermediate/certs/intermediate.cert.pem</span>
</code></pre>
<p><code>index.txt</code> 文件是 OpenSSL <code>ca</code> 工具用来保存证书的数据库. 不要删除或手动修改这个
文件. 现在它应该包含了二级 CA 证书的信息</p>
<pre><code class="hljs language-ini">V 250408122707Z 1000 unknown ... /<span class="hljs-attr">CN</span>=Alice Ltd Intermediate CA
</code></pre>
<h4>验证二级 CA 证书</h4>
<p>和验证根证书一样, 使用相同的方式来验证二级 Ca 证书的有效性.</p>
<pre><code class="hljs language-awk"><span class="hljs-comment"># openssl x509 -noout -text \</span>
      -<span class="hljs-keyword">in</span> intermediate<span class="hljs-regexp">/certs/i</span>ntermediate.cert.pem
</code></pre>
<p>验证二级 CA 证书紧靠着根证书. 返回 <code>OK</code> 指示这个信任链是正确的.</p>
<pre><code class="hljs language-stylus"># openssl verify -CAfile certs/ca<span class="hljs-selector-class">.cert</span><span class="hljs-selector-class">.pem</span> \
      intermediate/certs/intermediate<span class="hljs-selector-class">.cert</span><span class="hljs-selector-class">.pem</span>

intermediate<span class="hljs-selector-class">.cert</span><span class="hljs-selector-class">.pem</span>: OK
</code></pre>
<h4>创建证书链文件</h4>
<p>当应用(比如, web 浏览器)尝试去对二级 CA 签名的证书做验证, 它必须也验证根证书和二
级 CA 的信任链. 完成信任链, 就需要创建一个证书链来给应用.</p>
<p>创建证书链, 把二级 CA 证书和根证书连接起来, 我们随后会使用这个文件来演正被二级
CA 证书的签名.</p>
<pre><code class="hljs language-shell"><span class="hljs-meta"># </span><span class="bash"><span class="hljs-built_in">cat</span> intermediate/certs/intermediate.cert.pem \
      certs/ca.cert.pem &gt; intermediate/certs/ca-chain.cert.pem</span>
<span class="hljs-meta"># </span><span class="bash"><span class="hljs-built_in">chmod</span> 444 intermediate/certs/ca-chain.cert.pem</span>
</code></pre>
<pre><code class="hljs language-properties"><span class="hljs-attr">⚠️提示</span>
<span class="hljs-attr">我们的证书链文件必须包含根证书,</span> <span class="hljs-string">因为当前所有的客户端应用都没雨配置这个根证书. 更好的选项是, 比如你是一个内网的管理者, 可以把根证书安装到所有需要验证的客户端. 用这种方式, 证书链文件只需要包含你的二级CA证书</span>
</code></pre>
<h3>签名 Server 和 Client 证书</h3>
<p>我们接下来使用我们的二级 CA 来签名. 你可以在多种情况时使用这些签名证书, 比如创建
安全的浏览器连接, 或者客户端到 server 的认证.</p>
<pre><code class="hljs language-scheme">⚠️注意
接下来的步骤揭示你作为certificate authority(<span class="hljs-name">CA</span>). 第三方, 尽管可以自己创建自己的私钥和证书请求(<span class="hljs-name">CSR</span>), 不需要把它们的私钥(<span class="hljs-name">private</span> key)显示给你. 他们只想你提供CSR, 然后你签署一个签名的证书给他们. 在这种情况下, 忽略`genrsa`和`req`命令.
</code></pre>
<h4>创建 key</h4>
<p>我们的根 CA 和二级 CA 都是 4096bit 的. Server 和 Client 证书通常在一年内失效, 所
以我们安全的使用 2048 位密钥对.</p>
<pre><code class="hljs language-properties"><span class="hljs-attr">⚠️注意</span>
<span class="hljs-attr">尽管4096bits略微安全于2048bits,</span> <span class="hljs-string">它会减慢TLS握手并且显著的增加握手时的处理器负载. 基于这个原因, 大多数websites都适用2048bit密钥对</span>
</code></pre>
<p>如果你为一个 web 服务器(如: Apache)创建密钥对, 你需要在每次重启服务时都输入密码.
可以删除掉 <code>-aes256</code> 选项来创建一个没有密码的 key.</p>
<pre><code class="hljs language-shell"><span class="hljs-meta"># </span><span class="bash"><span class="hljs-built_in">cd</span> /root/ca</span>
<span class="hljs-meta"># </span><span class="bash">openssl genrsa -aes256 \
      -out intermediate/private/www.example.com.key.pem 2048</span>
<span class="hljs-meta"># </span><span class="bash"><span class="hljs-built_in">chmod</span> 400 intermediate/private/www.example.com.key.pem</span>
</code></pre>
<h4>创建证书 certificate</h4>
<p>使用私钥(private key)来创建证书请求(CSR). CSR 详情不需要匹配到二级 CA. 对 Server
证书, 配置的 Common Name 必须是一个 FQDN(full qualified domain name,
如www.example.com), 然而对 Client 证书它可以是任何唯一的识别码(如, 一个邮件地址
). 记住 Comman Name 不能和你的根证书或二级 CA 证书相同.</p>
<pre><code class="hljs language-properties"><span class="hljs-comment"># cd /root/ca</span>
<span class="hljs-comment"># openssl req -config intermediate/openssl.cnf \</span>
      <span class="hljs-attr">-key</span> <span class="hljs-string">intermediate/private/www.example.com.key.pem \
      -new -sha256 -out intermediate/csr/www.example.com.csr.pem</span>

<span class="hljs-attr">Enter</span> <span class="hljs-string">pass phrase for www.example.com.key.pem: secretpassword</span>
<span class="hljs-attr">You</span> <span class="hljs-string">are about to be asked to enter information that will be incorporated</span>
<span class="hljs-attr">into</span> <span class="hljs-string">your certificate request.</span>
<span class="hljs-attr">-----</span>
<span class="hljs-attr">Country</span> <span class="hljs-string">Name (2 letter code) [XX]:US</span>
<span class="hljs-attr">State</span> <span class="hljs-string">or Province Name []:California</span>
<span class="hljs-attr">Locality</span> <span class="hljs-string">Name []:Mountain View</span>
<span class="hljs-attr">Organization</span> <span class="hljs-string">Name []:Alice Ltd</span>
<span class="hljs-attr">Organizational</span> <span class="hljs-string">Unit Name []:Alice Ltd Web Services</span>
<span class="hljs-attr">Common</span> <span class="hljs-string">Name []:www.example.com</span>
<span class="hljs-attr">Email</span> <span class="hljs-string">Address []:</span>
</code></pre>
<p>使用二级 CA 去签名 CSR 来创建一个证书. 如果证书是被用于一个 server, 那么使用
<code>server_cert</code> 扩展. 如果证书时给用户做用户认证, 使用 <code>user_cert</code> 扩展. 证书通常
给予指定一年的有效期, 尽管通常 CA 会额外给于几天时间方便.</p>
<pre><code class="hljs language-stylus"># cd /root/ca
# openssl ca -config intermediate/openssl<span class="hljs-selector-class">.cnf</span> \
      -extensions server_cert -days <span class="hljs-number">375</span> -notext -md sha256 \
      -<span class="hljs-keyword">in</span> intermediate/csr/www<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.com</span><span class="hljs-selector-class">.csr</span><span class="hljs-selector-class">.pem</span> \
      -out intermediate/certs/www<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.com</span><span class="hljs-selector-class">.cert</span><span class="hljs-selector-class">.pem</span>
# chmod <span class="hljs-number">444</span> intermediate/certs/www<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.com</span><span class="hljs-selector-class">.cert</span><span class="hljs-selector-class">.pem</span>
</code></pre>
<p><code>intermediate/index.txt</code> 文件应该会包含一行内容指向新的证书</p>
<pre><code class="hljs language-ini">V 160420124233Z 1000 unknown ... /<span class="hljs-attr">CN</span>=www.example.com
</code></pre>
<h4>验证证书</h4>
<pre><code class="hljs language-stylus"># openssl x509 -noout -text \
      -<span class="hljs-keyword">in</span> intermediate/certs/www<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.com</span><span class="hljs-selector-class">.cert</span><span class="hljs-selector-class">.pem</span>
</code></pre>
<p><em>Issuer</em> 就是二级 CA. <em>Subject</em> 就是证书自己</p>
<pre><code class="hljs language-properties"><span class="hljs-attr">Signature</span> <span class="hljs-string">Algorithm: sha256WithRSAEncryption</span>
    <span class="hljs-attr">Issuer</span>: <span class="hljs-string">C=GB, ST=England,</span>
            <span class="hljs-attr">O</span>=<span class="hljs-string">Alice Ltd, OU=Alice Ltd Certificate Authority,</span>
            <span class="hljs-attr">CN</span>=<span class="hljs-string">Alice Ltd Intermediate CA</span>
    <span class="hljs-attr">Validity</span>
        <span class="hljs-attr">Not</span> <span class="hljs-string">Before: Apr 11 12:42:33 2015 GMT</span>
        <span class="hljs-attr">Not</span> <span class="hljs-string">After : Apr 20 12:42:33 2016 GMT</span>
    <span class="hljs-attr">Subject</span>: <span class="hljs-string">C=US, ST=California, L=Mountain View,</span>
             <span class="hljs-attr">O</span>=<span class="hljs-string">Alice Ltd, OU=Alice Ltd Web Services,</span>
             <span class="hljs-attr">CN</span>=<span class="hljs-string">www.example.com</span>
    <span class="hljs-attr">Subject</span> <span class="hljs-string">Public Key Info:</span>
        <span class="hljs-attr">Public</span> <span class="hljs-string">Key Algorithm: rsaEncryption</span>
            <span class="hljs-attr">Public-Key</span>: <span class="hljs-string">(2048 bit)</span>
</code></pre>
<p>输出会显示 <em>X509v3 extensions</em>. 当创建证书, 选择的是 <code>server_cert</code> 或者
<code>usr_cert</code>. 这个选项的内容就会在这里被反射出来</p>
<pre><code class="hljs language-properties"><span class="hljs-attr">X509v3</span> <span class="hljs-string">extensions:</span>
    <span class="hljs-attr">X509v3</span> <span class="hljs-string">Basic Constraints:</span>
        <span class="hljs-attr">CA</span>:<span class="hljs-string">FALSE</span>
    <span class="hljs-attr">Netscape</span> <span class="hljs-string">Cert Type:</span>
        <span class="hljs-attr">SSL</span> <span class="hljs-string">Server</span>
    <span class="hljs-attr">Netscape</span> <span class="hljs-string">Comment:</span>
        <span class="hljs-attr">OpenSSL</span> <span class="hljs-string">Generated Server Certificate</span>
    <span class="hljs-attr">X509v3</span> <span class="hljs-string">Subject Key Identifier:</span>
        <span class="hljs-attr">B1</span>:<span class="hljs-string">B8:88:48:64:B7:45:52:21:CC:35:37:9E:24:50:EE:AD:58:02:B5</span>
    <span class="hljs-attr">X509v3</span> <span class="hljs-string">Authority Key Identifier:</span>
        <span class="hljs-attr">keyid</span>:<span class="hljs-string">69:E8:EC:54:7F:25:23:60:E5:B6:E7:72:61:F1:D4:B9:21:D4:45:E9</span>
        <span class="hljs-attr">DirName</span>:<span class="hljs-string">/C=GB/ST=England/O=Alice Ltd/OU=Alice Ltd Certificate Authority/CN=Alice Ltd Root CA</span>
        <span class="hljs-attr">serial</span>:<span class="hljs-string">10:00</span>

    <span class="hljs-attr">X509v3</span> <span class="hljs-string">Key Usage: critical</span>
        <span class="hljs-attr">Digital</span> <span class="hljs-string">Signature, Key Encipherment</span>
    <span class="hljs-attr">X509v3</span> <span class="hljs-string">Extended Key Usage:</span>
        <span class="hljs-attr">TLS</span> <span class="hljs-string">Web Server Authentication</span>
</code></pre>
<p>使用之前创建的 CA 证书链文件(ca-chain.cert.pem), 我们可以验证新的证书在被信任链
上是正确的</p>
<pre><code class="hljs language-stylus"># openssl verify -CAfile intermediate/certs/ca-chain<span class="hljs-selector-class">.cert</span><span class="hljs-selector-class">.pem</span> \
      intermediate/certs/www<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.com</span><span class="hljs-selector-class">.cert</span><span class="hljs-selector-class">.pem</span>

www<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.com</span><span class="hljs-selector-class">.cert</span><span class="hljs-selector-class">.pem</span>: OK
</code></pre>
<h4>部署证书</h4>
<p>现在可以讲证书部署到 server, 或者发布证书给客户. 当部署到服务器应用(如, Apache)
时, 你需要确保下边的文件可用:</p>
<ul>
<li><code>ca-chain.cert.pem</code></li>
<li><code>www.example.com.key.pem</code></li>
<li><code>www.example.com.cert.perm</code></li>
</ul>
<p>如果你是给第三方的证书请求(CSR)做签名, 你不需要获取他们的私钥(private key), 所以
你需要返回给他们证书链文件( <code>ca-chain.cert.pem</code> )和证书文件(
<code>www.example.com.cert.pem</code> )</p>
<h4>证书废除列表(Certificate revocation lists)</h4>
<p>证书废除列表(Certificate revocation lists(CRL))提供了一个证书的列表, 表明其中的
证书都是被废除的. 客户端应用, 比如 web 浏览器, 可以使用 CRL 去检查服务器真实性.
服务器应用, 比如 Apache 和 OpenVPN, 可以使用 CRL 来禁止不被信任的客户端的访问.</p>
<p>发布 CRL 到一个可以公开访问的地方(如: <a href="http://example.com/intermediate.crl.pem">http://example.com/intermediate.crl.pem</a>).
第三方可以根据地址获取到 CRL, 他们可以根据这个来检测他们依赖的证书是否被废除.</p>
<pre><code class="hljs language-properties"><span class="hljs-attr">⚠️注意</span>
<span class="hljs-attr">一些应用废除了CRLs,</span> <span class="hljs-string">他们使用在线证书状态协议(Online Certificate Status Protocol (OCSP))来代替.</span>
</code></pre>
<h4>准备配置文件</h4>
<p>当一个 CA 签名证书, 他们通常会写入 CRL 地址到证书里. 添加
<code>crlDistributionPoints</code> 到对应的部分. 在这里, 我们添加到 <code>[server_cert]</code> 部分中</p>
<pre><code class="hljs language-properties"><span class="hljs-attr">[</span> <span class="hljs-string">server_cert ]</span>
<span class="hljs-comment"># ... snipped ...</span>
<span class="hljs-attr">crlDistributionPoints</span> = <span class="hljs-string">URI:http://example.com/intermediate.crl.pem</span>
</code></pre>
<h4>创建 CRL</h4>
<pre><code class="hljs language-shell"><span class="hljs-meta"># </span><span class="bash"><span class="hljs-built_in">cd</span> /root/ca</span>
<span class="hljs-meta"># </span><span class="bash">openssl ca -config intermediate/openssl.cnf \
      -gencrl -out intermediate/crl/intermediate.crl.pem</span>
</code></pre>
<pre><code class="hljs language-properties"><span class="hljs-attr">⚠️注意</span>
<span class="hljs-attr">在ca</span> <span class="hljs-string">man page中的`CRL OPTIONS`部分包含了更多关于如何创建CRLs的信息</span>
</code></pre>
<p>可以使用 <code>crl</code> 工具来检查 CRL 的内容</p>
<pre><code class="hljs language-shell"><span class="hljs-meta"># </span><span class="bash">openssl crl -<span class="hljs-keyword">in</span> intermediate/crl/intermediate.crl.pem -noout -text</span>
</code></pre>
<p>现在没有被吊销的证书, 所以输出是 <code>No Revoked Certificates</code>.</p>
<p>你应该定期的重新创建 CRL. 在默认情况下, CRL 在 30 天后失效. 这个值由
<code>[CA_default]</code> 部分中的 <code>default_crl_days</code> 选项控制.</p>
<h4>吊销证书</h4>
<p>通过一个例子来看看这个过程. Alice 有一个 web 服务器和一个私有的目录存放一些暖心
的可爱小猫图片. Alice 想授权她的朋友 Bob 来访问这个集合.</p>
<p>Bob 创建了一个私钥和证书请求文件 CSR</p>
<pre><code class="hljs language-properties"><span class="hljs-attr">$</span> <span class="hljs-string">cd /home/bob</span>
<span class="hljs-attr">$</span> <span class="hljs-string">openssl genrsa -out bob@example.com.key.pem 2048</span>
<span class="hljs-attr">$</span> <span class="hljs-string">openssl req -new -key bob@example.com.key.pem \
      -out bob@example.com.csr.pem</span>

<span class="hljs-attr">You</span> <span class="hljs-string">are about to be asked to enter information that will be incorporated</span>
<span class="hljs-attr">into</span> <span class="hljs-string">your certificate request.</span>
<span class="hljs-attr">-----</span>
<span class="hljs-attr">Country</span> <span class="hljs-string">Name [XX]:US</span>
<span class="hljs-attr">State</span> <span class="hljs-string">or Province Name []:California</span>
<span class="hljs-attr">Locality</span> <span class="hljs-string">Name []:San Francisco</span>
<span class="hljs-attr">Organization</span> <span class="hljs-string">Name []:Bob Ltd</span>
<span class="hljs-attr">Organizational</span> <span class="hljs-string">Unit Name []:</span>
<span class="hljs-attr">Common</span> <span class="hljs-string">Name []:bob@example.com</span>
<span class="hljs-attr">Email</span> <span class="hljs-string">Address []:</span>
</code></pre>
<p>Bob 发送他的 CSR 给 Alice, Alice 给他签名.</p>
<pre><code class="hljs language-basic"># cd /root/ca
# openssl ca -config intermediate/openssl.cnf \
      -extensions usr_cert -notext -md sha256 \
      -in intermediate/csr/bob@example.<span class="hljs-keyword">com</span>.csr.pem \
      -<span class="hljs-keyword">out</span> intermediate/certs/bob@example.<span class="hljs-keyword">com</span>.cert.pem

Sign the certificate? [y/n]: y
<span class="hljs-symbol">1 </span><span class="hljs-keyword">out</span> of <span class="hljs-number">1</span> certificate requests certified, commit? [y/n]: y
</code></pre>
<p>Alice 验证证书有效</p>
<pre><code class="hljs language-stylus"># openssl verify -CAfile intermediate/certs/ca-chain<span class="hljs-selector-class">.cert</span><span class="hljs-selector-class">.pem</span> \
      intermediate/certs/bob@example<span class="hljs-selector-class">.com</span><span class="hljs-selector-class">.cert</span><span class="hljs-selector-class">.pem</span>

bob@example<span class="hljs-selector-class">.com</span><span class="hljs-selector-class">.cert</span><span class="hljs-selector-class">.pem</span>: OK
</code></pre>
<p><code>index.txt</code> 文件包含一个新的连接</p>
<pre><code class="hljs language-ini">V 160420124740Z 1001 unknown ... /<span class="hljs-attr">CN</span>=bob@example.com
</code></pre>
<p>Alice 发送证书给 Bob. Bob 安装证书到浏览器, 现在可以访问到 Alice 的小猫图片.</p>
<p>坏事, 随着 Bob 的不端行为而来. Bob 把 Alice 的小猫图片发送到了 Hack News, 说了他
是这些的拥有者, 并获得了大量的赞. Alice 发现了这事摒弃要立即吊销他的访问权限.</p>
<pre><code class="hljs language-properties"><span class="hljs-comment"># cd /root/ca</span>
<span class="hljs-comment"># openssl ca -config intermediate/openssl.cnf \</span>
      <span class="hljs-attr">-revoke</span> <span class="hljs-string">intermediate/certs/bob@example.com.cert.pem</span>

<span class="hljs-attr">Enter</span> <span class="hljs-string">pass phrase for intermediate.key.pem: secretpassword</span>
<span class="hljs-attr">Revoking</span> <span class="hljs-string">Certificate 1001.</span>
<span class="hljs-attr">Data</span> <span class="hljs-string">Base Updated</span>
</code></pre>
<p><code>index.txt</code> 中 Bob 的证书这行开始现在使用字符 <code>R</code> 标示, 这表示证书已经被吊销
(Revoked).</p>
<pre><code class="hljs language-apache"><span class="hljs-attribute">R</span> <span class="hljs-number">160420124740</span>Z <span class="hljs-number">150411125310</span>Z <span class="hljs-number">1001</span> unknown ... /CN=bob@example.com
</code></pre>
<p>在吊销了 Bob 的证书后, Alice 必须重新创建 CRL</p>
<h4>服务端使用 CRL</h4>
<p>对于客户端证书, 一般时候服务器应用(如, Apache)来进行验证. 服务应用需要可以访问
CRL.</p>
<p>在 Alice 的例子中, 他可以添加 <code>SSLCARevocationPath</code> 直接到她的 Apache 配置文件中
并复制 CRL 到她的 web 服务器. 下次 Bob 再进行访问时, Apache 会检查他的证书存在于
CRL 中并禁止访问.</p>
<p>相似的, OpenVPN 也使用 <code>crl-verify</code> 指向了被禁用的客户端证书.</p>
<h4>客户端使用 CRL</h4>
<p>对于服务器证书, 一般是由客户端应用(如,浏览器)来进行验证. 这时, 应用必须可以远程
访问 CRL.</p>
<p>如果证书被签名的扩展中包含了 <code>crlDistributionPoints</code>, 客户端应用能够根据地址读取
到 CRL 信息.</p>
<p>CRL 地址信息可以在证书的 x509v3 详情中看到.</p>
<pre><code class="hljs language-properties"><span class="hljs-comment"># openssl x509 -in cute-kitten-pictures.example.com.cert.pem -noout -text</span>

    <span class="hljs-attr">X509v3</span> <span class="hljs-string">CRL Distribution Points:</span>

        <span class="hljs-attr">Full</span> <span class="hljs-string">Name:</span>
          <span class="hljs-attr">URI</span>:<span class="hljs-string">http://example.com/intermediate.crl.pem</span>
</code></pre>
<h3>在线证书状态协议 (Online Certificate Status Protocol)</h3>
<p>在线证书状态协议 (Online Certificate Status Protocol)(OCSP) 被创建用于替代证书吊
销列表(CRL). 和 CRLs 相似, OCSP 运行访问查询出证书的吊销状态.</p>
<p>当服务器签名证书时, 他们一般会包含一个 OSCP 服务器地址(如,
<a href="http://ocsp.example.com)%E5%9C%A8%E8%AF%81%E4%B9%A6%E4%B8%AD">http://ocsp.example.com)在证书中</a>. 这个功能和 CRL 的 <code>crlDistributionPoints</code> 功能
作用相似.</p>
<p>示例, 当 web 浏览器接受到一个服务器证书, 它立即想请求证书中的 OSCP 服务器地址.
在这个地址中, OCSP 响应程序监听请求和响应证书的吊销状态.</p>
<pre><code class="hljs language-properties"><span class="hljs-attr">⚠️注意</span>
  <span class="hljs-attr">虽然推荐尽可能的使用OCSP,</span> <span class="hljs-string">尽管实际上你应该趋向于只需要OCSP来给web站点证书. 一些web浏览器已经废弃或移除了对CRL的支持.</span>
</code></pre>
<h4>准备配置文件</h4>
<p>要使用 OCSP, CA 必须要编码 OCSP 服务器地址到签名的证书中. 使用
<code>authorityInfoAccess</code> 选项到合适的部分, 在这里应该是 <code>[server_cert]</code> 部分</p>
<pre><code class="hljs language-ini"><span class="hljs-section">[ server_cert ]</span>
<span class="hljs-comment"># ... snipped ...</span>
<span class="hljs-attr">authorityInfoAccess</span> = OCSP<span class="hljs-comment">;URI:http://ocsp.example.com</span>
</code></pre>
<h4>创建 OCSP 密钥对</h4>
<p>OCSP 响应程序必须要一个加密密钥对来签名发送给请求的响应内容. OSCP 密钥对必须由和
证书签名相同的 CA 签名.</p>
<p>创建私钥并使用 AES-256 加密</p>
<pre><code class="hljs language-shell"><span class="hljs-meta"># </span><span class="bash"><span class="hljs-built_in">cd</span> /root/ca</span>
<span class="hljs-meta"># </span><span class="bash">openssl genrsa -aes256 \
      -out intermediate/private/ocsp.example.com.key.pem 4096</span>
</code></pre>
<p>创建证书签名请求 CSR. 详细信息默认需要和签名 CA 相同. Common Name, 需要是 FQDN.</p>
<pre><code class="hljs language-properties"><span class="hljs-comment"># cd /root/ca</span>
<span class="hljs-comment"># openssl req -config intermediate/openssl.cnf -new -sha256 \</span>
      <span class="hljs-attr">-key</span> <span class="hljs-string">intermediate/private/ocsp.example.com.key.pem \
      -out intermediate/csr/ocsp.example.com.csr.pem</span>

<span class="hljs-attr">Enter</span> <span class="hljs-string">pass phrase for intermediate.key.pem: secretpassword</span>
<span class="hljs-attr">You</span> <span class="hljs-string">are about to be asked to enter information that will be incorporated</span>
<span class="hljs-attr">into</span> <span class="hljs-string">your certificate request.</span>
<span class="hljs-attr">-----</span>
<span class="hljs-attr">Country</span> <span class="hljs-string">Name (2 letter code) [XX]:GB</span>
<span class="hljs-attr">State</span> <span class="hljs-string">or Province Name []:England</span>
<span class="hljs-attr">Locality</span> <span class="hljs-string">Name []:</span>
<span class="hljs-attr">Organization</span> <span class="hljs-string">Name []:Alice Ltd</span>
<span class="hljs-attr">Organizational</span> <span class="hljs-string">Unit Name []:Alice Ltd Certificate Authority</span>
<span class="hljs-attr">Common</span> <span class="hljs-string">Name []:ocsp.example.com</span>
<span class="hljs-attr">Email</span> <span class="hljs-string">Address []:</span>
</code></pre>
<p>使用 CA 签署 CSR</p>
<pre><code class="hljs language-stylus"># openssl ca -config intermediate/openssl<span class="hljs-selector-class">.cnf</span> \
      -extensions ocsp -days <span class="hljs-number">375</span> -notext -md sha256 \
      -<span class="hljs-keyword">in</span> intermediate/csr/ocsp<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.com</span><span class="hljs-selector-class">.csr</span><span class="hljs-selector-class">.pem</span> \
      -out intermediate/certs/ocsp<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.com</span><span class="hljs-selector-class">.cert</span><span class="hljs-selector-class">.pem</span>
</code></pre>
<p>验证证书的 <em>x509v3 extensions</em> 正确性</p>
<pre><code class="hljs language-properties"><span class="hljs-comment"># openssl x509 -noout -text \</span>
      <span class="hljs-attr">-in</span> <span class="hljs-string">intermediate/certs/ocsp.example.com.cert.pem</span>

    <span class="hljs-attr">X509v3</span> <span class="hljs-string">Key Usage: critical</span>
        <span class="hljs-attr">Digital</span> <span class="hljs-string">Signature</span>
    <span class="hljs-attr">X509v3</span> <span class="hljs-string">Extended Key Usage: critical</span>
        <span class="hljs-attr">OCSP</span> <span class="hljs-string">Signing</span>
</code></pre>
<h4>吊销证书</h4>
<p>OpenSSL 的 <code>ocsp</code> 工具实现了一个 OCSP responder, 但只为了做测试使用. 生产级别的
OCSP responder 也有, 但是超越了这个指引的范围.</p>
<p>创建一个 server 证书测试.</p>
<pre><code class="hljs language-stylus"># cd /root/ca
# openssl genrsa -out intermediate/private/test<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.com</span><span class="hljs-selector-class">.key</span><span class="hljs-selector-class">.pem</span> <span class="hljs-number">2048</span>
# openssl req -config intermediate/openssl<span class="hljs-selector-class">.cnf</span> \
      -key intermediate/private/test<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.com</span><span class="hljs-selector-class">.key</span><span class="hljs-selector-class">.pem</span> \
      -new -sha256 -out intermediate/csr/test<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.com</span><span class="hljs-selector-class">.csr</span><span class="hljs-selector-class">.pem</span>
# openssl ca -config intermediate/openssl<span class="hljs-selector-class">.cnf</span> \
      -extensions server_cert -days <span class="hljs-number">375</span> -notext -md sha256 \
      -<span class="hljs-keyword">in</span> intermediate/csr/test<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.com</span><span class="hljs-selector-class">.csr</span><span class="hljs-selector-class">.pem</span> \
      -out intermediate/certs/test<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.com</span><span class="hljs-selector-class">.cert</span><span class="hljs-selector-class">.pem</span>
</code></pre>
<p>在 <code>localhost</code> 上运行 OCSP responder . 有别于 CRL 保存吊销状态于各个文件中, OCSP
responder 直接读取 <code>index.txt</code> . 响应被 OCSP 密钥对签名(使用 <code>-rkey</code> 和
<code>-rsigner</code> 选项)</p>
<pre><code class="hljs language-stylus"># openssl ocsp -port <span class="hljs-number">127.0</span>.<span class="hljs-number">0.1</span>:<span class="hljs-number">2560</span> -text -sha256 \
      -index intermediate/index<span class="hljs-selector-class">.txt</span> \
      -CA intermediate/certs/ca-chain<span class="hljs-selector-class">.cert</span><span class="hljs-selector-class">.pem</span> \
      -rkey intermediate/private/ocsp<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.com</span><span class="hljs-selector-class">.key</span><span class="hljs-selector-class">.pem</span> \
      -rsigner intermediate/certs/ocsp<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.com</span><span class="hljs-selector-class">.cert</span><span class="hljs-selector-class">.pem</span> \
      -nrequest <span class="hljs-number">1</span>

Enter pass phrase <span class="hljs-keyword">for</span> ocsp<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.com</span><span class="hljs-selector-class">.key</span><span class="hljs-selector-class">.pem</span>: secretpassword
</code></pre>
<p>在另一个终端中, 发送一个请求给 OCSP responder. 指定的 <code>-cert</code> 选项指定了请求的证
书.</p>
<pre><code class="hljs language-stylus"># openssl ocsp -CAfile intermediate/certs/ca-chain<span class="hljs-selector-class">.cert</span><span class="hljs-selector-class">.pem</span> \
      -url http:<span class="hljs-comment">//127.0.0.1:2560 -resp_text \</span>
      -issuer intermediate/certs/intermediate<span class="hljs-selector-class">.cert</span><span class="hljs-selector-class">.pem</span> \
      -cert intermediate/certs/test<span class="hljs-selector-class">.example</span><span class="hljs-selector-class">.com</span><span class="hljs-selector-class">.cert</span><span class="hljs-selector-class">.pem</span>
</code></pre>
<p>开始的输出显示如下:</p>
<ul>
<li>是否接收到成功的响应 (OCSP Response Status)</li>
<li>responder 的身份 (Responder Id)</li>
<li>证书的吊销状态 (Cert Status)</li>
</ul>
<pre><code class="hljs language-properties"><span class="hljs-attr">OCSP</span> <span class="hljs-string">Response Data:</span>
    <span class="hljs-attr">OCSP</span> <span class="hljs-string">Response Status: successful (0x0)</span>
    <span class="hljs-attr">Response</span> <span class="hljs-string">Type: Basic OCSP Response</span>
    <span class="hljs-attr">Version</span>: <span class="hljs-string">1 (0x0)</span>
    <span class="hljs-attr">Responder</span> <span class="hljs-string">Id: ... CN = ocsp.example.com</span>
    <span class="hljs-attr">Produced</span> <span class="hljs-string">At: Apr 11 12:59:51 2015 GMT</span>
    <span class="hljs-attr">Responses</span>:<span class="hljs-string"></span>
    <span class="hljs-attr">Certificate</span> <span class="hljs-string">ID:</span>
      <span class="hljs-attr">Hash</span> <span class="hljs-string">Algorithm: sha1</span>
      <span class="hljs-attr">Issuer</span> <span class="hljs-string">Name Hash: E35979B6D0A973EBE8AEDED75D8C27D67D2A0334</span>
      <span class="hljs-attr">Issuer</span> <span class="hljs-string">Key Hash: 69E8EC547F252360E5B6E77261F1D4B921D445E9</span>
      <span class="hljs-attr">Serial</span> <span class="hljs-string">Number: 1003</span>
    <span class="hljs-attr">Cert</span> <span class="hljs-string">Status: good</span>
    <span class="hljs-attr">This</span> <span class="hljs-string">Update: Apr 11 12:59:51 2015 GMT</span>
</code></pre>
<p>吊销证书</p>
<pre><code class="hljs language-properties"><span class="hljs-comment"># openssl ca -config intermediate/openssl.cnf \</span>
      <span class="hljs-attr">-revoke</span> <span class="hljs-string">intermediate/certs/test.example.com.cert.pem</span>

<span class="hljs-attr">Enter</span> <span class="hljs-string">pass phrase for intermediate.key.pem: secretpassword</span>
<span class="hljs-attr">Revoking</span> <span class="hljs-string">Certificate 1003.</span>
<span class="hljs-attr">Data</span> <span class="hljs-string">Base Updated</span>
</code></pre>
<p>之后, 运行 OCSP responder 并在另一个终端中发请求. 这次, 输出会显示
<code>Cert Status: revoked</code> 和 <code>Revocation Time</code> .</p>
<pre><code class="hljs language-properties"><span class="hljs-attr">OCSP</span> <span class="hljs-string">Response Data:</span>
    <span class="hljs-attr">OCSP</span> <span class="hljs-string">Response Status: successful (0x0)</span>
    <span class="hljs-attr">Response</span> <span class="hljs-string">Type: Basic OCSP Response</span>
    <span class="hljs-attr">Version</span>: <span class="hljs-string">1 (0x0)</span>
    <span class="hljs-attr">Responder</span> <span class="hljs-string">Id: ... CN = ocsp.example.com</span>
    <span class="hljs-attr">Produced</span> <span class="hljs-string">At: Apr 11 13:03:00 2015 GMT</span>
    <span class="hljs-attr">Responses</span>:<span class="hljs-string"></span>
    <span class="hljs-attr">Certificate</span> <span class="hljs-string">ID:</span>
      <span class="hljs-attr">Hash</span> <span class="hljs-string">Algorithm: sha1</span>
      <span class="hljs-attr">Issuer</span> <span class="hljs-string">Name Hash: E35979B6D0A973EBE8AEDED75D8C27D67D2A0334</span>
      <span class="hljs-attr">Issuer</span> <span class="hljs-string">Key Hash: 69E8EC547F252360E5B6E77261F1D4B921D445E9</span>
      <span class="hljs-attr">Serial</span> <span class="hljs-string">Number: 1003</span>
    <span class="hljs-attr">Cert</span> <span class="hljs-string">Status: revoked</span>
    <span class="hljs-attr">Revocation</span> <span class="hljs-string">Time: Apr 11 13:01:09 2015 GMT</span>
    <span class="hljs-attr">This</span> <span class="hljs-string">Update: Apr 11 13:03:00 2015 GMT</span>
</code></pre></div></section></div></section><footer style="margin-top:0" class="css-6haedj"><div class="container"><span id="icp-info" class="css-z2a085">京ICP备20014476号-2</span><span>Copyright © 2017-2021 GSMLG - Powered by GSMLG Web.</span></div></footer></section></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"slug":"openssl-ca","blog":{"author":"Gao","content":"### 简介\n\nOpenSSL 是一款自由开源的加密库, 提供了一些命令行工具来处理数字证书. 其中的一些工\n具可以作为证书权威机构来使用.\n\n证书权威(CA)是一个认证证书实体的证书机构. 许多 Web 站点需要让他们的客户清楚他们\n的连接是安全的, 他们通过向一些国际性的可信 CA(eg. VeriSign, DigiCert)为他们的站\n点去购买一个证书.\n\n在一些时候, 相比于去购买一个证书,更需要去实现一自己的 CA. 通常是需要内部网络使用\n的安全连接, 或者是需要向客户发布一个证书来让他们通过服务器的认证(eg, Apache,\nOpenVPN)\n\n### 创建 root pair\n\n成为一个 CA 意味着需要处理加密密钥对, 私钥和证书. 首先需要第一步创建的是 root\npair. 它包含 root key(ca.key.pem)和 root certificate(ca.cert.pem). 这对迷药就是\nCA 的身份认证.\n\n通常, root CA 不会给任何服务器或客户端签名. root CA 只被用来创建更多的二级 CA,\n二级 CA 被 root CA 签名, 作为 root CA 的代表. 这是最佳实践, 可以让 root key 保持\n离线和尽量少的被使用, 以保证 root key 有最小的泄漏风险.\n\n```\n⚠️注意\n最佳实践是在一个安全的环境里创建root pair. 理想情况下, 在一个完全保密的环境, 并且和互联网完全隔离, 并拔除无线和有线网卡.\n```\n\n#### 准备目录\n\n选择目录来保存所有的 keys 和 certificates\n\n```\n# mkdir /root/ca\n```\n\n创建目录结构. 其中 `index.txt` 和 `serial` 文件是用来保存已经签名证书的记录的文\n件数据库.\n\n```\n# cd /root/ca\n# mkdir certs crl newcerts private\n# chmod 700 private\n# touch index.txt\n# echo 1000 \u003e serial\n```\n\n#### 准备配置文件\n\n我们需要创建一个 OpenSSL 配置文件来使用. 复制 root CA 的配置文件到\n`/root/ca/openssl.cnf`.\n\nroot CA 配置文件\n\n```\n# OpenSSL root CA configuration file.\n# Copy to `/root/ca/openssl.cnf`.\n\n[ ca ]\n# `man ca`\ndefault_ca = CA_default\n\n[ CA_default ]\n# Directory and file locations.\ndir               = /root/ca\ncerts             = $dir/certs\ncrl_dir           = $dir/crl\nnew_certs_dir     = $dir/newcerts\ndatabase          = $dir/index.txt\nserial            = $dir/serial\nRANDFILE          = $dir/private/.rand\n\n# The root key and root certificate.\nprivate_key       = $dir/private/ca.key.pem\ncertificate       = $dir/certs/ca.cert.pem\n\n# For certificate revocation lists.\ncrlnumber         = $dir/crlnumber\ncrl               = $dir/crl/ca.crl.pem\ncrl_extensions    = crl_ext\ndefault_crl_days  = 30\n\n# SHA-1 is deprecated, so use SHA-2 instead.\ndefault_md        = sha256\n\nname_opt          = ca_default\ncert_opt          = ca_default\ndefault_days      = 375\npreserve          = no\npolicy            = policy_strict\n\n[ policy_strict ]\n# The root CA should only sign intermediate certificates that match.\n# See the POLICY FORMAT section of `man ca`.\ncountryName             = match\nstateOrProvinceName     = match\norganizationName        = match\norganizationalUnitName  = optional\ncommonName              = supplied\nemailAddress            = optional\n\n[ policy_loose ]\n# Allow the intermediate CA to sign a more diverse range of certificates.\n# See the POLICY FORMAT section of the `ca` man page.\ncountryName             = optional\nstateOrProvinceName     = optional\nlocalityName            = optional\norganizationName        = optional\norganizationalUnitName  = optional\ncommonName              = supplied\nemailAddress            = optional\n\n[ req ]\n# Options for the `req` tool (`man req`).\ndefault_bits        = 2048\ndistinguished_name  = req_distinguished_name\nstring_mask         = utf8only\n\n# SHA-1 is deprecated, so use SHA-2 instead.\ndefault_md          = sha256\n\n# Extension to add when the -x509 option is used.\nx509_extensions     = v3_ca\n\n[ req_distinguished_name ]\n# See \u003chttps://en.wikipedia.org/wiki/Certificate_signing_request\u003e.\ncountryName                     = Country Name (2 letter code)\nstateOrProvinceName             = State or Province Name\nlocalityName                    = Locality Name\n0.organizationName              = Organization Name\norganizationalUnitName          = Organizational Unit Name\ncommonName                      = Common Name\nemailAddress                    = Email Address\n\n# Optionally, specify some defaults.\ncountryName_default             = GB\nstateOrProvinceName_default     = England\nlocalityName_default            =\n0.organizationName_default      = Alice Ltd\norganizationalUnitName_default  =\nemailAddress_default            =\n\n[ v3_ca ]\n# Extensions for a typical CA (`man x509v3_config`).\nsubjectKeyIdentifier = hash\nauthorityKeyIdentifier = keyid:always,issuer\nbasicConstraints = critical, CA:true\nkeyUsage = critical, digitalSignature, cRLSign, keyCertSign\n\n[ v3_intermediate_ca ]\n# Extensions for a typical intermediate CA (`man x509v3_config`).\nsubjectKeyIdentifier = hash\nauthorityKeyIdentifier = keyid:always,issuer\nbasicConstraints = critical, CA:true, pathlen:0\nkeyUsage = critical, digitalSignature, cRLSign, keyCertSign\n\n[ usr_cert ]\n# Extensions for client certificates (`man x509v3_config`).\nbasicConstraints = CA:FALSE\nnsCertType = client, email\nnsComment = \"OpenSSL Generated Client Certificate\"\nsubjectKeyIdentifier = hash\nauthorityKeyIdentifier = keyid,issuer\nkeyUsage = critical, nonRepudiation, digitalSignature, keyEncipherment\nextendedKeyUsage = clientAuth, emailProtection\n\n[ server_cert ]\n# Extensions for server certificates (`man x509v3_config`).\nbasicConstraints = CA:FALSE\nnsCertType = server\nnsComment = \"OpenSSL Generated Server Certificate\"\nsubjectKeyIdentifier = hash\nauthorityKeyIdentifier = keyid,issuer:always\nkeyUsage = critical, digitalSignature, keyEncipherment\nextendedKeyUsage = serverAuth\n\n[ crl_ext ]\n# Extension for CRLs (`man x509v3_config`).\nauthorityKeyIdentifier=keyid:always\n\n[ ocsp ]\n# Extension for OCSP signing certificates (`man ocsp`).\nbasicConstraints = CA:FALSE\nsubjectKeyIdentifier = hash\nauthorityKeyIdentifier = keyid,issuer\nkeyUsage = critical, digitalSignature\nextendedKeyUsage = critical, OCSPSigning\n```\n\n其中 `[ca]` 部分是必须的. 这里我们告诉 OpenSSL 使用选项 `[CA_default]` 部分\n\n```\n[ ca ]\n# `man ca`\ndefault_ca = CA_default\n```\n\n而 `[CA_default]` 部分包含一类设置配置. 确保之前配置的目录 `/root/ca` 有效\n\n```\n[ CA_default ]\n# Directory and file locations.\ndir               = /root/ca\ncerts             = $dir/certs\ncrl_dir           = $dir/crl\nnew_certs_dir     = $dir/newcerts\ndatabase          = $dir/index.txt\nserial            = $dir/serial\nRANDFILE          = $dir/private/.rand\n\n# The root key and root certificate.\nprivate_key       = $dir/private/ca.key.pem\ncertificate       = $dir/certs/ca.cert.pem\n\n# For certificate revocation lists.\ncrlnumber         = $dir/crlnumber\ncrl               = $dir/crl/ca.crl.pem\ncrl_extensions    = crl_ext\ndefault_crl_days  = 30\n\n# SHA-1 is deprecated, so use SHA-2 instead.\ndefault_md        = sha256\n\nname_opt          = ca_default\ncert_opt          = ca_default\ndefault_days      = 375\npreserve          = no\npolicy            = policy_strict\n```\n\n我们应用 `policy_strict` 到所有的 root CA 签名, 使 root CA 仅被用来创建二级 CA.\n\n```\n[ policy_strict ]\n# The root CA should only sign intermediate certificates that match.\n# See the POLICY FORMAT section of `man ca`.\ncountryName             = match\nstateOrProvinceName     = match\norganizationName        = match\norganizationalUnitName  = optional\ncommonName              = supplied\nemailAddress            = optional\n```\n\n我们应用 `policy_loose` 到所有二级 CA 签名, 二级 CA 会给所有的 Server 和 Client\n签名, 它们会有很多的种类变化.\n\n```\n[ policy_loose ]\n# Allow the intermediate CA to sign a more diverse range of certificates.\n# See the POLICY FORMAT section of the `ca` man page.\ncountryName             = optional\nstateOrProvinceName     = optional\nlocalityName            = optional\norganizationName        = optional\norganizationalUnitName  = optional\ncommonName              = supplied\nemailAddress            = optional\n```\n\n`[req]` 部分会被使用到所有的证书请求和证书创建\n\n```\n[ req ]\n# Options for the `req` tool (`man req`).\ndefault_bits        = 2048\ndistinguished_name  = req_distinguished_name\nstring_mask         = utf8only\n\n# SHA-1 is deprecated, so use SHA-2 instead.\ndefault_md          = sha256\n\n# Extension to add when the -x509 option is used.\nx509_extensions     = v3_ca\n```\n\n`[req_distinguished_name]` 部分包含了一般证书请求签名信息. 可以手动添加一些默认\n值来配置.\n\n```\n[ req_distinguished_name ]\n# See \u003chttps://en.wikipedia.org/wiki/Certificate_signing_request\u003e.\ncountryName                     = Country Name (2 letter code)\nstateOrProvinceName             = State or Province Name\nlocalityName                    = Locality Name\n0.organizationName              = Organization Name\norganizationalUnitName          = Organizational Unit Name\ncommonName                      = Common Name\nemailAddress                    = Email Address\n\n# Optionally, specify some defaults.\ncountryName_default             = GB\nstateOrProvinceName_default     = England\nlocalityName_default            =\n0.organizationName_default      = Alice Ltd\n#organizationalUnitName_default =\n#emailAddress_default           =\n```\n\n之后的几个部分是一些扩展, 这些扩展可以在证书签名的时候使用. 例如: 使用\n`-extensions v3_ca` 命令行参数会应用在 `[v3_ca]` 下的选项.\n\n在创建根证书的时候, 我们使用 `v3_ca`\n\n```\n[ v3_ca ]\n# Extensions for a typical CA (`man x509v3_config`).\nsubjectKeyIdentifier = hash\nauthorityKeyIdentifier = keyid:always,issuer\nbasicConstraints = critical, CA:true\nkeyUsage = critical, digitalSignature, cRLSign, keyCertSign\n```\n\n在创建二级 CA 时, 使用 `v3_intermediate_ca`, 其中额外增加了 `pathlen:0` 来确保二\n级 CA 下可以再创建 CA\n\n```\n[ v3_intermediate_ca ]\n# Extensions for a typical intermediate CA (`man x509v3_config`).\nsubjectKeyIdentifier = hash\nauthorityKeyIdentifier = keyid:always,issuer\nbasicConstraints = critical, CA:true, pathlen:0\nkeyUsage = critical, digitalSignature, cRLSign, keyCertSign\n```\n\n在签发客户端证书时, 我们使用 `usr_cert`, 这些被使用做远程用户认证.\n\n```\n[ usr_cert ]\n# Extensions for client certificates (`man x509v3_config`).\nbasicConstraints = CA:FALSE\nnsCertType = client, email\nnsComment = \"OpenSSL Generated Client Certificate\"\nsubjectKeyIdentifier = hash\nauthorityKeyIdentifier = keyid,issuer\nkeyUsage = critical, nonRepudiation, digitalSignature, keyEncipherment\nextendedKeyUsage = clientAuth, emailProtection\n```\n\n在创建服务器证书时, 使用 `server_cert` 选项, 这些被用于 Web 服务器.\n\n```\n[ server_cert ]\n# Extensions for server certificates (`man x509v3_config`).\nbasicConstraints = CA:FALSE\nnsCertType = server\nnsComment = \"OpenSSL Generated Server Certificate\"\nsubjectKeyIdentifier = hash\nauthorityKeyIdentifier = keyid,issuer:always\nkeyUsage = critical, digitalSignature, keyEncipherment\nextendedKeyUsage = serverAuth\n```\n\n在创建证书废除列表时, `crl_ext` 选项会被自动应用\n\n```\n[ crl_ext ]\n# Extension for CRLs (`man x509v3_config`).\nauthorityKeyIdentifier=keyid:always\n```\n\n在签名在线证书状态协议(Online Certificate Status Protocol (OCSP))证书时, 使用选\n项 `ocsp`\n\n```\n[ ocsp ]\n# Extension for OCSP signing certificates (`man ocsp`).\nbasicConstraints = CA:FALSE\nsubjectKeyIdentifier = hash\nauthorityKeyIdentifier = keyid,issuer\nkeyUsage = critical, digitalSignature\nextendedKeyUsage = critical, OCSPSigning\n```\n\n#### 创建 root key\n\n创建 root key( `ca.key.pem` )并保证它的绝对安全. 任何拥有 root key 的人都可以创\n建受信任的证书. 使用 AES 256-bit 来加密 root key, 并创建一个健壮的密码.\n\n```\n⚠️注意\n使用4096位创建所有的根CA和二级CA的keys.\n你仍然可以使用更短的长度来创建服务器和客户端证书.\n```\n\n```\n# cd /root/ca\n# openssl genrsa -aes256 -out private/ca.key.pem 4096\n\nEnter pass phrase for ca.key.pem: secretpassword\nVerifying - Enter pass phrase for ca.key.pem: secretpassword\n\n# chmod 400 private/ca.key.pem\n```\n\n#### 创建根证书(Root certificate)\n\n使用 root key(ca.key.pem)来创建根证书(ca.cert.pem). 给根证书设置一个比较长的有效\n期, 比如 20 年. 一旦根证书失效, 所有被根证书签名的证书都会失效.\n\n```\n⚠️警告\n当使用`req`工具时, 必须使用`-config`选项来指定一个配置文件, 否则OpenSSL会默认使用`/etc/pki/tls/openssl.cnf`\n```\n\n```\n# cd /root/ca\n# openssl req -config openssl.cnf \\\n      -key private/ca.key.pem \\\n      -new -x509 -days 7300 -sha256 -extensions v3_ca \\\n      -out certs/ca.cert.pem\n\nEnter pass phrase for ca.key.pem: secretpassword\nYou are about to be asked to enter information that will be incorporated\ninto your certificate request.\n-----\nCountry Name (2 letter code) [XX]:GB\nState or Province Name []:England\nLocality Name []:\nOrganization Name []:Alice Ltd\nOrganizational Unit Name []:Alice Ltd Certificate Authority\nCommon Name []:Alice Ltd Root CA\nEmail Address []:\n\n# chmod 444 certs/ca.cert.pem\n```\n\n#### 验证根证书\n\n```\n# openssl x509 -noout -text -in certs/ca.cert.pem\n```\n\n输出会显示\n\n- `Signature Algorithm` 签名算法\n- `Validity` 证书的有效期\n- `Public-Key` 公钥长度\n- `Issuer`, 签发证书的实体\n- `Subject`, 指向证书自己\n\n当 `Issuer` 和 `Subject` 相同时, 说明证书是自签名的. 明确所有根证书都是自签名的.\n\n```\nSignature Algorithm: sha256WithRSAEncryption\n    Issuer: C=GB, ST=England,\n            O=Alice Ltd, OU=Alice Ltd Certificate Authority,\n            CN=Alice Ltd Root CA\n    Validity\n        Not Before: Apr 11 12:22:58 2015 GMT\n        Not After : Apr  6 12:22:58 2035 GMT\n    Subject: C=GB, ST=England,\n             O=Alice Ltd, OU=Alice Ltd Certificate Authority,\n             CN=Alice Ltd Root CA\n    Subject Public Key Info:\n        Public Key Algorithm: rsaEncryption\n            Public-Key: (4096 bit)\n```\n\n输出还会显示 _X509v3 extensions_. 我们创建证书时应用的选项 `v3_ca`, 所以\n`[v3_ca]` 下的配置项会被反映出来.\n\n```\nX509v3 extensions:\n    X509v3 Subject Key Identifier:\n        38:58:29:2F:6B:57:79:4F:39:FD:32:35:60:74:92:60:6E:E8:2A:31\n    X509v3 Authority Key Identifier:\n        keyid:38:58:29:2F:6B:57:79:4F:39:FD:32:35:60:74:92:60:6E:E8:2A:31\n\n    X509v3 Basic Constraints: critical\n        CA:TRUE\n    X509v3 Key Usage: critical\n        Digital Signature, Certificate Sign, CRL Sign\n```\n\n### 创建二级 CA, intermediate pair\n\n二级 CA 作为 Root CA 代表的实体. Root CA 签署中间证书, 来达成一个信任链.\n\n使用二级 CA 的主要目的是为了安全. 这样 root key 可以被保存在一个离线环境, 并尽可\n能少的被使用. 如果二级 CA 的 key 泄漏, root CA 可以废弃二级 CA 证书并创建一个新\n的二级密钥对.\n\n#### 准备目录\n\nRoot CA 文件保存在目录 `/root/ca` 下. 选择一个不同的目录(\n`/root/ca/intermediate` )来保存二级 CA 文件\n\n```\n# mkdir /root/ca/intermediate\n```\n\n创建和 root CA 相同的目录结构来保存文件. 增加了一个新的目录 `csr` 来保存证书签名\n请求\n\n```\n# cd /root/ca/intermediate\n# mkdir certs crl csr newcerts private\n# chmod 700 private\n# touch index.txt\n# echo 1000 \u003e serial\n```\n\n添加一个 `crlnumber` 文件到二级 CA 目录树. 使用 `crlnumber` 来对证书废除列表\n(certificate revocation lists)进行追踪.\n\n```\n# echo 1000 \u003e /root/ca/intermediate/crlnumber\n```\n\n复制二级 CA 配置文件到 `/root/ca/intermediate/openssl.cnf` 文件.\n\n二级 CA 配置文件内容:\n\n```\n# OpenSSL intermediate CA configuration file.\n# Copy to `/root/ca/intermediate/openssl.cnf`.\n\n[ ca ]\n# `man ca`\ndefault_ca = CA_default\n\n[ CA_default ]\n# Directory and file locations.\ndir               = /root/ca/intermediate\ncerts             = $dir/certs\ncrl_dir           = $dir/crl\nnew_certs_dir     = $dir/newcerts\ndatabase          = $dir/index.txt\nserial            = $dir/serial\nRANDFILE          = $dir/private/.rand\n\n# The root key and root certificate.\nprivate_key       = $dir/private/intermediate.key.pem\ncertificate       = $dir/certs/intermediate.cert.pem\n\n# For certificate revocation lists.\ncrlnumber         = $dir/crlnumber\ncrl               = $dir/crl/intermediate.crl.pem\ncrl_extensions    = crl_ext\ndefault_crl_days  = 30\n\n# SHA-1 is deprecated, so use SHA-2 instead.\ndefault_md        = sha256\n\nname_opt          = ca_default\ncert_opt          = ca_default\ndefault_days      = 375\npreserve          = no\npolicy            = policy_loose\n\n[ policy_strict ]\n# The root CA should only sign intermediate certificates that match.\n# See the POLICY FORMAT section of `man ca`.\ncountryName             = match\nstateOrProvinceName     = match\norganizationName        = match\norganizationalUnitName  = optional\ncommonName              = supplied\nemailAddress            = optional\n\n[ policy_loose ]\n# Allow the intermediate CA to sign a more diverse range of certificates.\n# See the POLICY FORMAT section of the `ca` man page.\ncountryName             = optional\nstateOrProvinceName     = optional\nlocalityName            = optional\norganizationName        = optional\norganizationalUnitName  = optional\ncommonName              = supplied\nemailAddress            = optional\n\n[ req ]\n# Options for the `req` tool (`man req`).\ndefault_bits        = 2048\ndistinguished_name  = req_distinguished_name\nstring_mask         = utf8only\n\n# SHA-1 is deprecated, so use SHA-2 instead.\ndefault_md          = sha256\n\n# Extension to add when the -x509 option is used.\nx509_extensions     = v3_ca\n\n[ req_distinguished_name ]\n# See \u003chttps://en.wikipedia.org/wiki/Certificate_signing_request\u003e.\ncountryName                     = Country Name (2 letter code)\nstateOrProvinceName             = State or Province Name\nlocalityName                    = Locality Name\n0.organizationName              = Organization Name\norganizationalUnitName          = Organizational Unit Name\ncommonName                      = Common Name\nemailAddress                    = Email Address\n\n# Optionally, specify some defaults.\ncountryName_default             = GB\nstateOrProvinceName_default     = England\nlocalityName_default            =\n0.organizationName_default      = Alice Ltd\norganizationalUnitName_default  =\nemailAddress_default            =\n\n[ v3_ca ]\n# Extensions for a typical CA (`man x509v3_config`).\nsubjectKeyIdentifier = hash\nauthorityKeyIdentifier = keyid:always,issuer\nbasicConstraints = critical, CA:true\nkeyUsage = critical, digitalSignature, cRLSign, keyCertSign\n\n[ v3_intermediate_ca ]\n# Extensions for a typical intermediate CA (`man x509v3_config`).\nsubjectKeyIdentifier = hash\nauthorityKeyIdentifier = keyid:always,issuer\nbasicConstraints = critical, CA:true, pathlen:0\nkeyUsage = critical, digitalSignature, cRLSign, keyCertSign\n\n[ usr_cert ]\n# Extensions for client certificates (`man x509v3_config`).\nbasicConstraints = CA:FALSE\nnsCertType = client, email\nnsComment = \"OpenSSL Generated Client Certificate\"\nsubjectKeyIdentifier = hash\nauthorityKeyIdentifier = keyid,issuer\nkeyUsage = critical, nonRepudiation, digitalSignature, keyEncipherment\nextendedKeyUsage = clientAuth, emailProtection\n\n[ server_cert ]\n# Extensions for server certificates (`man x509v3_config`).\nbasicConstraints = CA:FALSE\nnsCertType = server\nnsComment = \"OpenSSL Generated Server Certificate\"\nsubjectKeyIdentifier = hash\nauthorityKeyIdentifier = keyid,issuer:always\nkeyUsage = critical, digitalSignature, keyEncipherment\nextendedKeyUsage = serverAuth\n\n[ crl_ext ]\n# Extension for CRLs (`man x509v3_config`).\nauthorityKeyIdentifier=keyid:always\n\n[ ocsp ]\n# Extension for OCSP signing certificates (`man ocsp`).\nbasicConstraints = CA:FALSE\nsubjectKeyIdentifier = hash\nauthorityKeyIdentifier = keyid,issuer\nkeyUsage = critical, digitalSignature\nextendedKeyUsage = critical, OCSPSigning\n```\n\n相对于 root CA, 有 5 个选项发生了变化\n\n```\n[ CA_default ]\ndir             = /root/ca/intermediate\nprivate_key     = $dir/private/intermediate.key.pem\ncertificate     = $dir/certs/intermediate.cert.pem\ncrl             = $dir/crl/intermediate.crl.pem\npolicy          = policy_loose\n```\n\n#### 创建二级 CA 的 Key\n\n创建二级 CA 的 key( `intermediate.key.pem` ) 使用 AES 256-bit 来加密并设置强密码\n.\n\n```\n# cd /root/ca\n# openssl genrsa -aes256 \\\n      -out intermediate/private/intermediate.key.pem 4096\n\nEnter pass phrase for intermediate.key.pem: secretpassword\nVerifying - Enter pass phrase for intermediate.key.pem: secretpassword\n\n# chmod 400 intermediate/private/intermediate.key.pem\n```\n\n### 创建二级 CA 证书\n\n使用二级 CA 的 key 来创建证书签名请求(CSR). 详细信息和 CA 大致相同. 尽管如此,\nCommon Name 选项必须不同.\n\n```\n⚠️警告\n确保你指定的配置文件是`intermediate/openssl.cnf`\n```\n\n```\n# cd /root/ca\n# openssl req -config intermediate/openssl.cnf -new -sha256 \\\n      -key intermediate/private/intermediate.key.pem \\\n      -out intermediate/csr/intermediate.csr.pem\n\nEnter pass phrase for intermediate.key.pem: secretpassword\nYou are about to be asked to enter information that will be incorporated\ninto your certificate request.\n-----\nCountry Name (2 letter code) [XX]:GB\nState or Province Name []:England\nLocality Name []:\nOrganization Name []:Alice Ltd\nOrganizational Unit Name []:Alice Ltd Certificate Authority\nCommon Name []:Alice Ltd Intermediate CA\nEmail Address []:\n```\n\n创建二级 CA 证书, 使用 root CA 签名 CSR 并使用选项 `v3_intermediate_ca`. 二级证\n书需要设置一个比 root CA 证书更短的有效期. 10 年是一个比较好的选项.\n\n```\n⚠️警告\n这次, 指定root CA配置文件`/root/ca/openssl.cnf`\n```\n\n```\n# cd /root/ca\n# openssl ca -config openssl.cnf -extensions v3_intermediate_ca \\\n      -days 3650 -notext -md sha256 \\\n      -in intermediate/csr/intermediate.csr.pem \\\n      -out intermediate/certs/intermediate.cert.pem\n\nEnter pass phrase for ca.key.pem: secretpassword\nSign the certificate? [y/n]: y\n\n# chmod 444 intermediate/certs/intermediate.cert.pem\n```\n\n`index.txt` 文件是 OpenSSL `ca` 工具用来保存证书的数据库. 不要删除或手动修改这个\n文件. 现在它应该包含了二级 CA 证书的信息\n\n```\nV 250408122707Z 1000 unknown ... /CN=Alice Ltd Intermediate CA\n```\n\n#### 验证二级 CA 证书\n\n和验证根证书一样, 使用相同的方式来验证二级 Ca 证书的有效性.\n\n```\n# openssl x509 -noout -text \\\n      -in intermediate/certs/intermediate.cert.pem\n```\n\n验证二级 CA 证书紧靠着根证书. 返回 `OK` 指示这个信任链是正确的.\n\n```\n# openssl verify -CAfile certs/ca.cert.pem \\\n      intermediate/certs/intermediate.cert.pem\n\nintermediate.cert.pem: OK\n```\n\n#### 创建证书链文件\n\n当应用(比如, web 浏览器)尝试去对二级 CA 签名的证书做验证, 它必须也验证根证书和二\n级 CA 的信任链. 完成信任链, 就需要创建一个证书链来给应用.\n\n创建证书链, 把二级 CA 证书和根证书连接起来, 我们随后会使用这个文件来演正被二级\nCA 证书的签名.\n\n```\n# cat intermediate/certs/intermediate.cert.pem \\\n      certs/ca.cert.pem \u003e intermediate/certs/ca-chain.cert.pem\n# chmod 444 intermediate/certs/ca-chain.cert.pem\n```\n\n```\n⚠️提示\n我们的证书链文件必须包含根证书, 因为当前所有的客户端应用都没雨配置这个根证书. 更好的选项是, 比如你是一个内网的管理者, 可以把根证书安装到所有需要验证的客户端. 用这种方式, 证书链文件只需要包含你的二级CA证书\n```\n\n### 签名 Server 和 Client 证书\n\n我们接下来使用我们的二级 CA 来签名. 你可以在多种情况时使用这些签名证书, 比如创建\n安全的浏览器连接, 或者客户端到 server 的认证.\n\n```\n⚠️注意\n接下来的步骤揭示你作为certificate authority(CA). 第三方, 尽管可以自己创建自己的私钥和证书请求(CSR), 不需要把它们的私钥(private key)显示给你. 他们只想你提供CSR, 然后你签署一个签名的证书给他们. 在这种情况下, 忽略`genrsa`和`req`命令.\n```\n\n#### 创建 key\n\n我们的根 CA 和二级 CA 都是 4096bit 的. Server 和 Client 证书通常在一年内失效, 所\n以我们安全的使用 2048 位密钥对.\n\n```\n⚠️注意\n尽管4096bits略微安全于2048bits, 它会减慢TLS握手并且显著的增加握手时的处理器负载. 基于这个原因, 大多数websites都适用2048bit密钥对\n```\n\n如果你为一个 web 服务器(如: Apache)创建密钥对, 你需要在每次重启服务时都输入密码.\n可以删除掉 `-aes256` 选项来创建一个没有密码的 key.\n\n```\n# cd /root/ca\n# openssl genrsa -aes256 \\\n      -out intermediate/private/www.example.com.key.pem 2048\n# chmod 400 intermediate/private/www.example.com.key.pem\n```\n\n#### 创建证书 certificate\n\n使用私钥(private key)来创建证书请求(CSR). CSR 详情不需要匹配到二级 CA. 对 Server\n证书, 配置的 Common Name 必须是一个 FQDN(full qualified domain name,\n如www.example.com), 然而对 Client 证书它可以是任何唯一的识别码(如, 一个邮件地址\n). 记住 Comman Name 不能和你的根证书或二级 CA 证书相同.\n\n```\n# cd /root/ca\n# openssl req -config intermediate/openssl.cnf \\\n      -key intermediate/private/www.example.com.key.pem \\\n      -new -sha256 -out intermediate/csr/www.example.com.csr.pem\n\nEnter pass phrase for www.example.com.key.pem: secretpassword\nYou are about to be asked to enter information that will be incorporated\ninto your certificate request.\n-----\nCountry Name (2 letter code) [XX]:US\nState or Province Name []:California\nLocality Name []:Mountain View\nOrganization Name []:Alice Ltd\nOrganizational Unit Name []:Alice Ltd Web Services\nCommon Name []:www.example.com\nEmail Address []:\n```\n\n使用二级 CA 去签名 CSR 来创建一个证书. 如果证书是被用于一个 server, 那么使用\n`server_cert` 扩展. 如果证书时给用户做用户认证, 使用 `user_cert` 扩展. 证书通常\n给予指定一年的有效期, 尽管通常 CA 会额外给于几天时间方便.\n\n```\n# cd /root/ca\n# openssl ca -config intermediate/openssl.cnf \\\n      -extensions server_cert -days 375 -notext -md sha256 \\\n      -in intermediate/csr/www.example.com.csr.pem \\\n      -out intermediate/certs/www.example.com.cert.pem\n# chmod 444 intermediate/certs/www.example.com.cert.pem\n```\n\n`intermediate/index.txt` 文件应该会包含一行内容指向新的证书\n\n```\nV 160420124233Z 1000 unknown ... /CN=www.example.com\n```\n\n#### 验证证书\n\n```\n# openssl x509 -noout -text \\\n      -in intermediate/certs/www.example.com.cert.pem\n```\n\n_Issuer_ 就是二级 CA. _Subject_ 就是证书自己\n\n```\nSignature Algorithm: sha256WithRSAEncryption\n    Issuer: C=GB, ST=England,\n            O=Alice Ltd, OU=Alice Ltd Certificate Authority,\n            CN=Alice Ltd Intermediate CA\n    Validity\n        Not Before: Apr 11 12:42:33 2015 GMT\n        Not After : Apr 20 12:42:33 2016 GMT\n    Subject: C=US, ST=California, L=Mountain View,\n             O=Alice Ltd, OU=Alice Ltd Web Services,\n             CN=www.example.com\n    Subject Public Key Info:\n        Public Key Algorithm: rsaEncryption\n            Public-Key: (2048 bit)\n```\n\n输出会显示 _X509v3 extensions_. 当创建证书, 选择的是 `server_cert` 或者\n`usr_cert`. 这个选项的内容就会在这里被反射出来\n\n```\nX509v3 extensions:\n    X509v3 Basic Constraints:\n        CA:FALSE\n    Netscape Cert Type:\n        SSL Server\n    Netscape Comment:\n        OpenSSL Generated Server Certificate\n    X509v3 Subject Key Identifier:\n        B1:B8:88:48:64:B7:45:52:21:CC:35:37:9E:24:50:EE:AD:58:02:B5\n    X509v3 Authority Key Identifier:\n        keyid:69:E8:EC:54:7F:25:23:60:E5:B6:E7:72:61:F1:D4:B9:21:D4:45:E9\n        DirName:/C=GB/ST=England/O=Alice Ltd/OU=Alice Ltd Certificate Authority/CN=Alice Ltd Root CA\n        serial:10:00\n\n    X509v3 Key Usage: critical\n        Digital Signature, Key Encipherment\n    X509v3 Extended Key Usage:\n        TLS Web Server Authentication\n```\n\n使用之前创建的 CA 证书链文件(ca-chain.cert.pem), 我们可以验证新的证书在被信任链\n上是正确的\n\n```\n# openssl verify -CAfile intermediate/certs/ca-chain.cert.pem \\\n      intermediate/certs/www.example.com.cert.pem\n\nwww.example.com.cert.pem: OK\n```\n\n#### 部署证书\n\n现在可以讲证书部署到 server, 或者发布证书给客户. 当部署到服务器应用(如, Apache)\n时, 你需要确保下边的文件可用:\n\n- `ca-chain.cert.pem`\n- `www.example.com.key.pem`\n- `www.example.com.cert.perm`\n\n如果你是给第三方的证书请求(CSR)做签名, 你不需要获取他们的私钥(private key), 所以\n你需要返回给他们证书链文件( `ca-chain.cert.pem` )和证书文件(\n`www.example.com.cert.pem` )\n\n#### 证书废除列表(Certificate revocation lists)\n\n证书废除列表(Certificate revocation lists(CRL))提供了一个证书的列表, 表明其中的\n证书都是被废除的. 客户端应用, 比如 web 浏览器, 可以使用 CRL 去检查服务器真实性.\n服务器应用, 比如 Apache 和 OpenVPN, 可以使用 CRL 来禁止不被信任的客户端的访问.\n\n发布 CRL 到一个可以公开访问的地方(如: http://example.com/intermediate.crl.pem).\n第三方可以根据地址获取到 CRL, 他们可以根据这个来检测他们依赖的证书是否被废除.\n\n```\n⚠️注意\n一些应用废除了CRLs, 他们使用在线证书状态协议(Online Certificate Status Protocol (OCSP))来代替.\n```\n\n#### 准备配置文件\n\n当一个 CA 签名证书, 他们通常会写入 CRL 地址到证书里. 添加\n`crlDistributionPoints` 到对应的部分. 在这里, 我们添加到 `[server_cert]` 部分中\n\n```\n[ server_cert ]\n# ... snipped ...\ncrlDistributionPoints = URI:http://example.com/intermediate.crl.pem\n```\n\n#### 创建 CRL\n\n```\n# cd /root/ca\n# openssl ca -config intermediate/openssl.cnf \\\n      -gencrl -out intermediate/crl/intermediate.crl.pem\n```\n\n```\n⚠️注意\n在ca man page中的`CRL OPTIONS`部分包含了更多关于如何创建CRLs的信息\n```\n\n可以使用 `crl` 工具来检查 CRL 的内容\n\n```\n# openssl crl -in intermediate/crl/intermediate.crl.pem -noout -text\n```\n\n现在没有被吊销的证书, 所以输出是 `No Revoked Certificates`.\n\n你应该定期的重新创建 CRL. 在默认情况下, CRL 在 30 天后失效. 这个值由\n`[CA_default]` 部分中的 `default_crl_days` 选项控制.\n\n#### 吊销证书\n\n通过一个例子来看看这个过程. Alice 有一个 web 服务器和一个私有的目录存放一些暖心\n的可爱小猫图片. Alice 想授权她的朋友 Bob 来访问这个集合.\n\nBob 创建了一个私钥和证书请求文件 CSR\n\n```\n$ cd /home/bob\n$ openssl genrsa -out bob@example.com.key.pem 2048\n$ openssl req -new -key bob@example.com.key.pem \\\n      -out bob@example.com.csr.pem\n\nYou are about to be asked to enter information that will be incorporated\ninto your certificate request.\n-----\nCountry Name [XX]:US\nState or Province Name []:California\nLocality Name []:San Francisco\nOrganization Name []:Bob Ltd\nOrganizational Unit Name []:\nCommon Name []:bob@example.com\nEmail Address []:\n```\n\nBob 发送他的 CSR 给 Alice, Alice 给他签名.\n\n```\n# cd /root/ca\n# openssl ca -config intermediate/openssl.cnf \\\n      -extensions usr_cert -notext -md sha256 \\\n      -in intermediate/csr/bob@example.com.csr.pem \\\n      -out intermediate/certs/bob@example.com.cert.pem\n\nSign the certificate? [y/n]: y\n1 out of 1 certificate requests certified, commit? [y/n]: y\n```\n\nAlice 验证证书有效\n\n```\n# openssl verify -CAfile intermediate/certs/ca-chain.cert.pem \\\n      intermediate/certs/bob@example.com.cert.pem\n\nbob@example.com.cert.pem: OK\n```\n\n`index.txt` 文件包含一个新的连接\n\n```\nV 160420124740Z 1001 unknown ... /CN=bob@example.com\n```\n\nAlice 发送证书给 Bob. Bob 安装证书到浏览器, 现在可以访问到 Alice 的小猫图片.\n\n坏事, 随着 Bob 的不端行为而来. Bob 把 Alice 的小猫图片发送到了 Hack News, 说了他\n是这些的拥有者, 并获得了大量的赞. Alice 发现了这事摒弃要立即吊销他的访问权限.\n\n```\n# cd /root/ca\n# openssl ca -config intermediate/openssl.cnf \\\n      -revoke intermediate/certs/bob@example.com.cert.pem\n\nEnter pass phrase for intermediate.key.pem: secretpassword\nRevoking Certificate 1001.\nData Base Updated\n```\n\n`index.txt` 中 Bob 的证书这行开始现在使用字符 `R` 标示, 这表示证书已经被吊销\n(Revoked).\n\n```\nR 160420124740Z 150411125310Z 1001 unknown ... /CN=bob@example.com\n```\n\n在吊销了 Bob 的证书后, Alice 必须重新创建 CRL\n\n#### 服务端使用 CRL\n\n对于客户端证书, 一般时候服务器应用(如, Apache)来进行验证. 服务应用需要可以访问\nCRL.\n\n在 Alice 的例子中, 他可以添加 `SSLCARevocationPath` 直接到她的 Apache 配置文件中\n并复制 CRL 到她的 web 服务器. 下次 Bob 再进行访问时, Apache 会检查他的证书存在于\nCRL 中并禁止访问.\n\n相似的, OpenVPN 也使用 `crl-verify` 指向了被禁用的客户端证书.\n\n#### 客户端使用 CRL\n\n对于服务器证书, 一般是由客户端应用(如,浏览器)来进行验证. 这时, 应用必须可以远程\n访问 CRL.\n\n如果证书被签名的扩展中包含了 `crlDistributionPoints`, 客户端应用能够根据地址读取\n到 CRL 信息.\n\nCRL 地址信息可以在证书的 x509v3 详情中看到.\n\n```\n# openssl x509 -in cute-kitten-pictures.example.com.cert.pem -noout -text\n\n    X509v3 CRL Distribution Points:\n\n        Full Name:\n          URI:http://example.com/intermediate.crl.pem\n```\n\n### 在线证书状态协议 (Online Certificate Status Protocol)\n\n在线证书状态协议 (Online Certificate Status Protocol)(OCSP) 被创建用于替代证书吊\n销列表(CRL). 和 CRLs 相似, OCSP 运行访问查询出证书的吊销状态.\n\n当服务器签名证书时, 他们一般会包含一个 OSCP 服务器地址(如,\nhttp://ocsp.example.com)在证书中. 这个功能和 CRL 的 `crlDistributionPoints` 功能\n作用相似.\n\n示例, 当 web 浏览器接受到一个服务器证书, 它立即想请求证书中的 OSCP 服务器地址.\n在这个地址中, OCSP 响应程序监听请求和响应证书的吊销状态.\n\n```\n⚠️注意\n  虽然推荐尽可能的使用OCSP, 尽管实际上你应该趋向于只需要OCSP来给web站点证书. 一些web浏览器已经废弃或移除了对CRL的支持.\n```\n\n#### 准备配置文件\n\n要使用 OCSP, CA 必须要编码 OCSP 服务器地址到签名的证书中. 使用\n`authorityInfoAccess` 选项到合适的部分, 在这里应该是 `[server_cert]` 部分\n\n```\n[ server_cert ]\n# ... snipped ...\nauthorityInfoAccess = OCSP;URI:http://ocsp.example.com\n```\n\n#### 创建 OCSP 密钥对\n\nOCSP 响应程序必须要一个加密密钥对来签名发送给请求的响应内容. OSCP 密钥对必须由和\n证书签名相同的 CA 签名.\n\n创建私钥并使用 AES-256 加密\n\n```\n# cd /root/ca\n# openssl genrsa -aes256 \\\n      -out intermediate/private/ocsp.example.com.key.pem 4096\n```\n\n创建证书签名请求 CSR. 详细信息默认需要和签名 CA 相同. Common Name, 需要是 FQDN.\n\n```\n# cd /root/ca\n# openssl req -config intermediate/openssl.cnf -new -sha256 \\\n      -key intermediate/private/ocsp.example.com.key.pem \\\n      -out intermediate/csr/ocsp.example.com.csr.pem\n\nEnter pass phrase for intermediate.key.pem: secretpassword\nYou are about to be asked to enter information that will be incorporated\ninto your certificate request.\n-----\nCountry Name (2 letter code) [XX]:GB\nState or Province Name []:England\nLocality Name []:\nOrganization Name []:Alice Ltd\nOrganizational Unit Name []:Alice Ltd Certificate Authority\nCommon Name []:ocsp.example.com\nEmail Address []:\n```\n\n使用 CA 签署 CSR\n\n```\n# openssl ca -config intermediate/openssl.cnf \\\n      -extensions ocsp -days 375 -notext -md sha256 \\\n      -in intermediate/csr/ocsp.example.com.csr.pem \\\n      -out intermediate/certs/ocsp.example.com.cert.pem\n```\n\n验证证书的 _x509v3 extensions_ 正确性\n\n```\n# openssl x509 -noout -text \\\n      -in intermediate/certs/ocsp.example.com.cert.pem\n\n    X509v3 Key Usage: critical\n        Digital Signature\n    X509v3 Extended Key Usage: critical\n        OCSP Signing\n```\n\n#### 吊销证书\n\nOpenSSL 的 `ocsp` 工具实现了一个 OCSP responder, 但只为了做测试使用. 生产级别的\nOCSP responder 也有, 但是超越了这个指引的范围.\n\n创建一个 server 证书测试.\n\n```\n# cd /root/ca\n# openssl genrsa -out intermediate/private/test.example.com.key.pem 2048\n# openssl req -config intermediate/openssl.cnf \\\n      -key intermediate/private/test.example.com.key.pem \\\n      -new -sha256 -out intermediate/csr/test.example.com.csr.pem\n# openssl ca -config intermediate/openssl.cnf \\\n      -extensions server_cert -days 375 -notext -md sha256 \\\n      -in intermediate/csr/test.example.com.csr.pem \\\n      -out intermediate/certs/test.example.com.cert.pem\n```\n\n在 `localhost` 上运行 OCSP responder . 有别于 CRL 保存吊销状态于各个文件中, OCSP\nresponder 直接读取 `index.txt` . 响应被 OCSP 密钥对签名(使用 `-rkey` 和\n`-rsigner` 选项)\n\n```\n# openssl ocsp -port 127.0.0.1:2560 -text -sha256 \\\n      -index intermediate/index.txt \\\n      -CA intermediate/certs/ca-chain.cert.pem \\\n      -rkey intermediate/private/ocsp.example.com.key.pem \\\n      -rsigner intermediate/certs/ocsp.example.com.cert.pem \\\n      -nrequest 1\n\nEnter pass phrase for ocsp.example.com.key.pem: secretpassword\n```\n\n在另一个终端中, 发送一个请求给 OCSP responder. 指定的 `-cert` 选项指定了请求的证\n书.\n\n```\n# openssl ocsp -CAfile intermediate/certs/ca-chain.cert.pem \\\n      -url http://127.0.0.1:2560 -resp_text \\\n      -issuer intermediate/certs/intermediate.cert.pem \\\n      -cert intermediate/certs/test.example.com.cert.pem\n```\n\n开始的输出显示如下:\n\n- 是否接收到成功的响应 (OCSP Response Status)\n- responder 的身份 (Responder Id)\n- 证书的吊销状态 (Cert Status)\n\n```\nOCSP Response Data:\n    OCSP Response Status: successful (0x0)\n    Response Type: Basic OCSP Response\n    Version: 1 (0x0)\n    Responder Id: ... CN = ocsp.example.com\n    Produced At: Apr 11 12:59:51 2015 GMT\n    Responses:\n    Certificate ID:\n      Hash Algorithm: sha1\n      Issuer Name Hash: E35979B6D0A973EBE8AEDED75D8C27D67D2A0334\n      Issuer Key Hash: 69E8EC547F252360E5B6E77261F1D4B921D445E9\n      Serial Number: 1003\n    Cert Status: good\n    This Update: Apr 11 12:59:51 2015 GMT\n```\n\n吊销证书\n\n```\n# openssl ca -config intermediate/openssl.cnf \\\n      -revoke intermediate/certs/test.example.com.cert.pem\n\nEnter pass phrase for intermediate.key.pem: secretpassword\nRevoking Certificate 1003.\nData Base Updated\n```\n\n之后, 运行 OCSP responder 并在另一个终端中发请求. 这次, 输出会显示\n`Cert Status: revoked` 和 `Revocation Time` .\n\n```\nOCSP Response Data:\n    OCSP Response Status: successful (0x0)\n    Response Type: Basic OCSP Response\n    Version: 1 (0x0)\n    Responder Id: ... CN = ocsp.example.com\n    Produced At: Apr 11 13:03:00 2015 GMT\n    Responses:\n    Certificate ID:\n      Hash Algorithm: sha1\n      Issuer Name Hash: E35979B6D0A973EBE8AEDED75D8C27D67D2A0334\n      Issuer Key Hash: 69E8EC547F252360E5B6E77261F1D4B921D445E9\n      Serial Number: 1003\n    Cert Status: revoked\n    Revocation Time: Apr 11 13:01:09 2015 GMT\n    This Update: Apr 11 13:03:00 2015 GMT\n```\n","date":"2021-08-17","id":52,"slug":"openssl-ca","title":"OpenSSL Certificate Authority"},"lightCss":"pre code.hljs{display:block;overflow-x:auto;padding:1em}code.hljs{padding:3px 5px}.hljs{color:#383a42;background:#fafafa}.hljs-comment,.hljs-quote{color:#a0a1a7;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#a626a4}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e45649}.hljs-literal{color:#0184bb}.hljs-addition,.hljs-attribute,.hljs-meta .hljs-string,.hljs-regexp,.hljs-string{color:#50a14f}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#986801}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#4078f2}.hljs-built_in,.hljs-class .hljs-title,.hljs-title.class_{color:#c18401}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}","darkCss":"pre code.hljs{display:block;overflow-x:auto;padding:1em}code.hljs{padding:3px 5px}.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta .hljs-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-built_in,.hljs-class .hljs-title,.hljs-title.class_{color:#e6c07b}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}"},"__N_SSG":true},"page":"/blogs/[slug]","query":{"slug":"openssl-ca"},"buildId":"QNybktfW459stvqkf64RS","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>