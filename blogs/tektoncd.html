<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="minimum-scale=1, initial-scale=1, width=device-width"/><meta name="theme-color" content="#1976d2"/><title>Tekton Pipelines</title><link rel="icon" href="/favicon.ico"/><meta name="next-head-count" content="5"/><meta name="theme-color" content="#1976d2"/><link rel="preload" href="/_next/static/css/b192415249a5ea5e.css" as="style"/><link rel="stylesheet" href="/_next/static/css/b192415249a5ea5e.css" data-n-g=""/><link rel="preload" href="/_next/static/css/c2a527101433f11d.css" as="style"/><link rel="stylesheet" href="/_next/static/css/c2a527101433f11d.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-c67a75d1b6f99dc8.js"></script><script src="/_next/static/chunks/webpack-5779213016bbe4f4.js" defer=""></script><script src="/_next/static/chunks/framework-9812cfa34974cf92.js" defer=""></script><script src="/_next/static/chunks/main-8026441b09170fba.js" defer=""></script><script src="/_next/static/chunks/pages/_app-4069f0536870c530.js" defer=""></script><script src="/_next/static/chunks/9187-56becaf578fab1b0.js" defer=""></script><script src="/_next/static/chunks/6215-c6e71e709c16d6ac.js" defer=""></script><script src="/_next/static/chunks/pages/blogs/%5Bslug%5D-dfacc8e40876f3e9.js" defer=""></script><script src="/_next/static/_8HBxX34UB3LF24lu6poG/_buildManifest.js" defer=""></script><script src="/_next/static/_8HBxX34UB3LF24lu6poG/_ssgManifest.js" defer=""></script><style data-emotion="css-global o6gwfi">html{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;box-sizing:border-box;-webkit-text-size-adjust:100%;}*,*::before,*::after{box-sizing:inherit;}strong,b{font-weight:700;}body{margin:0;color:rgba(0, 0, 0, 0.87);font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:400;font-size:1rem;line-height:1.5;letter-spacing:0.00938em;background-color:#fff;}@media print{body{background-color:#fff;}}body::backdrop{background-color:#fff;}</style><style data-emotion="css 1938ga5 1x7skt0 i6s8oy 1xeyas3 1l1167e 1rzb3uu vubbuv 1mcnwcn 1ikde92 b7766g f2of98 gnirli 9l3uo3 39bbo6 1xqzmcn 6haedj">.css-1938ga5{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;min-height:100vh;width:100%;-webkit-flex:1 1 auto;-ms-flex:1 1 auto;flex:1 1 auto;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;}.css-1x7skt0{background-color:#fff;color:rgba(0, 0, 0, 0.87);-webkit-transition:box-shadow 300ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:box-shadow 300ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;box-shadow:0px 2px 4px -1px rgba(0,0,0,0.2),0px 4px 5px 0px rgba(0,0,0,0.14),0px 1px 10px 0px rgba(0,0,0,0.12);display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:column;-ms-flex-direction:column;flex-direction:column;width:100%;box-sizing:border-box;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;position:static;background-color:#1976d2;color:#fff;}.css-i6s8oy{position:relative;display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;padding-left:16px;padding-right:16px;min-height:56px;}@media (min-width:600px){.css-i6s8oy{padding-left:24px;padding-right:24px;}}@media (min-width:0px){@media (orientation: landscape){.css-i6s8oy{min-height:48px;}}}@media (min-width:600px){.css-i6s8oy{min-height:64px;}}.css-1xeyas3{display:inline-block;width:16px;height:16px;borderradius:8px;margin:0 8px;-webkit-backgroundcolor:transperant;backgroundcolor:transperant;}.css-1l1167e{display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;position:relative;box-sizing:border-box;-webkit-tap-highlight-color:transparent;background-color:transparent;outline:0;border:0;margin:0;border-radius:0;padding:0;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;vertical-align:middle;-moz-appearance:none;-webkit-appearance:none;-webkit-text-decoration:none;text-decoration:none;color:inherit;text-align:center;-webkit-flex:0 0 auto;-ms-flex:0 0 auto;flex:0 0 auto;font-size:1.5rem;padding:8px;border-radius:50%;overflow:visible;color:rgba(0, 0, 0, 0.54);-webkit-transition:background-color 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:background-color 150ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;color:inherit;padding:12px;font-size:1.75rem;}.css-1l1167e::-moz-focus-inner{border-style:none;}.css-1l1167e.Mui-disabled{pointer-events:none;cursor:default;}@media print{.css-1l1167e{-webkit-print-color-adjust:exact;color-adjust:exact;}}.css-1l1167e:hover{background-color:rgba(0, 0, 0, 0.04);}@media (hover: none){.css-1l1167e:hover{background-color:transparent;}}.css-1l1167e.Mui-disabled{background-color:transparent;color:rgba(0, 0, 0, 0.26);}.css-1rzb3uu{position:relative;display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;vertical-align:middle;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;}.css-vubbuv{-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;width:1em;height:1em;display:inline-block;fill:currentColor;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;-webkit-transition:fill 200ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:fill 200ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;font-size:1.5rem;}.css-1mcnwcn{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex-direction:row;-ms-flex-direction:row;flex-direction:row;-webkit-box-flex-wrap:wrap;-webkit-flex-wrap:wrap;-ms-flex-wrap:wrap;flex-wrap:wrap;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;-webkit-align-content:center;-ms-flex-line-pack:center;align-content:center;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;position:absolute;box-sizing:border-box;font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:500;font-size:0.75rem;min-width:20px;line-height:1;padding:0 6px;height:20px;border-radius:10px;z-index:1;-webkit-transition:-webkit-transform 195ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:transform 195ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;top:0;right:0;-webkit-transform:scale(1) translate(50%, -50%);-moz-transform:scale(1) translate(50%, -50%);-ms-transform:scale(1) translate(50%, -50%);transform:scale(1) translate(50%, -50%);transform-origin:100% 0%;}.css-1mcnwcn.MuiBadge-invisible{-webkit-transform:scale(0) translate(50%, -50%);-moz-transform:scale(0) translate(50%, -50%);-ms-transform:scale(0) translate(50%, -50%);transform:scale(0) translate(50%, -50%);}.css-1ikde92{margin:0;font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:400;font-size:1rem;line-height:1.5;letter-spacing:0.00938em;color:inherit;}.css-b7766g{display:-webkit-inline-box;display:-webkit-inline-flex;display:-ms-inline-flexbox;display:inline-flex;-webkit-align-items:center;-webkit-box-align:center;-ms-flex-align:center;align-items:center;-webkit-box-pack:center;-ms-flex-pack:center;-webkit-justify-content:center;justify-content:center;position:relative;box-sizing:border-box;-webkit-tap-highlight-color:transparent;background-color:transparent;outline:0;border:0;margin:0;border-radius:0;padding:0;cursor:pointer;-webkit-user-select:none;-moz-user-select:none;-ms-user-select:none;user-select:none;vertical-align:middle;-moz-appearance:none;-webkit-appearance:none;-webkit-text-decoration:none;text-decoration:none;color:inherit;font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:500;font-size:0.875rem;line-height:1.75;letter-spacing:0.02857em;text-transform:uppercase;min-width:64px;padding:6px 8px;border-radius:4px;-webkit-transition:background-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,box-shadow 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,border-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:background-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,box-shadow 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,border-color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms,color 250ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;color:inherit;border-color:currentColor;}.css-b7766g::-moz-focus-inner{border-style:none;}.css-b7766g.Mui-disabled{pointer-events:none;cursor:default;}@media print{.css-b7766g{-webkit-print-color-adjust:exact;color-adjust:exact;}}.css-b7766g:hover{-webkit-text-decoration:none;text-decoration:none;background-color:rgba(0, 0, 0, 0.04);}@media (hover: none){.css-b7766g:hover{background-color:transparent;}}.css-b7766g.Mui-disabled{color:rgba(0, 0, 0, 0.26);}.css-f2of98{display:-webkit-box;display:-webkit-flex;display:-ms-flexbox;display:flex;-webkit-flex:1 1 auto;-ms-flex:1 1 auto;flex:1 1 auto;}.css-gnirli{background-color:#fff;color:rgba(0, 0, 0, 0.87);-webkit-transition:box-shadow 300ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;transition:box-shadow 300ms cubic-bezier(0.4, 0, 0.2, 1) 0ms;border-radius:4px;box-shadow:0px 2px 4px -1px rgba(0,0,0,0.2),0px 4px 5px 0px rgba(0,0,0,0.14),0px 1px 10px 0px rgba(0,0,0,0.12);-webkit-flex:1;-ms-flex:1;flex:1;padding:24px;margin:24px;}.css-9l3uo3{margin:0;font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:400;font-size:1rem;line-height:1.5;letter-spacing:0.00938em;}.css-39bbo6{margin:0;-webkit-flex-shrink:0;-ms-flex-negative:0;flex-shrink:0;border-width:0;border-style:solid;border-color:rgba(0, 0, 0, 0.12);border-bottom-width:thin;}.css-1xqzmcn pre code.hljs{display:block;overflow-x:auto;padding:1em;}.css-1xqzmcn code.hljs{padding:3px 5px;}.css-1xqzmcn .hljs{color:#383a42;background:#fafafa;}.css-1xqzmcn .hljs-comment,.css-1xqzmcn .hljs-quote{color:#a0a1a7;font-style:italic;}.css-1xqzmcn .hljs-doctag,.css-1xqzmcn .hljs-formula,.css-1xqzmcn .hljs-keyword{color:#a626a4;}.css-1xqzmcn .hljs-deletion,.css-1xqzmcn .hljs-name,.css-1xqzmcn .hljs-section,.css-1xqzmcn .hljs-selector-tag,.css-1xqzmcn .hljs-subst{color:#e45649;}.css-1xqzmcn .hljs-literal{color:#0184bb;}.css-1xqzmcn .hljs-addition,.css-1xqzmcn .hljs-attribute,.css-1xqzmcn .hljs-meta .hljs-string,.css-1xqzmcn .hljs-regexp,.css-1xqzmcn .hljs-string{color:#50a14f;}.css-1xqzmcn .hljs-attr,.css-1xqzmcn .hljs-number,.css-1xqzmcn .hljs-selector-attr,.css-1xqzmcn .hljs-selector-class,.css-1xqzmcn .hljs-selector-pseudo,.css-1xqzmcn .hljs-template-variable,.css-1xqzmcn .hljs-type,.css-1xqzmcn .hljs-variable{color:#986801;}.css-1xqzmcn .hljs-bullet,.css-1xqzmcn .hljs-link,.css-1xqzmcn .hljs-meta,.css-1xqzmcn .hljs-selector-id,.css-1xqzmcn .hljs-symbol,.css-1xqzmcn .hljs-title{color:#4078f2;}.css-1xqzmcn .hljs-built_in,.css-1xqzmcn .hljs-class .hljs-title,.css-1xqzmcn .hljs-title.class_{color:#c18401;}.css-1xqzmcn .hljs-emphasis{font-style:italic;}.css-1xqzmcn .hljs-strong{font-weight:700;}.css-1xqzmcn .hljs-link{-webkit-text-decoration:underline;text-decoration:underline;}.css-6haedj{line-height:2em;text-align:center;margin-top:0.5em;color:#fff;background-color:#1976d2;}</style></head><body><div id="__next"><main class="css-1938ga5"><header class="MuiPaper-root MuiPaper-elevation MuiPaper-elevation4 MuiAppBar-root MuiAppBar-colorPrimary MuiAppBar-positionStatic css-1x7skt0"><div class="MuiToolbar-root MuiToolbar-gutters MuiToolbar-regular css-i6s8oy"><div class="css-1xeyas3"></div><button class="MuiButtonBase-root MuiIconButton-root MuiIconButton-colorInherit MuiIconButton-sizeLarge css-1l1167e" tabindex="0" type="button" aria-label="Menu"><span class="MuiBadge-root css-1rzb3uu"><svg class="MuiSvgIcon-root MuiSvgIcon-fontSizeMedium css-vubbuv" focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="MenuIcon"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"></path></svg><span class="MuiBadge-badge MuiBadge-standard MuiBadge-invisible MuiBadge-anchorOriginTopRight MuiBadge-anchorOriginTopRightRectangular MuiBadge-overlapRectangular css-1mcnwcn"></span></span></button><p class="MuiTypography-root MuiTypography-body1 css-1ikde92" type="title"><button class="MuiButtonBase-root MuiButton-root MuiButton-text MuiButton-textInherit MuiButton-sizeMedium MuiButton-textSizeMedium MuiButton-colorInherit MuiButton-root MuiButton-text MuiButton-textInherit MuiButton-sizeMedium MuiButton-textSizeMedium MuiButton-colorInherit css-b7766g" tabindex="0" type="button"><a href="/">Home</a></button><button class="MuiButtonBase-root MuiButton-root MuiButton-text MuiButton-textInherit MuiButton-sizeMedium MuiButton-textSizeMedium MuiButton-colorInherit MuiButton-root MuiButton-text MuiButton-textInherit MuiButton-sizeMedium MuiButton-textSizeMedium MuiButton-colorInherit css-b7766g" tabindex="0" type="button"><a href="/blogs">Blog</a></button><button class="MuiButtonBase-root MuiButton-root MuiButton-text MuiButton-textInherit MuiButton-sizeMedium MuiButton-textSizeMedium MuiButton-colorInherit MuiButton-root MuiButton-text MuiButton-textInherit MuiButton-sizeMedium MuiButton-textSizeMedium MuiButton-colorInherit css-b7766g" tabindex="0" type="button"><a href="/presentations">Presentation</a></button><button class="MuiButtonBase-root MuiButton-root MuiButton-text MuiButton-textInherit MuiButton-sizeMedium MuiButton-textSizeMedium MuiButton-colorInherit MuiButton-root MuiButton-text MuiButton-textInherit MuiButton-sizeMedium MuiButton-textSizeMedium MuiButton-colorInherit css-b7766g" tabindex="0" type="button"><a href="/tools">Tool</a></button></p></div></header><div class="css-f2of98"><div class="MuiPaper-root MuiPaper-elevation MuiPaper-rounded MuiPaper-elevation4 css-gnirli"><header><h1 class="MuiTypography-root MuiTypography-body1 css-9l3uo3">Tekton Pipelines</h1><div class="MuiTypography-root MuiTypography-body1 css-9l3uo3">Author:<!-- -->Gao</div><div class="MuiTypography-root MuiTypography-body1 css-9l3uo3">Created At:<!-- -->2020-01-04</div></header><hr class="MuiDivider-root MuiDivider-fullWidth css-39bbo6"/><section class="MuiTypography-root MuiTypography-body1 blog-content css-9l3uo3"><div class="css-1xqzmcn"><h1>Tekton Pipelines</h1>
<h2>Intro</h2>
<p>Tekton Pipelines 是一个为<code>Kubernetes</code>应用程序配置和运行<code>CI / CD</code>风格
的<code>Pipelined</code>的开源实现</p>
<p><code>Pipeline</code> 创建 <code>Custom Resources</code> 作为构建模块来声明<code>pipelines</code></p>
<p>Tekton Pipelines 是云原生的</p>
<ul>
<li>运行于<code>Kubernetes</code></li>
<li>将<code>Kubernetes</code>集群作为一级资源类型</li>
<li>使用容器作为构建块</li>
</ul>
<p>Tekton Pipelines 是解耦的</p>
<ul>
<li>Pipeline 可以被部署于任意 k8s 集群</li>
<li>组成<code>pipeline</code>的<code>task</code>可以分开独立运行</li>
<li>向 Git repos 之类的资源可以轻松的在运行之间交换</li>
</ul>
<p>Tekton Pipelines are Typed</p>
<ul>
<li>类型化的资源意味着对于诸如 Image 之类的资源，可以轻松地将资源输出</li>
</ul>
<h3>此设计的高级细节：</h3>
<ul>
<li>Pipeline 运行管道，可以实现一个流程，可以由事件出发，也可以通过<code>PipelineRun</code>来
运行</li>
<li>Task 基本运行单元，可以通过<code>TaskRun</code>来运行</li>
<li>PipelineResource <code>Task</code>的输入和输出资源</li>
</ul>
<h2>各类资源介绍</h2>
<h3>PipelineResources</h3>
<p><code>PipelineResource</code> 是 <code>Pipline</code> 中 <code>Task</code> 的输入和输出对象</p>
<p>Syntax:</p>
<p>To define a configuration file for a PipelineResource, you can specify the
following fields:</p>
<ul>
<li>Required:<!-- -->
<ul>
<li>apiVersion - Specifies the API version, for example tekton.dev/v1alpha1.</li>
<li>kind - Specify the PipelineResource resource object.</li>
<li>metadata - Specifies data to uniquely identify the PipelineResource object,
for example a name.</li>
<li>spec - Specifies the configuration information for your PipelineResource
resource object.</li>
<li>type - Specifies the type of the PipelineResource</li>
</ul>
</li>
<li>Optional:<!-- -->
<ul>
<li>params - Parameters which are specific to each type of PipelineResource</li>
</ul>
</li>
</ul>
<p>Types:</p>
<ul>
<li>Git</li>
<li>PullRequest</li>
<li>Image</li>
<li>Cluster</li>
<li>Storage</li>
<li>CloutEvent</li>
</ul>
<h3>Tasks</h3>
<p>Task(or ClusterTask) 是 CI 中一个组顺序执行的 step 的集合，是基本任务单位。Task
会在 pod 中运行。</p>
<p>Task 需要声明三部分：</p>
<ul>
<li>inputs</li>
<li>outputs</li>
<li>steps</li>
</ul>
<p>Task 在 namespace 中可用，ClusterTask 在整个集群可用</p>
<p>Syntax:</p>
<p>To define a configuration file for a Task resource, you can specify the
following fields:</p>
<ul>
<li>Required:<!-- -->
<ul>
<li>apiVersion - Specifies the API version, for example tekton.dev/v1alpha1.</li>
<li>kind - Specify the Task resource object.</li>
<li>metadata - Specifies data to uniquely identify the Task resource object, for
example a name.</li>
<li>spec - Specifies the configuration information for your Task resource
object. Task steps must be defined through either of the following fields:
-steps - Specifies one or more container images that you want to run in your
Task.</li>
</ul>
</li>
<li>Optional:<!-- -->
<ul>
<li>inputs - Specifies parameters and PipelineResources needed by your Task</li>
<li>outputs - Specifies PipelineResources created by your Task</li>
<li>volumes - Specifies one or more volumes that you want to make available to
your Task&#x27;s steps.</li>
<li>stepTemplate - Specifies a Container step definition to use as the basis for
all steps within your Task.</li>
<li>sidecars - Specifies sidecar containers to run alongside steps.</li>
</ul>
</li>
</ul>
<h3>Piplines</h3>
<p>Pipline 定义并执行一组 Task</p>
<p>Syntax:</p>
<p>To define a configuration file for a Pipeline resource, you can specify the
following fields:</p>
<ul>
<li>Required:<!-- -->
<ul>
<li>apiVersion - Specifies the API version, for example tekton.dev/v1alpha1.</li>
<li>kind - Specify the Pipeline resource object.</li>
<li>metadata - Specifies data to uniquely identify the Pipeline resource object,
for example a name.</li>
<li>spec - Specifies the configuration information for your Pipeline resource
object. In order for a Pipeline to do anything, the spec must include:<!-- -->
<ul>
<li>tasks - Specifies which Tasks to run and how to run them</li>
</ul>
</li>
</ul>
</li>
<li>Optional:<!-- -->
<ul>
<li>resources - Specifies which PipelineResources of which types the Pipeline
will be using in its Tasks</li>
<li>tasks<!-- -->
<ul>
<li>resources.inputs / resource.outputs<!-- -->
<ul>
<li>from - Used when the content of the PipelineResource should come from
the output of a previous Pipeline Task</li>
<li>runAfter - Used when the Pipeline Task should be executed after another
Pipeline Task, but there is no output linking required</li>
<li>retries - Used when the task is wanted to be executed if it fails. Could
be a network error or a missing dependency. It does not apply to
cancellations.</li>
<li>conditions - Used when a task is to be executed only if the specified
conditions are evaluated to be true.</li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>Task 执行顺序，所有 Task 默认都会并行执行，除非指定了</p>
<ul>
<li>from</li>
<li>runAfter 两项会指定 task 执行的依赖关系</li>
</ul>
<p>For example see this Pipeline spec:</p>
<pre><code class="hljs language-yaml"><span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">lint-repo</span>
  <span class="hljs-attr">taskRef:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">pylint</span>
  <span class="hljs-attr">resources:</span>
    <span class="hljs-attr">inputs:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">workspace</span>
        <span class="hljs-attr">resource:</span> <span class="hljs-string">my-repo</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">test-app</span>
  <span class="hljs-attr">taskRef:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">make-test</span>
  <span class="hljs-attr">resources:</span>
    <span class="hljs-attr">inputs:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">workspace</span>
        <span class="hljs-attr">resource:</span> <span class="hljs-string">my-repo</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">build-app</span>
  <span class="hljs-attr">taskRef:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">kaniko-build-app</span>
  <span class="hljs-attr">runAfter:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">test-app</span>
  <span class="hljs-attr">resources:</span>
    <span class="hljs-attr">inputs:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">workspace</span>
        <span class="hljs-attr">resource:</span> <span class="hljs-string">my-repo</span>
    <span class="hljs-attr">outputs:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">image</span>
        <span class="hljs-attr">resource:</span> <span class="hljs-string">my-app-image</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">build-frontend</span>
  <span class="hljs-attr">taskRef:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">kaniko-build-frontend</span>
  <span class="hljs-attr">runAfter:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-string">test-app</span>
  <span class="hljs-attr">resources:</span>
    <span class="hljs-attr">inputs:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">workspace</span>
        <span class="hljs-attr">resource:</span> <span class="hljs-string">my-repo</span>
    <span class="hljs-attr">outputs:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">image</span>
        <span class="hljs-attr">resource:</span> <span class="hljs-string">my-frontend-image</span>
<span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">deploy-all</span>
  <span class="hljs-attr">taskRef:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">deploy-kubectl</span>
  <span class="hljs-attr">resources:</span>
    <span class="hljs-attr">inputs:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">my-app-image</span>
        <span class="hljs-attr">resource:</span> <span class="hljs-string">my-app-image</span>
        <span class="hljs-attr">from:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-string">build-app</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">my-frontend-image</span>
        <span class="hljs-attr">resource:</span> <span class="hljs-string">my-frontend-image</span>
        <span class="hljs-attr">from:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-string">build-frontend</span>
</code></pre>
<p>This will result in the following execution graph:</p>
<pre><code class="hljs language-none">        |            |
        v            v
     test-app    lint-repo
    /        \
   v          v
build-app  build-frontend
   \          /
    v        v
    deploy-all
</code></pre>
<h2>安装</h2>
<p>运行 kubectl 安装指定的 yaml 文件</p>
<pre><code class="hljs language-shell">kubectl apply -f https://raw.githubusercontent.com/gsmlg/pipeline/master/updated.yaml
</code></pre>
<p>检查所有 pod 都处于<code>running</code>状态时，安装完成</p>
<pre><code class="hljs language-shell">kubectl -n tekton-pipelines get pods
</code></pre>
<p>安装 dashboard，更方便的查看 pipeline</p>
<pre><code class="hljs language-shell">kubectl apply -f https://raw.githubusercontent.com/gsmlg/pipeline/master/updated_dashboard.yaml
</code></pre>
<h2>演示运行一个<code>singlecloud</code>的构建过程</h2>
<p>创建账户</p>
<pre><code class="hljs language-yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">rbac.authorization.k8s.io/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterRole</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">pipeline-run-role</span>
<span class="hljs-attr">rules:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">apiGroups:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">extensions</span>
    <span class="hljs-attr">resources:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">deployments</span>
    <span class="hljs-attr">verbs:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">get</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">list</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">watch</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">create</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">update</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">patch</span>
      <span class="hljs-bullet">-</span> <span class="hljs-string">delete</span>

<span class="hljs-meta">---</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">rbac.authorization.k8s.io/v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterRoleBinding</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">pipeline-run-binding</span>
<span class="hljs-attr">roleRef:</span>
  <span class="hljs-attr">apiGroup:</span> <span class="hljs-string">rbac.authorization.k8s.io</span>
  <span class="hljs-attr">kind:</span> <span class="hljs-string">ClusterRole</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">pipeline-run-role</span>
<span class="hljs-attr">subjects:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">kind:</span> <span class="hljs-string">ServiceAccount</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">pipeline-run-service</span>
    <span class="hljs-attr">namespace:</span> <span class="hljs-string">default</span>

<span class="hljs-meta">---</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">ServiceAccount</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">pipeline-run-service</span>
  <span class="hljs-attr">namespace:</span> <span class="hljs-string">default</span>
<span class="hljs-attr">secrets:</span>
  <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">regcred</span>

<span class="hljs-meta">---</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">v1</span>
<span class="hljs-attr">data:</span>
  <span class="hljs-string">.dockerconfigjson:</span> <span class="hljs-string">&lt;encoded</span> <span class="hljs-string">docker</span> <span class="hljs-string">registry</span> <span class="hljs-string">auth</span> <span class="hljs-string">data&gt;</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Secret</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">regcred</span>
  <span class="hljs-attr">namespace:</span> <span class="hljs-string">default</span>
<span class="hljs-attr">type:</span> <span class="hljs-string">kubernetes.io/dockerconfigjson</span>
</code></pre>
<p>定义资源</p>
<pre><code class="hljs language-yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">tekton.dev/v1alpha1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">PipelineResource</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">zcloud-image</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">type:</span> <span class="hljs-string">image</span>
  <span class="hljs-attr">params:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">url</span>
      <span class="hljs-attr">value:</span> <span class="hljs-string">docker.io/gsmlg/zcloud</span>
</code></pre>
<p>创建 task</p>
<pre><code class="hljs language-yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">tekton.dev/v1alpha1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Task</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">build-image-from-git</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">inputs:</span>
    <span class="hljs-attr">resources:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">docker-source</span>
        <span class="hljs-attr">type:</span> <span class="hljs-string">git</span>
    <span class="hljs-attr">params:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">pathToDockerFile</span>
        <span class="hljs-attr">type:</span> <span class="hljs-string">string</span>
        <span class="hljs-attr">description:</span> <span class="hljs-string">The</span> <span class="hljs-string">path</span> <span class="hljs-string">to</span> <span class="hljs-string">the</span> <span class="hljs-string">dockerfile</span> <span class="hljs-string">to</span> <span class="hljs-string">build</span>
        <span class="hljs-attr">default:</span> <span class="hljs-string">/workspace/docker-source/Dockerfile</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">pathToContext</span>
        <span class="hljs-attr">type:</span> <span class="hljs-string">string</span>
        <span class="hljs-attr">description:</span>
          <span class="hljs-string">The</span> <span class="hljs-string">build</span> <span class="hljs-string">context</span> <span class="hljs-string">used</span> <span class="hljs-string">by</span> <span class="hljs-string">Kaniko</span>
          <span class="hljs-string">(https://github.com/GoogleContainerTools/kaniko#kaniko-build-contexts)</span>
        <span class="hljs-attr">default:</span> <span class="hljs-string">/workspace/docker-source</span>
  <span class="hljs-attr">outputs:</span>
    <span class="hljs-attr">resources:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">builtImage</span>
        <span class="hljs-attr">type:</span> <span class="hljs-string">image</span>
  <span class="hljs-attr">steps:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">build-and-push</span>
      <span class="hljs-attr">image:</span> <span class="hljs-string">registry.zdns.cn/gsmlg/kaniko-project-executor:v0.13.0</span>
      <span class="hljs-comment"># specifying DOCKER_CONFIG is required to allow kaniko to detect docker credential</span>
      <span class="hljs-attr">env:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">&#x27;DOCKER_CONFIG&#x27;</span>
          <span class="hljs-attr">value:</span> <span class="hljs-string">&#x27;/builder/home/.docker/&#x27;</span>
      <span class="hljs-attr">command:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">/kaniko/executor</span>
      <span class="hljs-attr">args:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">--dockerfile=$(inputs.params.pathToDockerFile)</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">--destination=$(outputs.resources.builtImage.url)</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">--context=$(inputs.params.pathToContext)</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">--oci-layout-path=/builder/home/image-outputs/builtImage</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">--skip-tls-verify</span>

<span class="hljs-meta">---</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">tekton.dev/v1alpha1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Task</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">build-zcloud</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">inputs:</span>
    <span class="hljs-attr">resources:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">docker-source</span>
        <span class="hljs-attr">type:</span> <span class="hljs-string">git</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">image</span>
        <span class="hljs-attr">type:</span> <span class="hljs-string">image</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">uiImage</span>
        <span class="hljs-attr">type:</span> <span class="hljs-string">image</span>
    <span class="hljs-attr">params:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">pathToDockerFile</span>
        <span class="hljs-attr">type:</span> <span class="hljs-string">string</span>
        <span class="hljs-attr">description:</span> <span class="hljs-string">The</span> <span class="hljs-string">path</span> <span class="hljs-string">to</span> <span class="hljs-string">the</span> <span class="hljs-string">dockerfile</span> <span class="hljs-string">to</span> <span class="hljs-string">build</span>
        <span class="hljs-attr">default:</span> <span class="hljs-string">/workspace/docker-source/Dockerfile</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">pathToContext</span>
        <span class="hljs-attr">type:</span> <span class="hljs-string">string</span>
        <span class="hljs-attr">description:</span>
          <span class="hljs-string">The</span> <span class="hljs-string">build</span> <span class="hljs-string">context</span> <span class="hljs-string">used</span> <span class="hljs-string">by</span> <span class="hljs-string">Kaniko</span>
          <span class="hljs-string">(https://github.com/GoogleContainerTools/kaniko#kaniko-build-contexts)</span>
        <span class="hljs-attr">default:</span> <span class="hljs-string">/workspace/docker-source</span>
  <span class="hljs-attr">outputs:</span>
    <span class="hljs-attr">resources:</span>
      <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">builtImage</span>
        <span class="hljs-attr">type:</span> <span class="hljs-string">image</span>
  <span class="hljs-attr">steps:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">setup-dockerfile</span>
      <span class="hljs-attr">image:</span> <span class="hljs-string">docker.io/ubuntu:18.04</span>
      <span class="hljs-attr">command:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">/workspace/docker-source/setup.sh</span>
      <span class="hljs-attr">args:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">$(inputs.resources.image.url)</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">$(inputs.resources.uiImage.url)</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">/workspace/docker-source/Dockerfile</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">build-and-push</span>
      <span class="hljs-attr">image:</span> <span class="hljs-string">registry.zdns.cn/gsmlg/kaniko-project-executor:v0.13.0</span>
      <span class="hljs-comment"># specifying DOCKER_CONFIG is required to allow kaniko to detect docker credential</span>
      <span class="hljs-attr">env:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">&#x27;DOCKER_CONFIG&#x27;</span>
          <span class="hljs-attr">value:</span> <span class="hljs-string">&#x27;/builder/home/.docker/&#x27;</span>
      <span class="hljs-attr">command:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">/kaniko/executor</span>
      <span class="hljs-attr">args:</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">--dockerfile=$(inputs.params.pathToDockerFile)</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">--destination=$(outputs.resources.builtImage.url)</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">--context=$(inputs.params.pathToContext)</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">--oci-layout-path=/builder/home/image-outputs/builtImage</span>
        <span class="hljs-bullet">-</span> <span class="hljs-string">--skip-tls-verify</span>

<span class="hljs-meta">---</span>
<span class="hljs-attr">apiVersion:</span> <span class="hljs-string">tekton.dev/v1alpha1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">Pipeline</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">name:</span> <span class="hljs-string">zcloud-build-pipeline</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">resources:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">singlecloud-repo</span>
      <span class="hljs-attr">type:</span> <span class="hljs-string">git</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">singlecloud-ui-repo</span>
      <span class="hljs-attr">type:</span> <span class="hljs-string">git</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">zcloud-repo</span>
      <span class="hljs-attr">type:</span> <span class="hljs-string">git</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">singlecloud-image</span>
      <span class="hljs-attr">type:</span> <span class="hljs-string">image</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">singlecloud-ui-image</span>
      <span class="hljs-attr">type:</span> <span class="hljs-string">image</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">zcloud-image</span>
      <span class="hljs-attr">type:</span> <span class="hljs-string">image</span>
  <span class="hljs-attr">tasks:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">build-singlecloud-ui</span>
      <span class="hljs-attr">retries:</span> <span class="hljs-number">1</span>
      <span class="hljs-attr">taskRef:</span>
        <span class="hljs-attr">name:</span> <span class="hljs-string">build-image-from-git</span>
      <span class="hljs-attr">resources:</span>
        <span class="hljs-attr">inputs:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">docker-source</span>
            <span class="hljs-attr">resource:</span> <span class="hljs-string">singlecloud-ui-repo</span>
        <span class="hljs-attr">outputs:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">builtImage</span>
            <span class="hljs-attr">resource:</span> <span class="hljs-string">singlecloud-ui-image</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">build-singlecloud</span>
      <span class="hljs-attr">taskRef:</span>
        <span class="hljs-attr">name:</span> <span class="hljs-string">build-image-from-git</span>
      <span class="hljs-attr">resources:</span>
        <span class="hljs-attr">inputs:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">docker-source</span>
            <span class="hljs-attr">resource:</span> <span class="hljs-string">singlecloud-repo</span>
        <span class="hljs-attr">outputs:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">builtImage</span>
            <span class="hljs-attr">resource:</span> <span class="hljs-string">singlecloud-image</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">build-zcloud</span>
      <span class="hljs-attr">taskRef:</span>
        <span class="hljs-attr">name:</span> <span class="hljs-string">build-zcloud</span>
      <span class="hljs-attr">resources:</span>
        <span class="hljs-attr">inputs:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">docker-source</span>
            <span class="hljs-attr">resource:</span> <span class="hljs-string">zcloud-repo</span>
          <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">uiImage</span>
            <span class="hljs-attr">resource:</span> <span class="hljs-string">singlecloud-ui-image</span>
            <span class="hljs-attr">from:</span>
              <span class="hljs-bullet">-</span> <span class="hljs-string">build-singlecloud-ui</span>
          <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">image</span>
            <span class="hljs-attr">resource:</span> <span class="hljs-string">singlecloud-image</span>
            <span class="hljs-attr">from:</span>
              <span class="hljs-bullet">-</span> <span class="hljs-string">build-singlecloud</span>
        <span class="hljs-attr">outputs:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">builtImage</span>
            <span class="hljs-attr">resource:</span> <span class="hljs-string">zcloud-image</span>
</code></pre>
<p>运行 pipelinue:</p>
<pre><code class="hljs language-yaml"><span class="hljs-attr">apiVersion:</span> <span class="hljs-string">tekton.dev/v1alpha1</span>
<span class="hljs-attr">kind:</span> <span class="hljs-string">PipelineRun</span>
<span class="hljs-attr">metadata:</span>
  <span class="hljs-attr">generateName:</span> <span class="hljs-string">zcloud-build-run-</span>
<span class="hljs-attr">spec:</span>
  <span class="hljs-attr">pipelineRef:</span>
    <span class="hljs-attr">name:</span> <span class="hljs-string">zcloud-build-pipeline</span>
  <span class="hljs-attr">serviceAccount:</span> <span class="hljs-string">pipeline-run-service</span>
  <span class="hljs-attr">resources:</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">singlecloud-repo</span>
      <span class="hljs-attr">resourceSpec:</span>
        <span class="hljs-attr">type:</span> <span class="hljs-string">git</span>
        <span class="hljs-attr">params:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">revision</span>
            <span class="hljs-attr">value:</span> <span class="hljs-string">master</span>
          <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">url</span>
            <span class="hljs-attr">value:</span> <span class="hljs-string">https://github.com/zdnscloud/singlecloud</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">singlecloud-ui-repo</span>
      <span class="hljs-attr">resourceSpec:</span>
        <span class="hljs-attr">type:</span> <span class="hljs-string">git</span>
        <span class="hljs-attr">params:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">revision</span>
            <span class="hljs-attr">value:</span> <span class="hljs-string">master</span>
          <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">url</span>
            <span class="hljs-attr">value:</span> <span class="hljs-string">https://github.com/zdnscloud/singlecloud-ui</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">zcloud-repo</span>
      <span class="hljs-attr">resourceSpec:</span>
        <span class="hljs-attr">type:</span> <span class="hljs-string">git</span>
        <span class="hljs-attr">params:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">revision</span>
            <span class="hljs-attr">value:</span> <span class="hljs-string">master</span>
          <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">url</span>
            <span class="hljs-attr">value:</span> <span class="hljs-string">https://github.com/gsmlg/zcloud-image</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">singlecloud-image</span>
      <span class="hljs-attr">resourceSpec:</span>
        <span class="hljs-attr">type:</span> <span class="hljs-string">image</span>
        <span class="hljs-attr">params:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">url</span>
            <span class="hljs-attr">value:</span> <span class="hljs-string">registry.zdns.cn/zcloud/singlecloud:master</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">singlecloud-ui-image</span>
      <span class="hljs-attr">resourceSpec:</span>
        <span class="hljs-attr">type:</span> <span class="hljs-string">image</span>
        <span class="hljs-attr">params:</span>
          <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">url</span>
            <span class="hljs-attr">value:</span> <span class="hljs-string">registry.zdns.cn/zcloud/singlecloud-ui:master</span>
    <span class="hljs-bullet">-</span> <span class="hljs-attr">name:</span> <span class="hljs-string">zcloud-image</span>
      <span class="hljs-attr">resourceRef:</span>
        <span class="hljs-attr">name:</span> <span class="hljs-string">zcloud-image</span>
</code></pre></div></section></div></div><footer style="margin-top:0" class="css-6haedj"><div class="container"><span>Copyright © 2017-2023 GSMLG - Powered by GSMLG Web.</span></div></footer></main></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"slug":"tektoncd","blog":{"author":"Gao","content":"# Tekton Pipelines\n\n## Intro\n\nTekton Pipelines 是一个为`Kubernetes`应用程序配置和运行`CI / CD`风格\n的`Pipelined`的开源实现\n\n`Pipeline` 创建 `Custom Resources` 作为构建模块来声明`pipelines`\n\nTekton Pipelines 是云原生的\n\n- 运行于`Kubernetes`\n- 将`Kubernetes`集群作为一级资源类型\n- 使用容器作为构建块\n\nTekton Pipelines 是解耦的\n\n- Pipeline 可以被部署于任意 k8s 集群\n- 组成`pipeline`的`task`可以分开独立运行\n- 向 Git repos 之类的资源可以轻松的在运行之间交换\n\nTekton Pipelines are Typed\n\n- 类型化的资源意味着对于诸如 Image 之类的资源，可以轻松地将资源输出\n\n### 此设计的高级细节：\n\n- Pipeline 运行管道，可以实现一个流程，可以由事件出发，也可以通过`PipelineRun`来\n  运行\n- Task 基本运行单元，可以通过`TaskRun`来运行\n- PipelineResource `Task`的输入和输出资源\n\n## 各类资源介绍\n\n### PipelineResources\n\n`PipelineResource` 是 `Pipline` 中 `Task` 的输入和输出对象\n\nSyntax:\n\nTo define a configuration file for a PipelineResource, you can specify the\nfollowing fields:\n\n- Required:\n  - apiVersion - Specifies the API version, for example tekton.dev/v1alpha1.\n  - kind - Specify the PipelineResource resource object.\n  - metadata - Specifies data to uniquely identify the PipelineResource object,\n    for example a name.\n  - spec - Specifies the configuration information for your PipelineResource\n    resource object.\n  - type - Specifies the type of the PipelineResource\n- Optional:\n  - params - Parameters which are specific to each type of PipelineResource\n\nTypes:\n\n- Git\n- PullRequest\n- Image\n- Cluster\n- Storage\n- CloutEvent\n\n### Tasks\n\nTask(or ClusterTask) 是 CI 中一个组顺序执行的 step 的集合，是基本任务单位。Task\n会在 pod 中运行。\n\nTask 需要声明三部分：\n\n- inputs\n- outputs\n- steps\n\nTask 在 namespace 中可用，ClusterTask 在整个集群可用\n\nSyntax:\n\nTo define a configuration file for a Task resource, you can specify the\nfollowing fields:\n\n- Required:\n  - apiVersion - Specifies the API version, for example tekton.dev/v1alpha1.\n  - kind - Specify the Task resource object.\n  - metadata - Specifies data to uniquely identify the Task resource object, for\n    example a name.\n  - spec - Specifies the configuration information for your Task resource\n    object. Task steps must be defined through either of the following fields:\n    -steps - Specifies one or more container images that you want to run in your\n    Task.\n- Optional:\n  - inputs - Specifies parameters and PipelineResources needed by your Task\n  - outputs - Specifies PipelineResources created by your Task\n  - volumes - Specifies one or more volumes that you want to make available to\n    your Task's steps.\n  - stepTemplate - Specifies a Container step definition to use as the basis for\n    all steps within your Task.\n  - sidecars - Specifies sidecar containers to run alongside steps.\n\n### Piplines\n\nPipline 定义并执行一组 Task\n\nSyntax:\n\nTo define a configuration file for a Pipeline resource, you can specify the\nfollowing fields:\n\n- Required:\n  - apiVersion - Specifies the API version, for example tekton.dev/v1alpha1.\n  - kind - Specify the Pipeline resource object.\n  - metadata - Specifies data to uniquely identify the Pipeline resource object,\n    for example a name.\n  - spec - Specifies the configuration information for your Pipeline resource\n    object. In order for a Pipeline to do anything, the spec must include:\n    - tasks - Specifies which Tasks to run and how to run them\n- Optional:\n  - resources - Specifies which PipelineResources of which types the Pipeline\n    will be using in its Tasks\n  - tasks\n    - resources.inputs / resource.outputs\n      - from - Used when the content of the PipelineResource should come from\n        the output of a previous Pipeline Task\n      - runAfter - Used when the Pipeline Task should be executed after another\n        Pipeline Task, but there is no output linking required\n      - retries - Used when the task is wanted to be executed if it fails. Could\n        be a network error or a missing dependency. It does not apply to\n        cancellations.\n      - conditions - Used when a task is to be executed only if the specified\n        conditions are evaluated to be true.\n\nTask 执行顺序，所有 Task 默认都会并行执行，除非指定了\n\n- from\n- runAfter 两项会指定 task 执行的依赖关系\n\nFor example see this Pipeline spec:\n\n```yaml\n- name: lint-repo\n  taskRef:\n    name: pylint\n  resources:\n    inputs:\n      - name: workspace\n        resource: my-repo\n- name: test-app\n  taskRef:\n    name: make-test\n  resources:\n    inputs:\n      - name: workspace\n        resource: my-repo\n- name: build-app\n  taskRef:\n    name: kaniko-build-app\n  runAfter:\n    - test-app\n  resources:\n    inputs:\n      - name: workspace\n        resource: my-repo\n    outputs:\n      - name: image\n        resource: my-app-image\n- name: build-frontend\n  taskRef:\n    name: kaniko-build-frontend\n  runAfter:\n    - test-app\n  resources:\n    inputs:\n      - name: workspace\n        resource: my-repo\n    outputs:\n      - name: image\n        resource: my-frontend-image\n- name: deploy-all\n  taskRef:\n    name: deploy-kubectl\n  resources:\n    inputs:\n      - name: my-app-image\n        resource: my-app-image\n        from:\n          - build-app\n      - name: my-frontend-image\n        resource: my-frontend-image\n        from:\n          - build-frontend\n```\n\nThis will result in the following execution graph:\n\n```none\n        |            |\n        v            v\n     test-app    lint-repo\n    /        \\\n   v          v\nbuild-app  build-frontend\n   \\          /\n    v        v\n    deploy-all\n```\n\n## 安装\n\n运行 kubectl 安装指定的 yaml 文件\n\n```shell\nkubectl apply -f https://raw.githubusercontent.com/gsmlg/pipeline/master/updated.yaml\n```\n\n检查所有 pod 都处于`running`状态时，安装完成\n\n```shell\nkubectl -n tekton-pipelines get pods\n```\n\n安装 dashboard，更方便的查看 pipeline\n\n```shell\nkubectl apply -f https://raw.githubusercontent.com/gsmlg/pipeline/master/updated_dashboard.yaml\n```\n\n## 演示运行一个`singlecloud`的构建过程\n\n创建账户\n\n```yaml\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRole\nmetadata:\n  name: pipeline-run-role\nrules:\n  - apiGroups:\n      - extensions\n    resources:\n      - deployments\n    verbs:\n      - get\n      - list\n      - watch\n      - create\n      - update\n      - patch\n      - delete\n\n---\napiVersion: rbac.authorization.k8s.io/v1\nkind: ClusterRoleBinding\nmetadata:\n  name: pipeline-run-binding\nroleRef:\n  apiGroup: rbac.authorization.k8s.io\n  kind: ClusterRole\n  name: pipeline-run-role\nsubjects:\n  - kind: ServiceAccount\n    name: pipeline-run-service\n    namespace: default\n\n---\napiVersion: v1\nkind: ServiceAccount\nmetadata:\n  name: pipeline-run-service\n  namespace: default\nsecrets:\n  - name: regcred\n\n---\napiVersion: v1\ndata:\n  .dockerconfigjson: \u003cencoded docker registry auth data\u003e\nkind: Secret\nmetadata:\n  name: regcred\n  namespace: default\ntype: kubernetes.io/dockerconfigjson\n```\n\n定义资源\n\n```yaml\napiVersion: tekton.dev/v1alpha1\nkind: PipelineResource\nmetadata:\n  name: zcloud-image\nspec:\n  type: image\n  params:\n    - name: url\n      value: docker.io/gsmlg/zcloud\n```\n\n创建 task\n\n```yaml\napiVersion: tekton.dev/v1alpha1\nkind: Task\nmetadata:\n  name: build-image-from-git\nspec:\n  inputs:\n    resources:\n      - name: docker-source\n        type: git\n    params:\n      - name: pathToDockerFile\n        type: string\n        description: The path to the dockerfile to build\n        default: /workspace/docker-source/Dockerfile\n      - name: pathToContext\n        type: string\n        description:\n          The build context used by Kaniko\n          (https://github.com/GoogleContainerTools/kaniko#kaniko-build-contexts)\n        default: /workspace/docker-source\n  outputs:\n    resources:\n      - name: builtImage\n        type: image\n  steps:\n    - name: build-and-push\n      image: registry.zdns.cn/gsmlg/kaniko-project-executor:v0.13.0\n      # specifying DOCKER_CONFIG is required to allow kaniko to detect docker credential\n      env:\n        - name: 'DOCKER_CONFIG'\n          value: '/builder/home/.docker/'\n      command:\n        - /kaniko/executor\n      args:\n        - --dockerfile=$(inputs.params.pathToDockerFile)\n        - --destination=$(outputs.resources.builtImage.url)\n        - --context=$(inputs.params.pathToContext)\n        - --oci-layout-path=/builder/home/image-outputs/builtImage\n        - --skip-tls-verify\n\n---\napiVersion: tekton.dev/v1alpha1\nkind: Task\nmetadata:\n  name: build-zcloud\nspec:\n  inputs:\n    resources:\n      - name: docker-source\n        type: git\n      - name: image\n        type: image\n      - name: uiImage\n        type: image\n    params:\n      - name: pathToDockerFile\n        type: string\n        description: The path to the dockerfile to build\n        default: /workspace/docker-source/Dockerfile\n      - name: pathToContext\n        type: string\n        description:\n          The build context used by Kaniko\n          (https://github.com/GoogleContainerTools/kaniko#kaniko-build-contexts)\n        default: /workspace/docker-source\n  outputs:\n    resources:\n      - name: builtImage\n        type: image\n  steps:\n    - name: setup-dockerfile\n      image: docker.io/ubuntu:18.04\n      command:\n        - /workspace/docker-source/setup.sh\n      args:\n        - $(inputs.resources.image.url)\n        - $(inputs.resources.uiImage.url)\n        - /workspace/docker-source/Dockerfile\n    - name: build-and-push\n      image: registry.zdns.cn/gsmlg/kaniko-project-executor:v0.13.0\n      # specifying DOCKER_CONFIG is required to allow kaniko to detect docker credential\n      env:\n        - name: 'DOCKER_CONFIG'\n          value: '/builder/home/.docker/'\n      command:\n        - /kaniko/executor\n      args:\n        - --dockerfile=$(inputs.params.pathToDockerFile)\n        - --destination=$(outputs.resources.builtImage.url)\n        - --context=$(inputs.params.pathToContext)\n        - --oci-layout-path=/builder/home/image-outputs/builtImage\n        - --skip-tls-verify\n\n---\napiVersion: tekton.dev/v1alpha1\nkind: Pipeline\nmetadata:\n  name: zcloud-build-pipeline\nspec:\n  resources:\n    - name: singlecloud-repo\n      type: git\n    - name: singlecloud-ui-repo\n      type: git\n    - name: zcloud-repo\n      type: git\n    - name: singlecloud-image\n      type: image\n    - name: singlecloud-ui-image\n      type: image\n    - name: zcloud-image\n      type: image\n  tasks:\n    - name: build-singlecloud-ui\n      retries: 1\n      taskRef:\n        name: build-image-from-git\n      resources:\n        inputs:\n          - name: docker-source\n            resource: singlecloud-ui-repo\n        outputs:\n          - name: builtImage\n            resource: singlecloud-ui-image\n    - name: build-singlecloud\n      taskRef:\n        name: build-image-from-git\n      resources:\n        inputs:\n          - name: docker-source\n            resource: singlecloud-repo\n        outputs:\n          - name: builtImage\n            resource: singlecloud-image\n    - name: build-zcloud\n      taskRef:\n        name: build-zcloud\n      resources:\n        inputs:\n          - name: docker-source\n            resource: zcloud-repo\n          - name: uiImage\n            resource: singlecloud-ui-image\n            from:\n              - build-singlecloud-ui\n          - name: image\n            resource: singlecloud-image\n            from:\n              - build-singlecloud\n        outputs:\n          - name: builtImage\n            resource: zcloud-image\n```\n\n运行 pipelinue:\n\n```yaml\napiVersion: tekton.dev/v1alpha1\nkind: PipelineRun\nmetadata:\n  generateName: zcloud-build-run-\nspec:\n  pipelineRef:\n    name: zcloud-build-pipeline\n  serviceAccount: pipeline-run-service\n  resources:\n    - name: singlecloud-repo\n      resourceSpec:\n        type: git\n        params:\n          - name: revision\n            value: master\n          - name: url\n            value: https://github.com/zdnscloud/singlecloud\n    - name: singlecloud-ui-repo\n      resourceSpec:\n        type: git\n        params:\n          - name: revision\n            value: master\n          - name: url\n            value: https://github.com/zdnscloud/singlecloud-ui\n    - name: zcloud-repo\n      resourceSpec:\n        type: git\n        params:\n          - name: revision\n            value: master\n          - name: url\n            value: https://github.com/gsmlg/zcloud-image\n    - name: singlecloud-image\n      resourceSpec:\n        type: image\n        params:\n          - name: url\n            value: registry.zdns.cn/zcloud/singlecloud:master\n    - name: singlecloud-ui-image\n      resourceSpec:\n        type: image\n        params:\n          - name: url\n            value: registry.zdns.cn/zcloud/singlecloud-ui:master\n    - name: zcloud-image\n      resourceRef:\n        name: zcloud-image\n```\n","date":"2020-01-04","id":29,"slug":"tektoncd","title":"Tekton Pipelines"},"lightCss":"pre code.hljs{display:block;overflow-x:auto;padding:1em}code.hljs{padding:3px 5px}.hljs{color:#383a42;background:#fafafa}.hljs-comment,.hljs-quote{color:#a0a1a7;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#a626a4}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e45649}.hljs-literal{color:#0184bb}.hljs-addition,.hljs-attribute,.hljs-meta .hljs-string,.hljs-regexp,.hljs-string{color:#50a14f}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#986801}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#4078f2}.hljs-built_in,.hljs-class .hljs-title,.hljs-title.class_{color:#c18401}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}","darkCss":"pre code.hljs{display:block;overflow-x:auto;padding:1em}code.hljs{padding:3px 5px}.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta .hljs-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-built_in,.hljs-class .hljs-title,.hljs-title.class_{color:#e6c07b}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}"},"__N_SSG":true},"page":"/blogs/[slug]","query":{"slug":"tektoncd"},"buildId":"_8HBxX34UB3LF24lu6poG","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>