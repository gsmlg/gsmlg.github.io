<!DOCTYPE html><html lang="en"><head><meta charSet="utf-8"/><meta name="viewport" content="minimum-scale=1, initial-scale=1, width=device-width"/><meta name="theme-color" content="#1976d2"/><title>ECS递归与权威的prefix</title><link rel="icon" href="/favicon.ico"/><meta name="next-head-count" content="5"/><meta name="theme-color" content="#1976d2"/><link rel="preload" href="/_next/static/css/b192415249a5ea5e.css" as="style"/><link rel="stylesheet" href="/_next/static/css/b192415249a5ea5e.css" data-n-g=""/><link rel="preload" href="/_next/static/css/c2a527101433f11d.css" as="style"/><link rel="stylesheet" href="/_next/static/css/c2a527101433f11d.css" data-n-p=""/><noscript data-n-css=""></noscript><script defer="" nomodule="" src="/_next/static/chunks/polyfills-0d1b80a048d4787e.js"></script><script src="/_next/static/chunks/webpack-fcec467324f41dbb.js" defer=""></script><script src="/_next/static/chunks/framework-3583eef75b58b7b2.js" defer=""></script><script src="/_next/static/chunks/main-5ae059702bc551aa.js" defer=""></script><script src="/_next/static/chunks/pages/_app-8b48fed7d4929d67.js" defer=""></script><script src="/_next/static/chunks/eb1842f2-938c3c1ba50dcbb1.js" defer=""></script><script src="/_next/static/chunks/934-f3f19c7ad52989f5.js" defer=""></script><script src="/_next/static/chunks/228-acd28d763a4c6048.js" defer=""></script><script src="/_next/static/chunks/pages/blogs/%5Bslug%5D-da212848e00eb38b.js" defer=""></script><script src="/_next/static/vfK9WCeoKQ2unt0CgB_T1/_buildManifest.js" defer=""></script><script src="/_next/static/vfK9WCeoKQ2unt0CgB_T1/_ssgManifest.js" defer=""></script><style data-emotion="css "></style></head><body><div id="__next"><style data-emotion="css-global o6gwfi">html{-webkit-font-smoothing:antialiased;-moz-osx-font-smoothing:grayscale;box-sizing:border-box;-webkit-text-size-adjust:100%;}*,*::before,*::after{box-sizing:inherit;}strong,b{font-weight:700;}body{margin:0;color:rgba(0, 0, 0, 0.87);font-family:"Roboto","Helvetica","Arial",sans-serif;font-weight:400;font-size:1rem;line-height:1.5;letter-spacing:0.00938em;background-color:#fff;}@media print{body{background-color:#fff;}}body::backdrop{background-color:#fff;}</style><section class="css-1vqbnt3"><header class="MuiPaper-root MuiPaper-elevation MuiPaper-elevation4 MuiAppBar-root MuiAppBar-colorPrimary MuiAppBar-positionStatic css-1x7skt0"><div class="MuiToolbar-root MuiToolbar-gutters MuiToolbar-regular css-i6s8oy"><div status="[object Object]" class="css-ad3hhb"></div><button class="MuiButtonBase-root MuiIconButton-root MuiIconButton-colorInherit MuiIconButton-sizeLarge css-1l1167e" tabindex="0" type="button" aria-label="Menu"><span class="MuiBadge-root BaseBadge-root css-1rzb3uu"><svg class="MuiSvgIcon-root MuiSvgIcon-fontSizeMedium css-vubbuv" focusable="false" aria-hidden="true" viewBox="0 0 24 24" data-testid="MenuIcon"><path d="M3 18h18v-2H3v2zm0-5h18v-2H3v2zm0-7v2h18V6H3z"></path></svg><span class="MuiBadge-badge MuiBadge-standard MuiBadge-invisible MuiBadge-anchorOriginTopRight MuiBadge-anchorOriginTopRightRectangular MuiBadge-overlapRectangular BaseBadge-badge BaseBadge-invisible css-1mcnwcn"></span></span></button><p class="MuiTypography-root MuiTypography-body1 css-1ikde92" type="title"><button class="MuiButton-root MuiButton-text MuiButton-textInherit MuiButton-sizeMedium MuiButton-textSizeMedium MuiButton-colorInherit MuiButtonBase-root  css-b7766g" tabindex="0" type="button"><a href="/">Home</a></button><button class="MuiButton-root MuiButton-text MuiButton-textInherit MuiButton-sizeMedium MuiButton-textSizeMedium MuiButton-colorInherit MuiButtonBase-root  css-b7766g" tabindex="0" type="button"><a href="/blogs">Blog</a></button><button class="MuiButton-root MuiButton-text MuiButton-textInherit MuiButton-sizeMedium MuiButton-textSizeMedium MuiButton-colorInherit MuiButtonBase-root  css-b7766g" tabindex="0" type="button"><a href="/presentations">Presentation</a></button><button class="MuiButton-root MuiButton-text MuiButton-textInherit MuiButton-sizeMedium MuiButton-textSizeMedium MuiButton-colorInherit MuiButtonBase-root  css-b7766g" tabindex="0" type="button"><a href="/tools">Tool</a></button></p></div></header><section class="css-xxwux"><div class="MuiPaper-root MuiPaper-elevation MuiPaper-rounded MuiPaper-elevation4 css-gnirli"><header><h1 class="MuiTypography-root MuiTypography-body1 css-9l3uo3">ECS递归与权威的prefix</h1><div class="MuiTypography-root MuiTypography-body1 css-9l3uo3">Author:<!-- -->Gao</div><div class="MuiTypography-root MuiTypography-body1 css-9l3uo3">Created At:<!-- -->2020-11-03</div></header><hr class="MuiDivider-root MuiDivider-fullWidth css-39bbo6"/><section class="MuiTypography-root MuiTypography-body1 blog-content css-9l3uo3"><div class="css-1xqzmcn"><h3>起因</h3>
<p>今天在搭建一个递归服务器, 想要测试一下递归结果, 根据 ECS 来判断相关的递归服务器
结果</p>
<p>结果在进行递归查询的时候, 发现一个问题, 递归携带了 subnet, 查询后再更换 subnet,
递归直接读取了缓存, 而不是带着新的 subnet 去递归.</p>
<h3>排查</h3>
<p>为了对比这个问题,使用了不同的域名来进行递归,发现一个问题,两个域名在递归服务器有
不同的结果. 域名 z.gsmiot.com 在第一次递归后会一直缓存, aws.amazon.com 域名会根
据子网变换每次都会递归.</p>
<p>我对比里查询的结果, 发现了一个区别:</p>
<p>z.gsmiot.com</p>
<pre><code class="hljs language-text">[root@10-9-104-141 unbound]#  dig z.gsmiot.com @127.0.0.1 +subnet=178.24.161.99/16

; &lt;&lt;&gt;&gt; DiG 9.11.4-P2-RedHat-9.11.4-16.P2.el7_8.6 &lt;&lt;&gt;&gt; z.gsmiot.com @127.0.0.1 +subnet=178.24.161.99/16
;; global options: +cmd
;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 36175
;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 1232
; CLIENT-SUBNET: 178.24.0.0/16/0
;; QUESTION SECTION:
;z.gsmiot.com.			IN	A

;; ANSWER SECTION:
z.gsmiot.com.		3600	IN	A	8.8.8.8

;; Query time: 994 msec
;; SERVER: 127.0.0.1#53(127.0.0.1)
;; WHEN: Tue Nov 03 11:03:27 CST 2020
;; MSG SIZE  rcvd: 67
</code></pre>
<p>aws.amazon.com</p>
<pre><code class="hljs language-text">[root@10-9-104-141 unbound]# dig aws.amazon.com @127.0.0.1 +subnet=178.24.161.99/16

; &lt;&lt;&gt;&gt; DiG 9.11.4-P2-RedHat-9.11.4-16.P2.el7_8.6 &lt;&lt;&gt;&gt; aws.amazon.com @127.0.0.1 +subnet=178.24.161.99/16
;; global options: +cmd
;; Got answer:
;; -&gt;&gt;HEADER&lt;&lt;- opcode: QUERY, status: NOERROR, id: 2145
;; flags: qr rd ra; QUERY: 1, ANSWER: 3, AUTHORITY: 0, ADDITIONAL: 1

;; OPT PSEUDOSECTION:
; EDNS: version: 0, flags:; udp: 1232
; CLIENT-SUBNET: 178.24.0.0/16/24
;; QUESTION SECTION:
;aws.amazon.com.			IN	A

;; ANSWER SECTION:
aws.amazon.com.		300	IN	CNAME	tp.8e49140c2-frontier.amazon.com.
tp.8e49140c2-frontier.amazon.com. 300 IN CNAME	dr49lng3n1n2s.cloudfront.net.
dr49lng3n1n2s.cloudfront.net. 300 IN	A	54.230.150.74

;; Query time: 420 msec
;; SERVER: 127.0.0.1#53(127.0.0.1)
;; WHEN: Tue Nov 03 11:03:53 CST 2020
;; MSG SIZE  rcvd: 147
</code></pre>
<p>对比发现了响应的结果有区别, 在<code>OPT PSEUDOSECTION</code>这个部分,有一个地方有区别:</p>
<pre><code class="hljs language-text">AWS 权威
; CLIENT-SUBNET: 178.24.0.0/16/24
ZDNS 权威
; CLIENT-SUBNET: 178.24.0.0/16/0
</code></pre>
<p>又测试了 subnet 生效的 aws 域名, 递归会根据发现子网这个地
址<code>178.24.0.0/[A]/[B]</code>中的 A 和 B 两个 prefix 来做判断, 如果携带的 A 范围较大,
就是用 A, 而 B 范围较大, 就使用 B. 现在猜测这里的 B 可能是由权威返回的.</p>
<p>查询了一下相关文档
<a href="https://tools.ietf.org/html/rfc7871#section-7.2.1">RFC7871 Client Subnet in DNS Queries</a></p>
<p>其中在 7.2.1 节中内容:</p>
<pre><code class="hljs language-text">7.2.1.  Authoritative Nameserver

   When a query containing an ECS option is received, an Authoritative
   Nameserver supporting ECS MAY use the address information specified
   in the option to generate a tailored response.

   Authoritative Nameservers that have not implemented or enabled
   support for the ECS option ought to safely ignore it within incoming
   queries, per [RFC6891], Section 6.1.2.  Such a server MUST NOT
   include an ECS option within replies to indicate lack of support for
   it.  Implementers of Intermediate Nameservers should be aware,
   however, that some nameservers incorrectly echo back unknown EDNS0
   options.  In this protocol, that should be mostly harmless, as the
   SCOPE PREFIX-LENGTH should come back as 0, thus marking the response
   as covering all networks.

   A query with a wrongly formatted option (e.g., an unknown FAMILY)
   MUST be rejected and a FORMERR response MUST be returned to the
   sender, as described in [RFC6891], &quot;Transport Considerations&quot;.
</code></pre>
<p>其中一段
<code>In this protocol, that should be mostly harmless, as the SCOPE PREFIX-LENGTH should come back as 0, thus marking the response as covering all networks.</code>
这里<code>SCOPE PREFIX-LENGTH</code>如果为 0 的话, 响应就会应用到所有网络. 目前猜测 ZDNS 的
权威可能属于这个问题的范围.</p>
<p>查询了一下文档, 找到了 IETF 上有一个相关文档
<a href="https://www.ietf.org/proceedings/106/slides/slides-106-maprg-a-look-at-the-ecs-behavior-of-dns-resolvers-kyle-schomp-01">A Look at the ECS Behavior of DNS Resolvers</a></p>
<p>有如下一段内容:</p>
<pre><code class="hljs language-text">ECS Purpose
• Enable CDN server selection by ADNS based on client subnet
• ECS Option in DNS queries from resolvers to ADNS includes
• Client IP address prefix
• Source prefix length
• ECS Option in DNS responses from ADNS to resolvers includes
• Scope prefix length
</code></pre>
<p>现在可以推断极大概率是因为这个 scop prefix length 的问题了</p>
<h3>验证</h3>
<p>使用 tcpudump 抓包两次递归服务的递归结果</p>
<pre><code class="hljs language-shell">tcpdump -i eth0 port 53 -w zcloud.cap
tcpdump -i eth0 port 53 -w aws.cap
</code></pre>
<p>在 wireshark 中打开看到结果</p>
<p>在响应结果的记录中</p>
<ul>
<li>打开 Domain Name System (response)</li>
<li>打开 Addional records</li>
<li>打开<!-- -->&lt;Root&gt;<!-- -->: type OPT</li>
<li>打开&lt;Option: CSUBNET - Client subnet</li>
</ul>
<p>对比看到 Scope Netmask 有区别, aws 返回为 24, zdns 返回为 0</p>
<p>问题确认, 是由于权威返回结果的问题导致的</p></div></section></div></section><footer style="margin-top:0" class="css-6haedj"><div class="container"><span id="icp-info" class="css-z2a085">京ICP备20014476号-2</span><span>Copyright © 2017-2022 GSMLG - Powered by GSMLG Web.</span></div></footer></section></div><script id="__NEXT_DATA__" type="application/json">{"props":{"pageProps":{"slug":"about-ecs-prefix","blog":{"author":"Gao","content":"### 起因\n\n今天在搭建一个递归服务器, 想要测试一下递归结果, 根据 ECS 来判断相关的递归服务器\n结果\n\n结果在进行递归查询的时候, 发现一个问题, 递归携带了 subnet, 查询后再更换 subnet,\n递归直接读取了缓存, 而不是带着新的 subnet 去递归.\n\n### 排查\n\n为了对比这个问题,使用了不同的域名来进行递归,发现一个问题,两个域名在递归服务器有\n不同的结果. 域名 z.gsmiot.com 在第一次递归后会一直缓存, aws.amazon.com 域名会根\n据子网变换每次都会递归.\n\n我对比里查询的结果, 发现了一个区别:\n\nz.gsmiot.com\n\n```text\n[root@10-9-104-141 unbound]#  dig z.gsmiot.com @127.0.0.1 +subnet=178.24.161.99/16\n\n; \u003c\u003c\u003e\u003e DiG 9.11.4-P2-RedHat-9.11.4-16.P2.el7_8.6 \u003c\u003c\u003e\u003e z.gsmiot.com @127.0.0.1 +subnet=178.24.161.99/16\n;; global options: +cmd\n;; Got answer:\n;; -\u003e\u003eHEADER\u003c\u003c- opcode: QUERY, status: NOERROR, id: 36175\n;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1\n\n;; OPT PSEUDOSECTION:\n; EDNS: version: 0, flags:; udp: 1232\n; CLIENT-SUBNET: 178.24.0.0/16/0\n;; QUESTION SECTION:\n;z.gsmiot.com.\t\t\tIN\tA\n\n;; ANSWER SECTION:\nz.gsmiot.com.\t\t3600\tIN\tA\t8.8.8.8\n\n;; Query time: 994 msec\n;; SERVER: 127.0.0.1#53(127.0.0.1)\n;; WHEN: Tue Nov 03 11:03:27 CST 2020\n;; MSG SIZE  rcvd: 67\n```\n\naws.amazon.com\n\n```text\n[root@10-9-104-141 unbound]# dig aws.amazon.com @127.0.0.1 +subnet=178.24.161.99/16\n\n; \u003c\u003c\u003e\u003e DiG 9.11.4-P2-RedHat-9.11.4-16.P2.el7_8.6 \u003c\u003c\u003e\u003e aws.amazon.com @127.0.0.1 +subnet=178.24.161.99/16\n;; global options: +cmd\n;; Got answer:\n;; -\u003e\u003eHEADER\u003c\u003c- opcode: QUERY, status: NOERROR, id: 2145\n;; flags: qr rd ra; QUERY: 1, ANSWER: 3, AUTHORITY: 0, ADDITIONAL: 1\n\n;; OPT PSEUDOSECTION:\n; EDNS: version: 0, flags:; udp: 1232\n; CLIENT-SUBNET: 178.24.0.0/16/24\n;; QUESTION SECTION:\n;aws.amazon.com.\t\t\tIN\tA\n\n;; ANSWER SECTION:\naws.amazon.com.\t\t300\tIN\tCNAME\ttp.8e49140c2-frontier.amazon.com.\ntp.8e49140c2-frontier.amazon.com. 300 IN CNAME\tdr49lng3n1n2s.cloudfront.net.\ndr49lng3n1n2s.cloudfront.net. 300 IN\tA\t54.230.150.74\n\n;; Query time: 420 msec\n;; SERVER: 127.0.0.1#53(127.0.0.1)\n;; WHEN: Tue Nov 03 11:03:53 CST 2020\n;; MSG SIZE  rcvd: 147\n```\n\n对比发现了响应的结果有区别, 在`OPT PSEUDOSECTION`这个部分,有一个地方有区别:\n\n```text\nAWS 权威\n; CLIENT-SUBNET: 178.24.0.0/16/24\nZDNS 权威\n; CLIENT-SUBNET: 178.24.0.0/16/0\n```\n\n又测试了 subnet 生效的 aws 域名, 递归会根据发现子网这个地\n址`178.24.0.0/[A]/[B]`中的 A 和 B 两个 prefix 来做判断, 如果携带的 A 范围较大,\n就是用 A, 而 B 范围较大, 就使用 B. 现在猜测这里的 B 可能是由权威返回的.\n\n查询了一下相关文档\n[RFC7871 Client Subnet in DNS Queries](https://tools.ietf.org/html/rfc7871#section-7.2.1)\n\n其中在 7.2.1 节中内容:\n\n```text\n7.2.1.  Authoritative Nameserver\n\n   When a query containing an ECS option is received, an Authoritative\n   Nameserver supporting ECS MAY use the address information specified\n   in the option to generate a tailored response.\n\n   Authoritative Nameservers that have not implemented or enabled\n   support for the ECS option ought to safely ignore it within incoming\n   queries, per [RFC6891], Section 6.1.2.  Such a server MUST NOT\n   include an ECS option within replies to indicate lack of support for\n   it.  Implementers of Intermediate Nameservers should be aware,\n   however, that some nameservers incorrectly echo back unknown EDNS0\n   options.  In this protocol, that should be mostly harmless, as the\n   SCOPE PREFIX-LENGTH should come back as 0, thus marking the response\n   as covering all networks.\n\n   A query with a wrongly formatted option (e.g., an unknown FAMILY)\n   MUST be rejected and a FORMERR response MUST be returned to the\n   sender, as described in [RFC6891], \"Transport Considerations\".\n```\n\n其中一段\n`In this protocol, that should be mostly harmless, as the SCOPE PREFIX-LENGTH should come back as 0, thus marking the response as covering all networks.`\n这里`SCOPE PREFIX-LENGTH`如果为 0 的话, 响应就会应用到所有网络. 目前猜测 ZDNS 的\n权威可能属于这个问题的范围.\n\n查询了一下文档, 找到了 IETF 上有一个相关文档\n[A Look at the ECS Behavior of DNS Resolvers](https://www.ietf.org/proceedings/106/slides/slides-106-maprg-a-look-at-the-ecs-behavior-of-dns-resolvers-kyle-schomp-01)\n\n有如下一段内容:\n\n```text\nECS Purpose\n• Enable CDN server selection by ADNS based on client subnet\n• ECS Option in DNS queries from resolvers to ADNS includes\n• Client IP address prefix\n• Source prefix length\n• ECS Option in DNS responses from ADNS to resolvers includes\n• Scope prefix length\n```\n\n现在可以推断极大概率是因为这个 scop prefix length 的问题了\n\n### 验证\n\n使用 tcpudump 抓包两次递归服务的递归结果\n\n```shell\ntcpdump -i eth0 port 53 -w zcloud.cap\ntcpdump -i eth0 port 53 -w aws.cap\n```\n\n在 wireshark 中打开看到结果\n\n在响应结果的记录中\n\n- 打开 Domain Name System (response)\n- 打开 Addional records\n- 打开\u003cRoot\u003e: type OPT\n- 打开\u003cOption: CSUBNET - Client subnet\n\n对比看到 Scope Netmask 有区别, aws 返回为 24, zdns 返回为 0\n\n问题确认, 是由于权威返回结果的问题导致的\n","date":"2020-11-03","id":49,"slug":"about-ecs-prefix","title":"ECS递归与权威的prefix"},"lightCss":"pre code.hljs{display:block;overflow-x:auto;padding:1em}code.hljs{padding:3px 5px}.hljs{color:#383a42;background:#fafafa}.hljs-comment,.hljs-quote{color:#a0a1a7;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#a626a4}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e45649}.hljs-literal{color:#0184bb}.hljs-addition,.hljs-attribute,.hljs-meta .hljs-string,.hljs-regexp,.hljs-string{color:#50a14f}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#986801}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#4078f2}.hljs-built_in,.hljs-class .hljs-title,.hljs-title.class_{color:#c18401}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}","darkCss":"pre code.hljs{display:block;overflow-x:auto;padding:1em}code.hljs{padding:3px 5px}.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta .hljs-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-built_in,.hljs-class .hljs-title,.hljs-title.class_{color:#e6c07b}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}"},"__N_SSG":true},"page":"/blogs/[slug]","query":{"slug":"about-ecs-prefix"},"buildId":"vfK9WCeoKQ2unt0CgB_T1","isFallback":false,"gsp":true,"scriptLoader":[]}</script></body></html>