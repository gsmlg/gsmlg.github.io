(window.webpackJsonp=window.webpackJsonp||[]).push([[41],{ff77bdcc071cfad4c8a1:function(s,a){s.exports='<h1 id=tekton-pipelines>Tekton Pipelines</h1> <h2 id=intro>Intro</h2> <p>Tekton Pipelines\u662f\u4e00\u4e2a\u4e3a<code>Kubernetes</code>\u5e94\u7528\u7a0b\u5e8f\u914d\u7f6e\u548c\u8fd0\u884c<code>CI / CD</code>\u98ce\u683c\u7684<code>Pipelined</code>\u7684\u5f00\u6e90\u5b9e\u73b0</p> <p><code>Pipeline</code> \u521b\u5efa <code>Custom Resources</code> \u4f5c\u4e3a\u6784\u5efa\u6a21\u5757\u6765\u58f0\u660e<code>pipelines</code></p> <p>Tekton Pipelines \u662f\u4e91\u539f\u751f\u7684</p> <ul> <li>\u8fd0\u884c\u4e8e<code>Kubernetes</code></li> <li>\u5c06<code>Kubernetes</code>\u96c6\u7fa4\u4f5c\u4e3a\u4e00\u7ea7\u8d44\u6e90\u7c7b\u578b</li> <li>\u4f7f\u7528\u5bb9\u5668\u4f5c\u4e3a\u6784\u5efa\u5757</li> </ul> <p>Tekton Pipelines \u662f\u89e3\u8026\u7684</p> <ul> <li>Pipeline \u53ef\u4ee5\u88ab\u90e8\u7f72\u4e8e\u4efb\u610fk8s\u96c6\u7fa4</li> <li>\u7ec4\u6210<code>pipeline</code>\u7684<code>task</code>\u53ef\u4ee5\u5206\u5f00\u72ec\u7acb\u8fd0\u884c</li> <li>\u5411Git repos\u4e4b\u7c7b\u7684\u8d44\u6e90\u53ef\u4ee5\u8f7b\u677e\u7684\u5728\u8fd0\u884c\u4e4b\u95f4\u4ea4\u6362</li> </ul> <p>Tekton Pipelines are Typed</p> <ul> <li>\u7c7b\u578b\u5316\u7684\u8d44\u6e90\u610f\u5473\u7740\u5bf9\u4e8e\u8bf8\u5982Image\u4e4b\u7c7b\u7684\u8d44\u6e90\uff0c\u53ef\u4ee5\u8f7b\u677e\u5730\u5c06\u8d44\u6e90\u8f93\u51fa</li> </ul> <h3 id=\u6b64\u8bbe\u8ba1\u7684\u9ad8\u7ea7\u7ec6\u8282\uff1a>\u6b64\u8bbe\u8ba1\u7684\u9ad8\u7ea7\u7ec6\u8282\uff1a</h3> <ul> <li>Pipeline \u8fd0\u884c\u7ba1\u9053\uff0c\u53ef\u4ee5\u5b9e\u73b0\u4e00\u4e2a\u6d41\u7a0b\uff0c\u53ef\u4ee5\u7531\u4e8b\u4ef6\u51fa\u53d1\uff0c\u4e5f\u53ef\u4ee5\u901a\u8fc7<code>PipelineRun</code>\u6765\u8fd0\u884c</li> <li>Task \u57fa\u672c\u8fd0\u884c\u5355\u5143\uff0c\u53ef\u4ee5\u901a\u8fc7<code>TaskRun</code>\u6765\u8fd0\u884c</li> <li>PipelineResource <code>Task</code>\u7684\u8f93\u5165\u548c\u8f93\u51fa\u8d44\u6e90</li> </ul> <h2 id=\u5404\u7c7b\u8d44\u6e90\u4ecb\u7ecd>\u5404\u7c7b\u8d44\u6e90\u4ecb\u7ecd</h2> <h3 id=pipelineresources>PipelineResources</h3> <p><code>PipelineResource</code> \u662f <code>Pipline</code> \u4e2d <code>Task</code> \u7684\u8f93\u5165\u548c\u8f93\u51fa\u5bf9\u8c61</p> <p>Syntax:</p> <p>To define a configuration file for a PipelineResource, you can specify the following fields:</p> <ul> <li>Required:<ul> <li>apiVersion - Specifies the API version, for example tekton.dev/v1alpha1.</li> <li>kind - Specify the PipelineResource resource object.</li> <li>metadata - Specifies data to uniquely identify the PipelineResource object, for example a name.</li> <li>spec - Specifies the configuration information for your PipelineResource resource object.</li> <li>type - Specifies the type of the PipelineResource</li> </ul> </li> <li>Optional:<ul> <li>params - Parameters which are specific to each type of PipelineResource</li> </ul> </li> </ul> <p>Types:</p> <ul> <li>Git</li> <li>PullRequest</li> <li>Image</li> <li>Cluster</li> <li>Storage</li> <li>CloutEvent</li> </ul> <h3 id=tasks>Tasks</h3> <p>Task(or ClusterTask) \u662fCI\u4e2d\u4e00\u4e2a\u7ec4\u987a\u5e8f\u6267\u884c\u7684step\u7684\u96c6\u5408\uff0c\u662f\u57fa\u672c\u4efb\u52a1\u5355\u4f4d\u3002Task\u4f1a\u5728pod\u4e2d\u8fd0\u884c\u3002</p> <p>Task \u9700\u8981\u58f0\u660e\u4e09\u90e8\u5206\uff1a</p> <ul> <li>inputs</li> <li>outputs</li> <li>steps</li> </ul> <p>Task \u5728namespace\u4e2d\u53ef\u7528\uff0cClusterTask\u5728\u6574\u4e2a\u96c6\u7fa4\u53ef\u7528</p> <p>Syntax:</p> <p>To define a configuration file for a Task resource, you can specify the following fields:</p> <ul> <li>Required:<ul> <li>apiVersion - Specifies the API version, for example tekton.dev/v1alpha1.</li> <li>kind - Specify the Task resource object.</li> <li>metadata - Specifies data to uniquely identify the Task resource object, for example a name.</li> <li>spec - Specifies the configuration information for your Task resource object. Task steps must be defined through either of the following fields: -steps - Specifies one or more container images that you want to run in your Task.</li> </ul> </li> <li>Optional:<ul> <li>inputs - Specifies parameters and PipelineResources needed by your Task</li> <li>outputs - Specifies PipelineResources created by your Task</li> <li>volumes - Specifies one or more volumes that you want to make available to your Task&#39;s steps.</li> <li>stepTemplate - Specifies a Container step definition to use as the basis for all steps within your Task.</li> <li>sidecars - Specifies sidecar containers to run alongside steps.</li> </ul> </li> </ul> <h3 id=piplines>Piplines</h3> <p>Pipline\u5b9a\u4e49\u5e76\u6267\u884c\u4e00\u7ec4Task</p> <p>Syntax:</p> <p>To define a configuration file for a Pipeline resource, you can specify the following fields:</p> <ul> <li>Required:<ul> <li>apiVersion - Specifies the API version, for example tekton.dev/v1alpha1.</li> <li>kind - Specify the Pipeline resource object.</li> <li>metadata - Specifies data to uniquely identify the Pipeline resource object, for example a name.</li> <li>spec - Specifies the configuration information for your Pipeline resource object. In order for a Pipeline to do anything, the spec must include:<ul> <li>tasks - Specifies which Tasks to run and how to run them</li> </ul> </li> </ul> </li> <li>Optional:<ul> <li>resources - Specifies which PipelineResources of which types the Pipeline will be using in its Tasks</li> <li>tasks<ul> <li>resources.inputs / resource.outputs<ul> <li>from - Used when the content of the PipelineResource should come from the output of a previous Pipeline Task</li> <li>runAfter - Used when the Pipeline Task should be executed after another Pipeline Task, but there is no output linking required</li> <li>retries - Used when the task is wanted to be executed if it fails. Could be a network error or a missing dependency. It does not apply to cancellations.</li> <li>conditions - Used when a task is to be executed only if the specified conditions are evaluated to be true.</li> </ul> </li> </ul> </li> </ul> </li> </ul> <p>Task\u6267\u884c\u987a\u5e8f\uff0c\u6240\u6709Task\u9ed8\u8ba4\u90fd\u4f1a\u5e76\u884c\u6267\u884c\uff0c\u9664\u975e\u6307\u5b9a\u4e86</p> <ul> <li>from</li> <li>runAfter \u4e24\u9879\u4f1a\u6307\u5b9atask\u6267\u884c\u7684\u4f9d\u8d56\u5173\u7cfb</li> </ul> <p>For example see this Pipeline spec:</p> <pre class=hljs><code class=language-yaml><span class=hljs-bullet>-</span> <span class=hljs-attr>name:</span> <span class=hljs-string>lint-repo</span>\n  <span class=hljs-attr>taskRef:</span>\n    <span class=hljs-attr>name:</span> <span class=hljs-string>pylint</span>\n  <span class=hljs-attr>resources:</span>\n    <span class=hljs-attr>inputs:</span>\n      <span class=hljs-bullet>-</span> <span class=hljs-attr>name:</span> <span class=hljs-string>workspace</span>\n        <span class=hljs-attr>resource:</span> <span class=hljs-string>my-repo</span>\n<span class=hljs-bullet>-</span> <span class=hljs-attr>name:</span> <span class=hljs-string>test-app</span>\n  <span class=hljs-attr>taskRef:</span>\n    <span class=hljs-attr>name:</span> <span class=hljs-string>make-test</span>\n  <span class=hljs-attr>resources:</span>\n    <span class=hljs-attr>inputs:</span>\n      <span class=hljs-bullet>-</span> <span class=hljs-attr>name:</span> <span class=hljs-string>workspace</span>\n        <span class=hljs-attr>resource:</span> <span class=hljs-string>my-repo</span>\n<span class=hljs-bullet>-</span> <span class=hljs-attr>name:</span> <span class=hljs-string>build-app</span>\n  <span class=hljs-attr>taskRef:</span>\n    <span class=hljs-attr>name:</span> <span class=hljs-string>kaniko-build-app</span>\n  <span class=hljs-attr>runAfter:</span>\n    <span class=hljs-bullet>-</span> <span class=hljs-string>test-app</span>\n  <span class=hljs-attr>resources:</span>\n    <span class=hljs-attr>inputs:</span>\n      <span class=hljs-bullet>-</span> <span class=hljs-attr>name:</span> <span class=hljs-string>workspace</span>\n        <span class=hljs-attr>resource:</span> <span class=hljs-string>my-repo</span>\n    <span class=hljs-attr>outputs:</span>\n      <span class=hljs-bullet>-</span> <span class=hljs-attr>name:</span> <span class=hljs-string>image</span>\n        <span class=hljs-attr>resource:</span> <span class=hljs-string>my-app-image</span>\n<span class=hljs-bullet>-</span> <span class=hljs-attr>name:</span> <span class=hljs-string>build-frontend</span>\n  <span class=hljs-attr>taskRef:</span>\n    <span class=hljs-attr>name:</span> <span class=hljs-string>kaniko-build-frontend</span>\n  <span class=hljs-attr>runAfter:</span>\n    <span class=hljs-bullet>-</span> <span class=hljs-string>test-app</span>\n  <span class=hljs-attr>resources:</span>\n    <span class=hljs-attr>inputs:</span>\n      <span class=hljs-bullet>-</span> <span class=hljs-attr>name:</span> <span class=hljs-string>workspace</span>\n        <span class=hljs-attr>resource:</span> <span class=hljs-string>my-repo</span>\n    <span class=hljs-attr>outputs:</span>\n      <span class=hljs-bullet>-</span> <span class=hljs-attr>name:</span> <span class=hljs-string>image</span>\n        <span class=hljs-attr>resource:</span> <span class=hljs-string>my-frontend-image</span>\n<span class=hljs-bullet>-</span> <span class=hljs-attr>name:</span> <span class=hljs-string>deploy-all</span>\n  <span class=hljs-attr>taskRef:</span>\n    <span class=hljs-attr>name:</span> <span class=hljs-string>deploy-kubectl</span>\n  <span class=hljs-attr>resources:</span>\n    <span class=hljs-attr>inputs:</span>\n      <span class=hljs-bullet>-</span> <span class=hljs-attr>name:</span> <span class=hljs-string>my-app-image</span>\n        <span class=hljs-attr>resource:</span> <span class=hljs-string>my-app-image</span>\n        <span class=hljs-attr>from:</span>\n          <span class=hljs-bullet>-</span> <span class=hljs-string>build-app</span>\n      <span class=hljs-bullet>-</span> <span class=hljs-attr>name:</span> <span class=hljs-string>my-frontend-image</span>\n        <span class=hljs-attr>resource:</span> <span class=hljs-string>my-frontend-image</span>\n        <span class=hljs-attr>from:</span>\n          <span class=hljs-bullet>-</span> <span class=hljs-string>build-frontend</span></code></pre><p>This will result in the following execution graph:</p> <pre class=hljs><code class=language-auto>        <span class=hljs-meta>|</span>            <span class=hljs-string>|</span>\n        <span class=hljs-attr>v</span>            <span class=hljs-string>v</span>\n     <span class=hljs-meta>test-app</span>    <span class=hljs-string>lint-repo</span>\n    <span class=hljs-meta>/</span>        <span class=hljs-string>\\\n   v          v</span>\n<span class=hljs-meta>build-app</span>  <span class=hljs-string>build-frontend</span>\n   <span class=hljs-attr>\\ </span>         <span class=hljs-string>/</span>\n    <span class=hljs-attr>v</span>        <span class=hljs-string>v</span>\n    <span class=hljs-attr>deploy-all</span></code></pre><h2 id=\u5b89\u88c5>\u5b89\u88c5</h2> <p>\u8fd0\u884c kubectl \u5b89\u88c5\u6307\u5b9a\u7684yaml\u6587\u4ef6</p> <pre class=hljs><code class=language-shell>kubectl apply -f https://raw.githubusercontent.com/gsmlg/pipeline/master/updated.yaml</code></pre><p>\u68c0\u67e5\u6240\u6709pod\u90fd\u5904\u4e8e<code>running</code>\u72b6\u6001\u65f6\uff0c\u5b89\u88c5\u5b8c\u6210</p> <pre class=hljs><code class=language-shell>kubectl -n tekton-pipelines get pods</code></pre><p>\u5b89\u88c5dashboard\uff0c\u66f4\u65b9\u4fbf\u7684\u67e5\u770bpipeline</p> <pre class=hljs><code class=language-shell>kubectl apply -f https://raw.githubusercontent.com/gsmlg/pipeline/master/updated_dashboard.yaml</code></pre><h2 id=\u6f14\u793a\u8fd0\u884c\u4e00\u4e2asinglecloud\u7684\u6784\u5efa\u8fc7\u7a0b>\u6f14\u793a\u8fd0\u884c\u4e00\u4e2a<code>singlecloud</code>\u7684\u6784\u5efa\u8fc7\u7a0b</h2> <p>\u521b\u5efa\u8d26\u6237</p> <pre class=hljs><code class=language-yaml>\n<span class=hljs-attr>apiVersion:</span> <span class=hljs-string>rbac.authorization.k8s.io/v1</span>\n<span class=hljs-attr>kind:</span> <span class=hljs-string>ClusterRole</span>\n<span class=hljs-attr>metadata:</span>\n  <span class=hljs-attr>name:</span> <span class=hljs-string>pipeline-run-role</span>\n<span class=hljs-attr>rules:</span>\n<span class=hljs-bullet>-</span> <span class=hljs-attr>apiGroups:</span>\n  <span class=hljs-bullet>-</span> <span class=hljs-string>extensions</span>\n  <span class=hljs-attr>resources:</span>\n  <span class=hljs-bullet>-</span> <span class=hljs-string>deployments</span>\n  <span class=hljs-attr>verbs:</span>\n  <span class=hljs-bullet>-</span> <span class=hljs-string>get</span>\n  <span class=hljs-bullet>-</span> <span class=hljs-string>list</span>\n  <span class=hljs-bullet>-</span> <span class=hljs-string>watch</span>\n  <span class=hljs-bullet>-</span> <span class=hljs-string>create</span>\n  <span class=hljs-bullet>-</span> <span class=hljs-string>update</span>\n  <span class=hljs-bullet>-</span> <span class=hljs-string>patch</span>\n  <span class=hljs-bullet>-</span> <span class=hljs-string>delete</span>\n\n<span class=hljs-meta>---</span>\n\n<span class=hljs-attr>apiVersion:</span> <span class=hljs-string>rbac.authorization.k8s.io/v1</span>\n<span class=hljs-attr>kind:</span> <span class=hljs-string>ClusterRoleBinding</span>\n<span class=hljs-attr>metadata:</span>\n  <span class=hljs-attr>name:</span> <span class=hljs-string>pipeline-run-binding</span>\n<span class=hljs-attr>roleRef:</span>\n  <span class=hljs-attr>apiGroup:</span> <span class=hljs-string>rbac.authorization.k8s.io</span>\n  <span class=hljs-attr>kind:</span> <span class=hljs-string>ClusterRole</span>\n  <span class=hljs-attr>name:</span> <span class=hljs-string>pipeline-run-role</span>\n<span class=hljs-attr>subjects:</span>\n<span class=hljs-bullet>-</span> <span class=hljs-attr>kind:</span> <span class=hljs-string>ServiceAccount</span>\n  <span class=hljs-attr>name:</span> <span class=hljs-string>pipeline-run-service</span>\n  <span class=hljs-attr>namespace:</span> <span class=hljs-string>default</span>\n\n<span class=hljs-meta>---</span>\n\n<span class=hljs-attr>apiVersion:</span> <span class=hljs-string>v1</span>\n<span class=hljs-attr>kind:</span> <span class=hljs-string>ServiceAccount</span>\n<span class=hljs-attr>metadata:</span>\n  <span class=hljs-attr>name:</span> <span class=hljs-string>pipeline-run-service</span>\n  <span class=hljs-attr>namespace:</span> <span class=hljs-string>default</span>\n<span class=hljs-attr>secrets:</span>\n  <span class=hljs-bullet>-</span> <span class=hljs-attr>name:</span> <span class=hljs-string>regcred</span>\n\n<span class=hljs-meta>---</span>\n\n<span class=hljs-attr>apiVersion:</span> <span class=hljs-string>v1</span>\n<span class=hljs-attr>data:</span>\n  <span class=hljs-string>.dockerconfigjson:</span> <span class=hljs-string>&lt;encoded</span> <span class=hljs-string>docker</span> <span class=hljs-string>registry</span> <span class=hljs-string>auth</span> <span class=hljs-string>data&gt;</span>\n<span class=hljs-attr>kind:</span> <span class=hljs-string>Secret</span>\n<span class=hljs-attr>metadata:</span>\n  <span class=hljs-attr>name:</span> <span class=hljs-string>regcred</span>\n  <span class=hljs-attr>namespace:</span> <span class=hljs-string>default</span>\n<span class=hljs-attr>type:</span> <span class=hljs-string>kubernetes.io/dockerconfigjson</span>\n</code></pre><p>\u5b9a\u4e49\u8d44\u6e90</p> <pre class=hljs><code class=language-yaml>\n<span class=hljs-attr>apiVersion:</span> <span class=hljs-string>tekton.dev/v1alpha1</span>\n<span class=hljs-attr>kind:</span> <span class=hljs-string>PipelineResource</span>\n<span class=hljs-attr>metadata:</span>\n  <span class=hljs-attr>name:</span> <span class=hljs-string>zcloud-image</span>\n<span class=hljs-attr>spec:</span>\n  <span class=hljs-attr>type:</span> <span class=hljs-string>image</span>\n  <span class=hljs-attr>params:</span>\n    <span class=hljs-bullet>-</span> <span class=hljs-attr>name:</span> <span class=hljs-string>url</span>\n      <span class=hljs-attr>value:</span> <span class=hljs-string>docker.io/gsmlg/zcloud</span>\n\n</code></pre><p>\u521b\u5efatask</p> <pre class=hljs><code class=language-yaml>\n<span class=hljs-attr>apiVersion:</span> <span class=hljs-string>tekton.dev/v1alpha1</span>\n<span class=hljs-attr>kind:</span> <span class=hljs-string>Task</span>\n<span class=hljs-attr>metadata:</span>\n  <span class=hljs-attr>name:</span> <span class=hljs-string>build-image-from-git</span>\n<span class=hljs-attr>spec:</span>\n  <span class=hljs-attr>inputs:</span>\n    <span class=hljs-attr>resources:</span>\n      <span class=hljs-bullet>-</span> <span class=hljs-attr>name:</span> <span class=hljs-string>docker-source</span>\n        <span class=hljs-attr>type:</span> <span class=hljs-string>git</span>\n    <span class=hljs-attr>params:</span>\n      <span class=hljs-bullet>-</span> <span class=hljs-attr>name:</span> <span class=hljs-string>pathToDockerFile</span>\n        <span class=hljs-attr>type:</span> <span class=hljs-string>string</span>\n        <span class=hljs-attr>description:</span> <span class=hljs-string>The</span> <span class=hljs-string>path</span> <span class=hljs-string>to</span> <span class=hljs-string>the</span> <span class=hljs-string>dockerfile</span> <span class=hljs-string>to</span> <span class=hljs-string>build</span>\n        <span class=hljs-attr>default:</span> <span class=hljs-string>/workspace/docker-source/Dockerfile</span>\n      <span class=hljs-bullet>-</span> <span class=hljs-attr>name:</span> <span class=hljs-string>pathToContext</span>\n        <span class=hljs-attr>type:</span> <span class=hljs-string>string</span>\n        <span class=hljs-attr>description:</span>\n          <span class=hljs-string>The</span> <span class=hljs-string>build</span> <span class=hljs-string>context</span> <span class=hljs-string>used</span> <span class=hljs-string>by</span> <span class=hljs-string>Kaniko</span>\n          <span class=hljs-string>(https://github.com/GoogleContainerTools/kaniko#kaniko-build-contexts)</span>\n        <span class=hljs-attr>default:</span> <span class=hljs-string>/workspace/docker-source</span>\n  <span class=hljs-attr>outputs:</span>\n    <span class=hljs-attr>resources:</span>\n      <span class=hljs-bullet>-</span> <span class=hljs-attr>name:</span> <span class=hljs-string>builtImage</span>\n        <span class=hljs-attr>type:</span> <span class=hljs-string>image</span>\n  <span class=hljs-attr>steps:</span>\n    <span class=hljs-bullet>-</span> <span class=hljs-attr>name:</span> <span class=hljs-string>build-and-push</span>\n      <span class=hljs-attr>image:</span> <span class=hljs-string>registry.zdns.cn/gsmlg/kaniko-project-executor:v0.13.0</span>\n      <span class=hljs-comment># specifying DOCKER_CONFIG is required to allow kaniko to detect docker credential</span>\n      <span class=hljs-attr>env:</span>\n        <span class=hljs-bullet>-</span> <span class=hljs-attr>name:</span> <span class=hljs-string>"DOCKER_CONFIG"</span>\n          <span class=hljs-attr>value:</span> <span class=hljs-string>"/builder/home/.docker/"</span>\n      <span class=hljs-attr>command:</span>\n        <span class=hljs-bullet>-</span> <span class=hljs-string>/kaniko/executor</span>\n      <span class=hljs-attr>args:</span>\n        <span class=hljs-bullet>-</span> <span class=hljs-string>--dockerfile=$(inputs.params.pathToDockerFile)</span>\n        <span class=hljs-bullet>-</span> <span class=hljs-string>--destination=$(outputs.resources.builtImage.url)</span>\n        <span class=hljs-bullet>-</span> <span class=hljs-string>--context=$(inputs.params.pathToContext)</span>\n        <span class=hljs-bullet>-</span> <span class=hljs-string>--oci-layout-path=/builder/home/image-outputs/builtImage</span>\n        <span class=hljs-bullet>-</span> <span class=hljs-string>--skip-tls-verify</span>\n\n<span class=hljs-meta>---</span>\n\n<span class=hljs-attr>apiVersion:</span> <span class=hljs-string>tekton.dev/v1alpha1</span>\n<span class=hljs-attr>kind:</span> <span class=hljs-string>Task</span>\n<span class=hljs-attr>metadata:</span>\n  <span class=hljs-attr>name:</span> <span class=hljs-string>build-zcloud</span>\n<span class=hljs-attr>spec:</span>\n  <span class=hljs-attr>inputs:</span>\n    <span class=hljs-attr>resources:</span>\n      <span class=hljs-bullet>-</span> <span class=hljs-attr>name:</span> <span class=hljs-string>docker-source</span>\n        <span class=hljs-attr>type:</span> <span class=hljs-string>git</span>\n      <span class=hljs-bullet>-</span> <span class=hljs-attr>name:</span> <span class=hljs-string>image</span>\n        <span class=hljs-attr>type:</span> <span class=hljs-string>image</span>\n      <span class=hljs-bullet>-</span> <span class=hljs-attr>name:</span> <span class=hljs-string>uiImage</span>\n        <span class=hljs-attr>type:</span> <span class=hljs-string>image</span>\n    <span class=hljs-attr>params:</span>\n      <span class=hljs-bullet>-</span> <span class=hljs-attr>name:</span> <span class=hljs-string>pathToDockerFile</span>\n        <span class=hljs-attr>type:</span> <span class=hljs-string>string</span>\n        <span class=hljs-attr>description:</span> <span class=hljs-string>The</span> <span class=hljs-string>path</span> <span class=hljs-string>to</span> <span class=hljs-string>the</span> <span class=hljs-string>dockerfile</span> <span class=hljs-string>to</span> <span class=hljs-string>build</span>\n        <span class=hljs-attr>default:</span> <span class=hljs-string>/workspace/docker-source/Dockerfile</span>\n      <span class=hljs-bullet>-</span> <span class=hljs-attr>name:</span> <span class=hljs-string>pathToContext</span>\n        <span class=hljs-attr>type:</span> <span class=hljs-string>string</span>\n        <span class=hljs-attr>description:</span>\n          <span class=hljs-string>The</span> <span class=hljs-string>build</span> <span class=hljs-string>context</span> <span class=hljs-string>used</span> <span class=hljs-string>by</span> <span class=hljs-string>Kaniko</span>\n          <span class=hljs-string>(https://github.com/GoogleContainerTools/kaniko#kaniko-build-contexts)</span>\n        <span class=hljs-attr>default:</span> <span class=hljs-string>/workspace/docker-source</span>\n  <span class=hljs-attr>outputs:</span>\n    <span class=hljs-attr>resources:</span>\n      <span class=hljs-bullet>-</span> <span class=hljs-attr>name:</span> <span class=hljs-string>builtImage</span>\n        <span class=hljs-attr>type:</span> <span class=hljs-string>image</span>\n  <span class=hljs-attr>steps:</span>\n    <span class=hljs-bullet>-</span> <span class=hljs-attr>name:</span> <span class=hljs-string>setup-dockerfile</span>\n      <span class=hljs-attr>image:</span> <span class=hljs-string>docker.io/ubuntu:18.04</span>\n      <span class=hljs-attr>command:</span>\n        <span class=hljs-bullet>-</span> <span class=hljs-string>/workspace/docker-source/setup.sh</span>\n      <span class=hljs-attr>args:</span>\n        <span class=hljs-bullet>-</span> <span class=hljs-string>$(inputs.resources.image.url)</span>\n        <span class=hljs-bullet>-</span> <span class=hljs-string>$(inputs.resources.uiImage.url)</span>\n        <span class=hljs-bullet>-</span> <span class=hljs-string>/workspace/docker-source/Dockerfile</span>\n    <span class=hljs-bullet>-</span> <span class=hljs-attr>name:</span> <span class=hljs-string>build-and-push</span>\n      <span class=hljs-attr>image:</span> <span class=hljs-string>registry.zdns.cn/gsmlg/kaniko-project-executor:v0.13.0</span>\n      <span class=hljs-comment># specifying DOCKER_CONFIG is required to allow kaniko to detect docker credential</span>\n      <span class=hljs-attr>env:</span>\n        <span class=hljs-bullet>-</span> <span class=hljs-attr>name:</span> <span class=hljs-string>"DOCKER_CONFIG"</span>\n          <span class=hljs-attr>value:</span> <span class=hljs-string>"/builder/home/.docker/"</span>\n      <span class=hljs-attr>command:</span>\n        <span class=hljs-bullet>-</span> <span class=hljs-string>/kaniko/executor</span>\n      <span class=hljs-attr>args:</span>\n        <span class=hljs-bullet>-</span> <span class=hljs-string>--dockerfile=$(inputs.params.pathToDockerFile)</span>\n        <span class=hljs-bullet>-</span> <span class=hljs-string>--destination=$(outputs.resources.builtImage.url)</span>\n        <span class=hljs-bullet>-</span> <span class=hljs-string>--context=$(inputs.params.pathToContext)</span>\n        <span class=hljs-bullet>-</span> <span class=hljs-string>--oci-layout-path=/builder/home/image-outputs/builtImage</span>\n        <span class=hljs-bullet>-</span> <span class=hljs-string>--skip-tls-verify</span>\n\n<span class=hljs-meta>---</span>\n\n<span class=hljs-attr>apiVersion:</span> <span class=hljs-string>tekton.dev/v1alpha1</span>\n<span class=hljs-attr>kind:</span> <span class=hljs-string>Pipeline</span>\n<span class=hljs-attr>metadata:</span>\n  <span class=hljs-attr>name:</span> <span class=hljs-string>zcloud-build-pipeline</span>\n<span class=hljs-attr>spec:</span>\n  <span class=hljs-attr>resources:</span>\n    <span class=hljs-bullet>-</span> <span class=hljs-attr>name:</span> <span class=hljs-string>singlecloud-repo</span>\n      <span class=hljs-attr>type:</span> <span class=hljs-string>git</span>\n    <span class=hljs-bullet>-</span> <span class=hljs-attr>name:</span> <span class=hljs-string>singlecloud-ui-repo</span>\n      <span class=hljs-attr>type:</span> <span class=hljs-string>git</span>\n    <span class=hljs-bullet>-</span> <span class=hljs-attr>name:</span> <span class=hljs-string>zcloud-repo</span>\n      <span class=hljs-attr>type:</span> <span class=hljs-string>git</span>\n    <span class=hljs-bullet>-</span> <span class=hljs-attr>name:</span> <span class=hljs-string>singlecloud-image</span>\n      <span class=hljs-attr>type:</span> <span class=hljs-string>image</span>\n    <span class=hljs-bullet>-</span> <span class=hljs-attr>name:</span> <span class=hljs-string>singlecloud-ui-image</span>\n      <span class=hljs-attr>type:</span> <span class=hljs-string>image</span>\n    <span class=hljs-bullet>-</span> <span class=hljs-attr>name:</span> <span class=hljs-string>zcloud-image</span>\n      <span class=hljs-attr>type:</span> <span class=hljs-string>image</span>\n  <span class=hljs-attr>tasks:</span>\n    <span class=hljs-bullet>-</span> <span class=hljs-attr>name:</span> <span class=hljs-string>build-singlecloud-ui</span>\n      <span class=hljs-attr>retries:</span> <span class=hljs-number>1</span>\n      <span class=hljs-attr>taskRef:</span>\n        <span class=hljs-attr>name:</span> <span class=hljs-string>build-image-from-git</span>\n      <span class=hljs-attr>resources:</span>\n        <span class=hljs-attr>inputs:</span>\n          <span class=hljs-bullet>-</span> <span class=hljs-attr>name:</span> <span class=hljs-string>docker-source</span>\n            <span class=hljs-attr>resource:</span> <span class=hljs-string>singlecloud-ui-repo</span>\n        <span class=hljs-attr>outputs:</span>\n          <span class=hljs-bullet>-</span> <span class=hljs-attr>name:</span> <span class=hljs-string>builtImage</span>\n            <span class=hljs-attr>resource:</span> <span class=hljs-string>singlecloud-ui-image</span>\n    <span class=hljs-bullet>-</span> <span class=hljs-attr>name:</span> <span class=hljs-string>build-singlecloud</span>\n      <span class=hljs-attr>taskRef:</span>\n        <span class=hljs-attr>name:</span> <span class=hljs-string>build-image-from-git</span>\n      <span class=hljs-attr>resources:</span>\n        <span class=hljs-attr>inputs:</span>\n          <span class=hljs-bullet>-</span> <span class=hljs-attr>name:</span> <span class=hljs-string>docker-source</span>\n            <span class=hljs-attr>resource:</span> <span class=hljs-string>singlecloud-repo</span>\n        <span class=hljs-attr>outputs:</span>\n          <span class=hljs-bullet>-</span> <span class=hljs-attr>name:</span> <span class=hljs-string>builtImage</span>\n            <span class=hljs-attr>resource:</span> <span class=hljs-string>singlecloud-image</span>\n    <span class=hljs-bullet>-</span> <span class=hljs-attr>name:</span> <span class=hljs-string>build-zcloud</span>\n      <span class=hljs-attr>taskRef:</span>\n        <span class=hljs-attr>name:</span> <span class=hljs-string>build-zcloud</span>\n      <span class=hljs-attr>resources:</span>\n        <span class=hljs-attr>inputs:</span>\n        <span class=hljs-bullet>-</span> <span class=hljs-attr>name:</span> <span class=hljs-string>docker-source</span>\n          <span class=hljs-attr>resource:</span> <span class=hljs-string>zcloud-repo</span>\n        <span class=hljs-bullet>-</span> <span class=hljs-attr>name:</span> <span class=hljs-string>uiImage</span>\n          <span class=hljs-attr>resource:</span> <span class=hljs-string>singlecloud-ui-image</span>\n          <span class=hljs-attr>from:</span>\n          <span class=hljs-bullet>-</span> <span class=hljs-string>build-singlecloud-ui</span>\n        <span class=hljs-bullet>-</span> <span class=hljs-attr>name:</span> <span class=hljs-string>image</span>\n          <span class=hljs-attr>resource:</span> <span class=hljs-string>singlecloud-image</span>\n          <span class=hljs-attr>from:</span>\n          <span class=hljs-bullet>-</span> <span class=hljs-string>build-singlecloud</span>\n        <span class=hljs-attr>outputs:</span>\n        <span class=hljs-bullet>-</span> <span class=hljs-attr>name:</span> <span class=hljs-string>builtImage</span>\n          <span class=hljs-attr>resource:</span> <span class=hljs-string>zcloud-image</span>\n\n</code></pre><p>\u8fd0\u884cpipelinue:</p> <pre class=hljs><code class=language-yaml>\n<span class=hljs-attr>apiVersion:</span> <span class=hljs-string>tekton.dev/v1alpha1</span>\n<span class=hljs-attr>kind:</span> <span class=hljs-string>PipelineRun</span>\n<span class=hljs-attr>metadata:</span>\n  <span class=hljs-attr>generateName:</span> <span class=hljs-string>zcloud-build-run-</span>\n<span class=hljs-attr>spec:</span>\n  <span class=hljs-attr>pipelineRef:</span>\n    <span class=hljs-attr>name:</span> <span class=hljs-string>zcloud-build-pipeline</span>\n  <span class=hljs-attr>serviceAccount:</span> <span class=hljs-string>pipeline-run-service</span>\n  <span class=hljs-attr>resources:</span>\n  <span class=hljs-bullet>-</span> <span class=hljs-attr>name:</span> <span class=hljs-string>singlecloud-repo</span>\n    <span class=hljs-attr>resourceSpec:</span>\n      <span class=hljs-attr>type:</span> <span class=hljs-string>git</span>\n      <span class=hljs-attr>params:</span>\n      <span class=hljs-bullet>-</span> <span class=hljs-attr>name:</span> <span class=hljs-string>revision</span>\n        <span class=hljs-attr>value:</span> <span class=hljs-string>master</span>\n      <span class=hljs-bullet>-</span> <span class=hljs-attr>name:</span> <span class=hljs-string>url</span>\n        <span class=hljs-attr>value:</span> <span class=hljs-string>https://github.com/zdnscloud/singlecloud</span>\n  <span class=hljs-bullet>-</span> <span class=hljs-attr>name:</span> <span class=hljs-string>singlecloud-ui-repo</span>\n    <span class=hljs-attr>resourceSpec:</span>\n      <span class=hljs-attr>type:</span> <span class=hljs-string>git</span>\n      <span class=hljs-attr>params:</span>\n      <span class=hljs-bullet>-</span> <span class=hljs-attr>name:</span> <span class=hljs-string>revision</span>\n        <span class=hljs-attr>value:</span> <span class=hljs-string>master</span>\n      <span class=hljs-bullet>-</span> <span class=hljs-attr>name:</span> <span class=hljs-string>url</span>\n        <span class=hljs-attr>value:</span> <span class=hljs-string>https://github.com/zdnscloud/singlecloud-ui</span>\n  <span class=hljs-bullet>-</span> <span class=hljs-attr>name:</span> <span class=hljs-string>zcloud-repo</span>\n    <span class=hljs-attr>resourceSpec:</span>\n      <span class=hljs-attr>type:</span> <span class=hljs-string>git</span>\n      <span class=hljs-attr>params:</span>\n      <span class=hljs-bullet>-</span> <span class=hljs-attr>name:</span> <span class=hljs-string>revision</span>\n        <span class=hljs-attr>value:</span> <span class=hljs-string>master</span>\n      <span class=hljs-bullet>-</span> <span class=hljs-attr>name:</span> <span class=hljs-string>url</span>\n        <span class=hljs-attr>value:</span> <span class=hljs-string>https://github.com/gsmlg/zcloud-image</span>\n  <span class=hljs-bullet>-</span> <span class=hljs-attr>name:</span> <span class=hljs-string>singlecloud-image</span>\n    <span class=hljs-attr>resourceSpec:</span>\n      <span class=hljs-attr>type:</span> <span class=hljs-string>image</span>\n      <span class=hljs-attr>params:</span>\n        <span class=hljs-bullet>-</span> <span class=hljs-attr>name:</span> <span class=hljs-string>url</span>\n          <span class=hljs-attr>value:</span> <span class=hljs-string>registry.zdns.cn/zcloud/singlecloud:master</span>\n  <span class=hljs-bullet>-</span> <span class=hljs-attr>name:</span> <span class=hljs-string>singlecloud-ui-image</span>\n    <span class=hljs-attr>resourceSpec:</span>\n      <span class=hljs-attr>type:</span> <span class=hljs-string>image</span>\n      <span class=hljs-attr>params:</span>\n        <span class=hljs-bullet>-</span> <span class=hljs-attr>name:</span> <span class=hljs-string>url</span>\n          <span class=hljs-attr>value:</span> <span class=hljs-string>registry.zdns.cn/zcloud/singlecloud-ui:master</span>\n  <span class=hljs-bullet>-</span> <span class=hljs-attr>name:</span> <span class=hljs-string>zcloud-image</span>\n    <span class=hljs-attr>resourceRef:</span>\n      <span class=hljs-attr>name:</span> <span class=hljs-string>zcloud-image</span>\n</code></pre>'}}]);