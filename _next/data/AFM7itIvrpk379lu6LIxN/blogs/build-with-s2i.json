{"pageProps":{"slug":"build-with-s2i","blog":{"id":33,"name":"build-with-s2i","title":"使用 s2i Build镜像","date":"2019-08-15","author":"Gao","content":"# 使用 `s2i` Build 镜像\n\n## 安装`s2i`\n\n- 使用 `go get`\n\n```shell\n$ go get github.com/openshift/source-to-image/cmd/s2i\n```\n\n- macOS 使用\n\n```shell\n$ brew install source-to-image\n```\n\n- Linux 使用\n\n在[版本发布页面](https://github.com/openshift/source-to-image/releases)找到对应链接下载\n\n```shell\ncurl -sSL https://github.com/openshift/source-to-image/releases/download/v1.1.14/source-to-image-v1.1.14-874754de-linux-amd64.tar.gz | tar zxf - -C /usr/local/bin/ './s2i'\n```\n\n- Windows 使用\n\n在[版本发布页面](https://github.com/openshift/source-to-image/releases)找到对应链接下载\n\n下载\n\n```\nhttps://github.com/openshift/source-to-image/releases/download/v1.1.14/source-to-image-v1.1.14-874754de-windows-amd64.zip\n```\n\n- 源码编译\n\n```shell\n$ go get github.com/openshift/source-to-image\n$ cd ${GOPATH}/src/github.com/openshift/source-to-image\n$ export PATH=$PATH:${GOPATH}/src/github.com/openshift/source-to-image/_output/local/bin/linux/amd64/\n$ hack/build-go.sh\n```\n\n## 使用`s2i`\n\n使用方式为：\n\n```shell\ns2i [source dir] [builder image] [built image name]\n```\n\n可用的 builder 镜像源码可以在 [Software Collection](https://github.com/sclorg) 找到\n\n### 创建镜像 PHP 项目镜像\n\nPHP builder 镜像\n\n- centos/php-72-centos7\n- centos/php-71-centos7\n- centos/php-70-centos7\n- centos/php-56-centos7\n- centos/php-55-centos7\n\n创建 test-app 镜像\n\n```\ns2i build /root/s2i-php-test-app centos/php-72-centos7 my-test-app\n\ndocker run --rm -p 8080:8080 my-test-app\n\n```\n\n#### 配置运行时参数\n\n##### 给镜像配置以下环境变量可以作用于`php.ini`:\n\n- **ERROR_REPORTING**\n  - Informs PHP of which errors, warnings and notices you would like it to take action for\n  - Default: E_ALL & ~E_NOTICE\n- **DISPLAY_ERRORS**\n  - Controls whether or not and where PHP will output errors, notices and warnings\n  - Default: ON\n- **DISPLAY_STARTUP_ERRORS**\n  - Cause display errors which occur during PHP's startup sequence to be handled separately from display errors\n  - Default: OFF\n- **TRACK_ERRORS**\n  - Store the last error/warning message in \\$php_errormsg (boolean)\n  - Default: OFF\n- **HTML_ERRORS**\n  - Link errors to documentation related to the error\n  - Default: ON\n- **INCLUDE_PATH**\n  - Path for PHP source files\n  - Default: .:/opt/app-root/src:/opt/rh/rh-php72/root/usr/share/pear (EL7)\n  - Default: .:/opt/app-root/src:/usr/share/pear (EL8, Fedora)\n- **PHP_MEMORY_LIMIT**\n  - Memory Limit\n  - Default: 128M\n- **SESSION_NAME**\n  - Name of the session\n  - Default: PHPSESSID\n- **SESSION_HANDLER**\n  - Method for saving sessions\n  - Default: files\n- **SESSION_PATH**\n  - Location for session data files\n  - Default: /tmp/sessions\n- **SESSION_COOKIE_DOMAIN**\n  - The domain for which the cookie is valid.\n  - Default:\n- **SESSION_COOKIE_HTTPONLY**\n  - Whether or not to add the httpOnly flag to the cookie\n  - Default: 0\n- **SESSION_COOKIE_SECURE**\n  - Specifies whether cookies should only be sent over secure connections.\n  - Default: Off\n- **SHORT_OPEN_TAG**\n  - Determines whether or not PHP will recognize code between <? and ?> tags\n  - Default: OFF\n- **DOCUMENTROOT**\n  - Path that defines the DocumentRoot for your application (ie. /public)\n  - Default: /\n\n##### 给镜像配置以下环境变量可以作用于`opcache.ini`:\n\n- **OPCACHE_MEMORY_CONSUMPTION**\n  - The OPcache shared memory storage size in megabytes\n  - Default: 128\n- **OPCACHE_REVALIDATE_FREQ**\n  - How often to check script timestamps for updates, in seconds. 0 will result in OPcache checking for updates on every request.\n  - Default: 2\n\n##### 以下配置环境变量作用于 Apache 服务，运行于 Apache [MPM prefork](https://httpd.apache.org/docs/2.4/mod/mpm_common.html) 模式:\n\n- **HTTPD_START_SERVERS**\n  - The [StartServers](https://httpd.apache.org/docs/2.4/mod/mpm_common.html#startservers)\n    directive sets the number of child server processes created on startup.\n  - Default: 8\n- **HTTPD_MAX_REQUEST_WORKERS**\n  - The [MaxRequestWorkers](https://httpd.apache.org/docs/2.4/mod/mpm_common.html#maxrequestworkers)\n    directive sets the limit on the number of simultaneous requests that will be served.\n  - `MaxRequestWorkers` was called `MaxClients` before version httpd 2.3.13.\n  - Default: 256 (this is automatically tuned by setting Cgroup limits for the container using this formula:\n    `TOTAL_MEMORY / 15MB`. The 15MB is average size of a single httpd process.\n\n##### 以下配置环境变量作用于 composer:\n\n- **COMPOSER_MIRROR**\n  - Adds a custom composer repository mirror URL to composer configuration. Note: This only affects packages listed in composer.json.\n- **COMPOSER_INSTALLER**\n  - Overrides the default URL for downloading Composer of https://getcomposer.org/installer. Useful in disconnected environments.\n- **COMPOSER_ARGS**\n  - Adds extra arguments to the `composer install` command line (for example `--no-dev`).\n\n#### 代码目录配置\n\n当以下文件在代码目录中时，会被使用：\n\n- **composer.json**\n\n  List of dependencies to be installed with `composer`. The format is documented\n  [here](https://getcomposer.org/doc/04-schema.md).\n\n* **.htaccess**\n\n  In case the **DocumentRoot** of the application is nested within the source directory `/opt/app-root/src`,\n  users can provide their own Apache **.htaccess** file. This allows the overriding of Apache's behavior and\n  specifies how application requests should be handled. The **.htaccess** file needs to be located at the root\n  of the application source.\n\n* **.s2i/environment**\n\n  也可以用于配置环境变量\n\n### 创建 nodejs 项目镜像\n\n可用 builder 镜像\n\n- centos/nodejs-10-centos7\n- centos/nodejs-8-centos7\n- centos/nodejs-6-centos7\n\n#### 服务启动\n\n默认会调用 `npm start` 来启动服务\n\n当`DEV_MODE=true`时，默认会调用`nodemon <main attribute in package.json>`,来启动服务，如果失败再调用，`npm start` 来启动服务\n\n#### 可配置环境变量\n\n**`NODE_ENV`**\nNodeJS runtime mode (default: \"production\")\n\n**`DEV_MODE`**\nWhen set to \"true\", `nodemon` will be used to automatically reload the server while you work (default: \"false\"). Setting `DEV_MODE` to \"true\" will change the `NODE_ENV` default to \"development\" (if not explicitly set).\n\n**`NPM_RUN`**\nSelect an alternate / custom runtime mode, defined in your `package.json` file's [`scripts`](https://docs.npmjs.com/misc/scripts) section (default: npm run \"start\"). These user-defined run-scripts are unavailable while `DEV_MODE` is in use.\n\n**`HTTP_PROXY`**\nUse an npm proxy during assembly\n\n**`HTTPS_PROXY`**\nUse an npm proxy during assembly\n\n**`NPM_MIRROR`**\nUse a custom NPM registry mirror to download packages during the build process\n\n### 创建 go 项目镜像\n\n可用 builder 镜像\n\n- centos/go-toolset-7-centos7\n\n#### 配置运行时参数\n\n- **IMPORT_URL**\n\n指定应用的导入 URL，如 `github.com/someorg/somerepo`\n\n- **INSTALL_URL**\n\n如果`main.go`不在代码目录下时，指定 build 目录,如 `github.com/someorg/somerepo/somefolder`\n\n### 创建 java 项目镜像\n\n由于 java 项目的多样性，建议进行定制\n"}},"__N_SSG":true}