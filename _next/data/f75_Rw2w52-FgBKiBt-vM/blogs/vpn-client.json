{"pageProps":{"slug":"vpn-client","blog":{"id":24,"slug":"vpn-client","title":"Setup VPN Client in Linux Server","date":"2018-08-17","author":"Gao","content":"# 在 Linux 系统中配置 VPN Client\n\n在没有 X 的 linux 系统中安装启用 VPN\n\n## 安装\n\n```shell\n# Ubuntu & Debian\napt-get update\napt-get -y install strongswan xl2tpd\n\n# CentOS & RHEL\nyum -y install epel-release\nyum --enablerepo=epel -y install strongswan xl2tpd\n\n# Fedora\nyum -y install strongswan xl2tpd\n```\n\n### 配置 VPN 账户\n\n```shell\nVPN_SERVER_IP='你的VPN服务器IP'\nVPN_IPSEC_PSK='你的IPsec预共享密钥'\nVPN_USER='你的VPN用户名'\nVPN_PASSWORD='你的VPN密码'\n```\n\n### 配置 Strongswan\n\n```shell\ncat > /etc/ipsec.conf <<EOF\n# ipsec.conf - strongSwan IPsec configuration file\n\n# basic configuration\n\nconfig setup\n  # strictcrlpolicy=yes\n  # uniqueids = no\n\n# Add connections here.\n\n# Sample VPN connections\n\nconn %default\n  ikelifetime=60m\n  keylife=20m\n  rekeymargin=3m\n  keyingtries=1\n  keyexchange=ikev1\n  authby=secret\n  ike=aes128-sha1-modp1024,3des-sha1-modp1024!\n  esp=aes128-sha1-modp1024,3des-sha1-modp1024!\n\nconn myvpn\n  keyexchange=ikev1\n  left=%defaultroute\n  auto=add\n  authby=secret\n  type=transport\n  leftprotoport=17/1701\n  rightprotoport=17/1701\n  right=$VPN_SERVER_IP\nEOF\n\ncat > /etc/ipsec.secrets <<EOF\n: PSK \"$VPN_IPSEC_PSK\"\nEOF\n\nchmod 600 /etc/ipsec.secrets\n\n# For CentOS/RHEL & Fedora ONLY\nmv /etc/strongswan/ipsec.conf /etc/strongswan/ipsec.conf.old 2>/dev/null\nmv /etc/strongswan/ipsec.secrets /etc/strongswan/ipsec.secrets.old 2>/dev/null\nln -s /etc/ipsec.conf /etc/strongswan/ipsec.conf\nln -s /etc/ipsec.secrets /etc/strongswan/ipsec.secrets\n```\n\n### 配置 xl2tpd\n\n```shell\ncat > /etc/xl2tpd/xl2tpd.conf <<EOF\n[lac myvpn]\nlns = $VPN_SERVER_IP\nppp debug = yes\npppoptfile = /etc/ppp/options.l2tpd.client\nlength bit = yes\nEOF\n\ncat > /etc/ppp/options.l2tpd.client <<EOF\nipcp-accept-local\nipcp-accept-remote\nrefuse-eap\nrequire-chap\nnoccp\nnoauth\nmtu 1280\nmru 1280\nnoipdefault\ndefaultroute\nusepeerdns\nconnect-delay 5000\nname $VPN_USER\npassword $VPN_PASSWORD\nEOF\n\nchmod 600 /etc/ppp/options.l2tpd.client\n```\n\n- 至此 VPN 客户端配置已完成\n\n## 配置连接\n\n### 创建 xl2tpd 控制文件：\n\n```shell\nmkdir -p /var/run/xl2tpd\ntouch /var/run/xl2tpd/l2tp-control\n```\n\n### 重启服务：\n\n````\nservice strongswan restart\nservice xl2tpd restart\n```\n\n### 开始 IPsec 连接：\n\n```shell\n# Ubuntu & Debian\nipsec up myvpn\n\n# CentOS/RHEL & Fedora\nstrongswan up myvpn\n```\n\n### 开始 L2TP 连接：\n\n```shell\necho \"c myvpn\" > /var/run/xl2tpd/l2tp-control\n```\n\n## 配置路由\n\n查看路由\n\n```shell\nip route\n```\n\n创建路由表\n\n```\ngit clone https://github.com/gsmlg/static-routes.git\ncd static-routes\nmake linux\n# mode 1 不需要修改 default route\n\\cp mode1/ip-up /etc/ppp/ip-up.local\n# mode 2 需要配置 default route 到VPN的IP\n\\cp mode1/ip-up /etc/ppp/ip-up.local\n\\cp mode1/ip-down /etc/ppp/ip-down\n\n```\n\n## 断开连接\n\n```\n# Ubuntu & Debian\necho \"d myvpn\" > /var/run/xl2tpd/l2tp-control\nipsec down myvpn\n\n# CentOS/RHEL & Fedora\necho \"d myvpn\" > /var/run/xl2tpd/l2tp-control\nstrongswan down myvpn\n```\n````\n"},"lightCss":"pre code.hljs{display:block;overflow-x:auto;padding:1em}code.hljs{padding:3px 5px}.hljs{color:#383a42;background:#fafafa}.hljs-comment,.hljs-quote{color:#a0a1a7;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#a626a4}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e45649}.hljs-literal{color:#0184bb}.hljs-addition,.hljs-attribute,.hljs-meta .hljs-string,.hljs-regexp,.hljs-string{color:#50a14f}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#986801}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#4078f2}.hljs-built_in,.hljs-class .hljs-title,.hljs-title.class_{color:#c18401}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}","darkCss":"pre code.hljs{display:block;overflow-x:auto;padding:1em}code.hljs{padding:3px 5px}.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta .hljs-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-built_in,.hljs-class .hljs-title,.hljs-title.class_{color:#e6c07b}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}"},"__N_SSG":true}