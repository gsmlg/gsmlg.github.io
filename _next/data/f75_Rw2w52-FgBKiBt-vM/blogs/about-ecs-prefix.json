{"pageProps":{"slug":"about-ecs-prefix","blog":{"id":49,"slug":"about-ecs-prefix","title":"ECS递归与权威的prefix","date":"2020-11-03","author":"Gao","content":"### 起因\n\n今天在搭建一个递归服务器, 想要测试一下递归结果, 根据 ECS 来判断相关的递归服务器\n结果\n\n结果在进行递归查询的时候, 发现一个问题, 递归携带了 subnet, 查询后再更换 subnet,\n递归直接读取了缓存, 而不是带着新的 subnet 去递归.\n\n### 排查\n\n为了对比这个问题,使用了不同的域名来进行递归,发现一个问题,两个域名在递归服务器有\n不同的结果. 域名 z.gsmiot.com 在第一次递归后会一直缓存, aws.amazon.com 域名会根\n据子网变换每次都会递归.\n\n我对比里查询的结果, 发现了一个区别:\n\nz.gsmiot.com\n\n```text\n[root@10-9-104-141 unbound]#  dig z.gsmiot.com @127.0.0.1 +subnet=178.24.161.99/16\n\n; <<>> DiG 9.11.4-P2-RedHat-9.11.4-16.P2.el7_8.6 <<>> z.gsmiot.com @127.0.0.1 +subnet=178.24.161.99/16\n;; global options: +cmd\n;; Got answer:\n;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 36175\n;; flags: qr rd ra; QUERY: 1, ANSWER: 1, AUTHORITY: 0, ADDITIONAL: 1\n\n;; OPT PSEUDOSECTION:\n; EDNS: version: 0, flags:; udp: 1232\n; CLIENT-SUBNET: 178.24.0.0/16/0\n;; QUESTION SECTION:\n;z.gsmiot.com.\t\t\tIN\tA\n\n;; ANSWER SECTION:\nz.gsmiot.com.\t\t3600\tIN\tA\t8.8.8.8\n\n;; Query time: 994 msec\n;; SERVER: 127.0.0.1#53(127.0.0.1)\n;; WHEN: Tue Nov 03 11:03:27 CST 2020\n;; MSG SIZE  rcvd: 67\n```\n\naws.amazon.com\n\n```text\n[root@10-9-104-141 unbound]# dig aws.amazon.com @127.0.0.1 +subnet=178.24.161.99/16\n\n; <<>> DiG 9.11.4-P2-RedHat-9.11.4-16.P2.el7_8.6 <<>> aws.amazon.com @127.0.0.1 +subnet=178.24.161.99/16\n;; global options: +cmd\n;; Got answer:\n;; ->>HEADER<<- opcode: QUERY, status: NOERROR, id: 2145\n;; flags: qr rd ra; QUERY: 1, ANSWER: 3, AUTHORITY: 0, ADDITIONAL: 1\n\n;; OPT PSEUDOSECTION:\n; EDNS: version: 0, flags:; udp: 1232\n; CLIENT-SUBNET: 178.24.0.0/16/24\n;; QUESTION SECTION:\n;aws.amazon.com.\t\t\tIN\tA\n\n;; ANSWER SECTION:\naws.amazon.com.\t\t300\tIN\tCNAME\ttp.8e49140c2-frontier.amazon.com.\ntp.8e49140c2-frontier.amazon.com. 300 IN CNAME\tdr49lng3n1n2s.cloudfront.net.\ndr49lng3n1n2s.cloudfront.net. 300 IN\tA\t54.230.150.74\n\n;; Query time: 420 msec\n;; SERVER: 127.0.0.1#53(127.0.0.1)\n;; WHEN: Tue Nov 03 11:03:53 CST 2020\n;; MSG SIZE  rcvd: 147\n```\n\n对比发现了响应的结果有区别, 在`OPT PSEUDOSECTION`这个部分,有一个地方有区别:\n\n```text\nAWS 权威\n; CLIENT-SUBNET: 178.24.0.0/16/24\nZDNS 权威\n; CLIENT-SUBNET: 178.24.0.0/16/0\n```\n\n又测试了 subnet 生效的 aws 域名, 递归会根据发现子网这个地\n址`178.24.0.0/[A]/[B]`中的 A 和 B 两个 prefix 来做判断, 如果携带的 A 范围较大,\n就是用 A, 而 B 范围较大, 就使用 B. 现在猜测这里的 B 可能是由权威返回的.\n\n查询了一下相关文档\n[RFC7871 Client Subnet in DNS Queries](https://tools.ietf.org/html/rfc7871#section-7.2.1)\n\n其中在 7.2.1 节中内容:\n\n```text\n7.2.1.  Authoritative Nameserver\n\n   When a query containing an ECS option is received, an Authoritative\n   Nameserver supporting ECS MAY use the address information specified\n   in the option to generate a tailored response.\n\n   Authoritative Nameservers that have not implemented or enabled\n   support for the ECS option ought to safely ignore it within incoming\n   queries, per [RFC6891], Section 6.1.2.  Such a server MUST NOT\n   include an ECS option within replies to indicate lack of support for\n   it.  Implementers of Intermediate Nameservers should be aware,\n   however, that some nameservers incorrectly echo back unknown EDNS0\n   options.  In this protocol, that should be mostly harmless, as the\n   SCOPE PREFIX-LENGTH should come back as 0, thus marking the response\n   as covering all networks.\n\n   A query with a wrongly formatted option (e.g., an unknown FAMILY)\n   MUST be rejected and a FORMERR response MUST be returned to the\n   sender, as described in [RFC6891], \"Transport Considerations\".\n```\n\n其中一段\n`In this protocol, that should be mostly harmless, as the SCOPE PREFIX-LENGTH should come back as 0, thus marking the response as covering all networks.`\n这里`SCOPE PREFIX-LENGTH`如果为 0 的话, 响应就会应用到所有网络. 目前猜测 ZDNS 的\n权威可能属于这个问题的范围.\n\n查询了一下文档, 找到了 IETF 上有一个相关文档\n[A Look at the ECS Behavior of DNS Resolvers](https://www.ietf.org/proceedings/106/slides/slides-106-maprg-a-look-at-the-ecs-behavior-of-dns-resolvers-kyle-schomp-01)\n\n有如下一段内容:\n\n```text\nECS Purpose\n• Enable CDN server selection by ADNS based on client subnet\n• ECS Option in DNS queries from resolvers to ADNS includes\n• Client IP address prefix\n• Source prefix length\n• ECS Option in DNS responses from ADNS to resolvers includes\n• Scope prefix length\n```\n\n现在可以推断极大概率是因为这个 scop prefix length 的问题了\n\n### 验证\n\n使用 tcpudump 抓包两次递归服务的递归结果\n\n```shell\ntcpdump -i eth0 port 53 -w zcloud.cap\ntcpdump -i eth0 port 53 -w aws.cap\n```\n\n在 wireshark 中打开看到结果\n\n在响应结果的记录中\n\n- 打开 Domain Name System (response)\n- 打开 Addional records\n- 打开<Root>: type OPT\n- 打开<Option: CSUBNET - Client subnet\n\n对比看到 Scope Netmask 有区别, aws 返回为 24, zdns 返回为 0\n\n问题确认, 是由于权威返回结果的问题导致的\n"},"lightCss":"pre code.hljs{display:block;overflow-x:auto;padding:1em}code.hljs{padding:3px 5px}.hljs{color:#383a42;background:#fafafa}.hljs-comment,.hljs-quote{color:#a0a1a7;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#a626a4}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e45649}.hljs-literal{color:#0184bb}.hljs-addition,.hljs-attribute,.hljs-meta .hljs-string,.hljs-regexp,.hljs-string{color:#50a14f}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#986801}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#4078f2}.hljs-built_in,.hljs-class .hljs-title,.hljs-title.class_{color:#c18401}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}","darkCss":"pre code.hljs{display:block;overflow-x:auto;padding:1em}code.hljs{padding:3px 5px}.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta .hljs-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-built_in,.hljs-class .hljs-title,.hljs-title.class_{color:#e6c07b}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}"},"__N_SSG":true}