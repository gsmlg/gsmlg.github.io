{"pageProps":{"slug":"use-couchdb-cluster","blog":{"id":79,"slug":"use-couchdb-cluster","title":"使用couchdb和配置集群","date":"2022-11-16","author":"Gao","content":"### 配置docker.ini\n\n```ini\n\n[admins]\nadmin = <encrypted password>\n\n[chttpd]\nbind_address = 0.0.0.0\nport = 5984\n\n[cluster]\nn = 3\n\n```\n\n\n### 启动配置, 创建默认数据库\n\n```bash\ncurl -u user:pass -XPUT localhost:5984/_users\ncurl -u user:pass -XPUT localhost:5984/_replicator\ncurl -u user:pass -XPUT localhost:5984/_global_changes\n```\n\n### 集群配置\n\n```bash\ncluster_setup() {\n  curl -X POST -u user:pass -H 'content-type: application/json' \"http://${1}:5984/_cluster_setup\" -d \"$2\"\n}\n\n\ncluster_setup 10.100.1.10 '{\"action\": \"enable_cluster\", \"bind_address\":\"0.0.0.0\", \"username\": \"cluster\", \"password\":\"connect\", \"port\": 5984, \"node_count\": \"3\", \"remote_node\": \"10.100.1.10:5984\", \"remote_current_user\": \"cluster\", \"remote_current_password\": \"connect\" }'\ncluster_setup 10.100.1.10 '{\"action\": \"add_node\", \"host\":\"10.100.21.10\", \"port\": 5984, \"username\": \"cluster\", \"password\":\"connect\"}'\n\n\ncluster_setup 10.100.21.10 '{\"action\": \"enable_cluster\", \"bind_address\":\"0.0.0.0\", \"username\": \"cluster\", \"password\":\"connect\", \"port\": 5984, \"node_count\": \"3\", \"remote_node\": \"10.100.21.10:5984\", \"remote_current_user\": \"cluster\", \"remote_current_password\": \"connect\" }'\ncluster_setup 10.100.21.10 '{\"action\": \"add_node\", \"host\":\"10.100.1.10\", \"port\": 5984, \"username\": \"cluster\", \"password\":\"connect\"}'\n\n\ncluster_setup 10.100.1.10 '{\"action\": \"finish_cluster\"}'\ncluster_setup 10.100.21.10 '{\"action\": \"finish_cluster\"}'\n\n```\n\n\n### 检查状态\n\n```bash\n## 检查安装\ncurl http://admin:password@<setup-coordination-node>:5984/_cluster_setup\n## 检查成员\ncurl -s -u user:pass localhost:5984/_membership\n```\n\n### 删除节点\n\n```bash\n## 查看节点信息\ncurl -s -u couch:potato 10.100.21.10:5984/_node/_local/_nodes/couchdb@docker.gsmlg.net |jq\n## 删除节点\ncurl -XDELETE -s -u couch:potato \"http://10.100.21.10:5984/_node/_local/_nodes/couchdb@docker.gsmlg.net?rev=1-967a00dff5e02add41819138abb3284d\"\n```\n\n\n# Test Performance of CouchDB\n\n测试CouchDB写入性能, 数据为JSON文档, CouchDB文档限制最大为8MB\n\n```bash\n#!/bin/bash\n\nNUM=10000\n\nCONCURRENT=1000\n\nTARGET=\"127.0.0.1:5984\"\n\nDATA=$(cat <<EOF\n{\n  \"name\": \"Couch DB Test Document\"\n}\nEOF\n)\n\ngsmlg-cli httpbenchmark \\\n\t-c ${CONCURRENT} \\\n\t-n ${NUM} \\\n\t-m POST \\\n\t--header \"Authorization:Basic <user pass encrypted>\" \\\n\t-T 'application/json' \\\n\t--body=\"$DATA\" \\\n\t\"http://${TARGET}/perf\"\n\n\n```\n\n\n"},"lightCss":"pre code.hljs{display:block;overflow-x:auto;padding:1em}code.hljs{padding:3px 5px}.hljs{color:#383a42;background:#fafafa}.hljs-comment,.hljs-quote{color:#a0a1a7;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#a626a4}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e45649}.hljs-literal{color:#0184bb}.hljs-addition,.hljs-attribute,.hljs-meta .hljs-string,.hljs-regexp,.hljs-string{color:#50a14f}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#986801}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#4078f2}.hljs-built_in,.hljs-class .hljs-title,.hljs-title.class_{color:#c18401}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}","darkCss":"pre code.hljs{display:block;overflow-x:auto;padding:1em}code.hljs{padding:3px 5px}.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta .hljs-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-built_in,.hljs-class .hljs-title,.hljs-title.class_{color:#e6c07b}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}"},"__N_SSG":true}