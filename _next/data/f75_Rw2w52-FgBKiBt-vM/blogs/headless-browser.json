{"pageProps":{"slug":"headless-browser","blog":{"id":10,"slug":"headless-browser","title":"无界面浏览器 - Firefox, Chrome","date":"2017-11-30","author":"Gao","content":"# 概述\n\n无界面浏览器 <`headdless mode`> 在进行自动化测试和服务器上运行时非常有用。\n\n在服务器上，可能需要运行浏览器去执行一些特殊的任务，但是服务器上是没有 X Window\n系统，这个时候就需要使用无界面浏览器了。\n\n无界面浏览器可以去打开一些真正的页面，并且渲染，然后输出到 html，pdf 或图片。\n\n无界面浏览器还可以打开调试端口，在没有图形界面的情况下，调试真正的浏览器页面。\n\n## Chrome\n\nChrome 从版本 59 开始，提供了无界面浏览功能，使用方式如下:\n\n```shell\nchrome \\\n  --headless \\                   # Runs Chrome in headless mode.\n  --disable-gpu \\                # Temporarily needed for now.\n  --remote-debugging-port=9222 \\\n  https://www.chromestatus.com   # URL to open. Defaults to about:blank.\n```\n\n- chrome 命令设置：\n\n```shell\nalias chrome=\"/Applications/Google\\ Chrome.app/Contents/MacOS/Google\\ Chrome\"\nalias chrome-canary=\"/Applications/Google\\ Chrome\\ Canary.app/Contents/MacOS/Google\\ Chrome\\ Canary\"\nalias chromium=\"/Applications/Chromium.app/Contents/MacOS/Chromium\"\n```\n\nChrome headless mode 提供了很多强大功能：\n\n- 输出 DOM 结构\n\n`--dump-dom` flag 会输出`document.body.innerHTML`\n\n```shell\nchrome --headless --disable-gpu --dump-dom https://www.chromestatus.com/\n```\n\n- 输出 PDF\n\n```shell\nchrome --headless --disable-gpu --print-to-pdf https://www.chromestatus.com/\n```\n\n- 输出截图\n\n```shell\nchrome --headless --disable-gpu --screenshot https://www.chromestatus.com/\n\n# Size of a standard letterhead.\nchrome --headless --disable-gpu --screenshot --window-size=1280,1696 https://www.chromestatus.com/\n\n# Nexus 5x\nchrome --headless --disable-gpu --screenshot --window-size=412,732 https://www.chromestatus.com/\n```\n\n- REPL\n\n`--repl` 会打开一个 JS Console\n\n```shell\n$ chrome --headless --disable-gpu --repl https://www.chromestatus.com/\n[0608/112805.245285:INFO:headless_shell.cc(278)] Type a Javascript expression to evaluate or \"quit\" to exit.\n>>> location.href\n{\"result\":{\"type\":\"string\",\"value\":\"https://www.chromestatus.com/features\"}}\n>>> quit\n$\n```\n\n- 远程调试\n\n`--remote-debugging-port=9222` 会打开调试端口，调试基于`DevTools protocol`协议可\n以通过编辑器连接，来进行远程调试。\n\n### Node 编程接口\n\n**The Puppeteer API**\n\nPuppeteer is a Node library developed by the Chrome team. It provides a\nhigh-level API to control headless (or full) Chrome. It's similar to other\nautomated testing libraries like Phantom and NightmareJS, but it only works with\nthe latest versions of Chrome.\n\nAmong other things, Puppeteer can be used to easily take screenshots, create\nPDFs, navigate pages, and fetch information about those pages. I recommend the\nlibrary if you want to quickly automate browser testing. It hides away the\ncomplexities of the DevTools protocol and takes care of redundant tasks like\nlaunching a debug instance of Chrome.\n\nInstall it:\n\n```shell\nyarn add puppeteer\n```\n\nExample - print the user agent\n\n```js\nconst puppeteer = require('puppeteer');\n\n(async () => {\n  const browser = await puppeteer.launch();\n  console.log(await browser.version());\n  browser.close();\n})();\n```\n\nExample - taking a screenshot of the page\n\n```js\nconst puppeteer = require('puppeteer');\n\n(async () => {\n  const browser = await puppeteer.launch();\n  const page = await browser.newPage();\n  await page.goto('https://www.chromestatus.com', {waitUntil: 'networkidle'});\n  await page.pdf({path: 'page.pdf', format: 'A4'});\n\n  browser.close();\n})();\n```\n\nCheck out\n[Puppeteer's documentation](https://github.com/GoogleChrome/puppeteer/blob/master/docs/api.md)\nto learn more about the full API.\n\n## Firefox\n\nHeadless Firefox works on Fx55+ on Linux, and 56+ on Windows/Mac.\n\n从 Firefox 57 开始，Firefox 开始支持截图\n\n```\n/path/to/firefox -headless -screenshot https://developer.mozilla.com\n```\n\n- `-screenshot` name url — Set a custom name for the screenshot by including it\n  between the -screenshot flag and the URL you want to capture. Note that you\n  can specify other web-compatible image formats such as .jpg, .bmp, etc.\n- `--window-size=x` — Set a custom viewport width when taking the screenshot\n  (full height is maintained). Note that the single argument version of this\n  doesn't work.\n- `--window-size=x,y` — Set a custom viewport width and height to capture.\n\nFirefox headless 模式可以用于自动化测试，基于`Selenium`。\n\nMDN 的[`headless-example`](https://github.com/mdn/headless-examples)\n"},"lightCss":"pre code.hljs{display:block;overflow-x:auto;padding:1em}code.hljs{padding:3px 5px}.hljs{color:#383a42;background:#fafafa}.hljs-comment,.hljs-quote{color:#a0a1a7;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#a626a4}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e45649}.hljs-literal{color:#0184bb}.hljs-addition,.hljs-attribute,.hljs-meta .hljs-string,.hljs-regexp,.hljs-string{color:#50a14f}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#986801}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#4078f2}.hljs-built_in,.hljs-class .hljs-title,.hljs-title.class_{color:#c18401}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}","darkCss":"pre code.hljs{display:block;overflow-x:auto;padding:1em}code.hljs{padding:3px 5px}.hljs{color:#abb2bf;background:#282c34}.hljs-comment,.hljs-quote{color:#5c6370;font-style:italic}.hljs-doctag,.hljs-formula,.hljs-keyword{color:#c678dd}.hljs-deletion,.hljs-name,.hljs-section,.hljs-selector-tag,.hljs-subst{color:#e06c75}.hljs-literal{color:#56b6c2}.hljs-addition,.hljs-attribute,.hljs-meta .hljs-string,.hljs-regexp,.hljs-string{color:#98c379}.hljs-attr,.hljs-number,.hljs-selector-attr,.hljs-selector-class,.hljs-selector-pseudo,.hljs-template-variable,.hljs-type,.hljs-variable{color:#d19a66}.hljs-bullet,.hljs-link,.hljs-meta,.hljs-selector-id,.hljs-symbol,.hljs-title{color:#61aeee}.hljs-built_in,.hljs-class .hljs-title,.hljs-title.class_{color:#e6c07b}.hljs-emphasis{font-style:italic}.hljs-strong{font-weight:700}.hljs-link{text-decoration:underline}"},"__N_SSG":true}