{"pageProps":{"slug":"error-421","blog":{"id":7,"name":"error-421","title":"由HTTP STATUS CODE 421导致的错误","date":"2017-07-07","author":"Gao","content":"### 问题出现\n\n开发反馈错误时间过长\n\n发现所有错误请求都被发送了两次，情况是\n\n- 浏览器中发现只有一次请求\n\n- 服务器上发现有两条请求日志\n\n### 排查过程\n\n首先为乐确认问题是在 nginx 转发时发生的，还是由浏览器发送的\n\n只能使用抓包的方式进行排查，重新修改了服务器，关闭了 https\n\n使用 wireshark 进行抓包\n\n```wireshark\nip == 10.1.108.31 && ip.port = 80 && http\n```\n\n检查发现是由浏览器发送了两次请求\n\n分别使用了不同浏览器测试：\n\n- Firefox 两次\n- Chrome 两次\n- Safari 正常\n- IE 正常\n\n检查了请求和响应\n\n查看 chrome 网络 waterfall\n\n![](error-421/time.png)\n\n查看发现，时间显示 stalled 时有一次请求\n\n之后 walting 时间段是重试的请求\n\n测试了是否是 keepalive 的原因，`nginx.conf`设置：\n\n```nginx\nkeepalive_timeoute 0;\n```\n\n排除原因\n\n使用了[`echo`](https://github.com/gsmlg/echo)服务进行测试\n\n通过测试发现，当服务器响应 421 时，浏览器会复制请求并再次请求服务器\n\n### 原因\n\n查看了 `http status code 421` 说明\n\n      421 Misdirected Request （RFC 7540）\n        该请求针对的是无法产生响应的服务器（例如因为连接重用）。\n\nRFC 7540 Hypertext Transfer Protocol Version 2 (HTTP/2)\n[链接](https://tools.ietf.org/html/rfc7540)\n\n指定说明[Section](https://tools.ietf.org/html/rfc7540#section-9.1.2)\n\n      9.1.2.  The 421 (Misdirected Request) Status Code\n\n      The 421 (Misdirected Request) status code indicates that the request\n      was directed at a server that is not able to produce a response.\n      This can be sent by a server that is not configured to produce\n      responses for the combination of scheme and authority that are\n      included in the request URI.\n\n      Clients receiving a 421 (Misdirected Request) response from a server\n      MAY retry the request -- whether the request method is idempotent or\n      not -- over a different connection.  This is possible if a connection\n      is reused (Section 9.1.1) or if an alternative service is selected\n      [ALT-SVC].\n\n      This status code MUST NOT be generated by proxies.\n\n      A 421 response is cacheable by default, i.e., unless otherwise\n      indicated by the method definition or explicit cache controls (see\n      Section 4.2.2 of [RFC7234]).\n\n#### 确定原因\n\nhttp2 中定义了 421 错误\n\n##### 421 错误用于在 http2 中，在 http2 复用连接时，发现连接到的服务器不正确，则会由服务器返回响应码 421，客户端收到后会重新建立连接并且发送相同的请求\n\n### 解决方式\n\n使用通用的错误响应码`403`即可解决问题\n"}},"__N_SSG":true}