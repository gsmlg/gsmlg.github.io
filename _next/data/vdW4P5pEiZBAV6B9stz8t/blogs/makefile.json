{"pageProps":{"slug":"makefile","blog":{"id":17,"name":"makefile","title":"Makefile使用","date":"2018-05-16","author":"Gao","content":"## 为什么使用 make\n\n在项目中部署使用了 makefile 配置,来方便快速的执行一些工作流\n\n相比于其它 task runner，make 的优势是不需要安装，所有系统当前都已经预置\n\n方便，是最大的原因\n\n目前使用的 makefile 如下：\n\n```makefile\nGREEN=\\033[0;32m\nNC=\\033[0m\nINSTALL_DIR=/usr/local/public\nPUBLIC=./public\nHOST=10.1.101.60\nTARFILE=assets.tar.bz2\nHASHFILE=assets.hash.txt\n\n.ONESHELL:\n\ndefault:\n\t@cat ReadMe\n\nzddi:\n\t@rm -rf public/assets/*\n\t@./yarn run build\n\nwatch:\n\t@./yarn watch\n\nbuild-system:\n\t@./yarn --offline\n\nrebuild-system:\n\t@./yarn cache clean\n\t@rm -rf node_modules\n\t@rm -f yarn.lock\n\t@./yarn\n\ntar:\n\t@cd ${PUBLIC} ;\\\n\ttar jcf ${TARFILE} assets\n\nrmtar:\n\t@cd ${PUBLIC} ;\\\n\trm ${TARFILE}\n\ncommit: tar\n\t@-cd ${PUBLIC} ;\\\n\tSHASUM=$(shell shasum ${PUBLIC}/${TARFILE} | awk '{print $$1}') ;\\\n\techo $${SHASUM} > ${HASHFILE} ;\\\n\tgit add ${HASHFILE} ;\\\n\tgit commit -nm \"create checksum commit HASH: [$${SHASUM}]\" ;\n\nupload: commit\n\t@cd ${PUBLIC} ;\\\n\tSHASUM=$(shell shasum ${PUBLIC}/${TARFILE} | awk '{print $$1}') ;\\\n\tCOMMIT=$(shell git log -1 --pretty=format:%H) ;\\\n\tBRANCH=$(shell git rev-parse --abbrev-ref HEAD) ;\\\n\tcurl -X POST http://${HOST}/api/web_build/upload \\\n -F hash=$${SHASUM} \\\n -F user=$(shell git config --get user.name) \\\n -F commit=$${COMMIT} \\\n -F branch=$${BRANCH} \\\n -F assets=@./${TARFILE}\n\npush: zddi upload rmtar\n\ndownload:\n\t@cd ${PUBLIC} ;\\\n\tcurl http://${HOST}/api/web_build/$(shell cat ${PUBLIC}/${HASHFILE}) > ${TARFILE}\n\ninstall: download\n\t@rm -rf ${PUBLIC}/assets\n\t@cd ${PUBLIC} ;\\\n\ttar jxf ${TARFILE}\n\t@rm -rf ${INSTALL_DIR}\n\t@cp -r ${PUBLIC} /usr/local/\n\t@rm -rf ${PUBLIC}/assets\n\t@rm ${PUBLIC}/${TARFILE}\n\t@rm /usr/local/${PUBLIC}/${TARFILE}\n\t@echo -e \"Install public folder to ${GREEN}${INSTALL_DIR}${NC}\"\n\npull: download\n\t@rm -rf ${PUBLIC}/assets\n\t@cd ${PUBLIC} ;\\\n\ttar jxf ${TARFILE}\n\t@rm ${PUBLIC}/${TARFILE}\n\t@echo -e \"${GREEN}Code pull from remote done!${NC}\"\n\n\n```\n\n### 定义变量\n\nmakefile 中的变量定义和 shell 中一样，都可以直接使用\n\n```\nabc = 123\nbcd += ddd\ncc := f2\n```\n\n#### shel 中的变量\n\n由于 makefile 中的变量和 shell 格式一样，所以当要使用 shell 变量时，\n会需要使用转义序列来处理，方式是两个`$`符号\n\n### shell\n\nmakefile 中的 shell 使用需要注意，每一行都会启动一个 shell，单独运行\n当调用 shell 进行插值的时候，shell 的执行顺序也不是顺序执行的\n\n由于都是使用单独的 shell，所以当想要使用相同的上下文时，\n可以使用`.ONESHELL`指令设置，或者是转义换行符\n\n### 连续的 task\n\n由于 makefile 中 shell 无法连续执行，所以，将 task 拆分成多个，然后通过 task 依赖关系顺序执行\n\ntask 依赖，在 task 后输入其它的 task 名称，就会按照顺序，连续执行这些 task\n\n当出现错误，task 队列会中断，这时需要在 shell 开始的行添加一个`-`来继续执行 task\n"}},"__N_SSG":true}